<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√¨m C√¢y XƒÉng G·∫ßn ƒê√¢y</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .sidebar h1 {
            color: #667eea;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-location {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-bottom: 15px;
        }

        .station-list {
            margin-top: 20px;
        }

        .station-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .station-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .station-item h3 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .station-item p {
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .station-item .distance {
            color: #764ba2;
            font-weight: bold;
            font-size: 12px;
        }

        .map-container {
            flex: 1;
            position: relative;
            background: #e0e0e0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .filter-section h3 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group input {
            margin-right: 8px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 13px;
            color: #555;
        }

        .no-results {
            text-align: center;
            color: #999;
            padding: 20px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }

        .info-panel p {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .info-panel strong {
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }

            .map-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>‚õΩ T√¨m C√¢y XƒÉng</h1>
            
            <!-- Info Panel -->
            <div class="info-panel">
                <p><strong>V·ªã tr√≠ hi·ªán t·∫°i:</strong> <span id="currentLocation">Ch∆∞a x√°c ƒë·ªãnh</span></p>
                <p><strong>C√¢y xƒÉng g·∫ßn nh·∫•t:</strong> <span id="nearestStation">-</span></p>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm c√¢y xƒÉng, ƒë·ªãa ch·ªâ...">
            </div>

            <!-- Buttons -->
            <button class="btn btn-location" onclick="getUserLocation()">üìç V·ªã Tr√≠ Hi·ªán T·∫°i</button>
            <button class="btn" onclick="findNearbyStations()">üîç T√¨m G·∫ßn ƒê√¢y</button>

            <!-- Filter -->
            <div class="filter-section">
                <h3>Lo·∫°i XƒÉng</h3>
                <div class="filter-options">
                    <div class="checkbox-group">
                        <input type="checkbox" id="filterRON92" checked onchange="findNearbyStations()">
                        <label for="filterRON92">RON 92</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="filterRON95" checked onchange="findNearbyStations()">
                        <label for="filterRON95">RON 95</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="filterDiesel" checked onchange="findNearbyStations()">
                        <label for="filterDiesel">Diesel</label>
                    </div>
                </div>
            </div>

            <!-- Station List -->
            <div class="station-list">
                <div id="stationContainer"></div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map = null;

        // D·ªØ li·ªáu c√¢y xƒÉng m·∫´u
        const gasStations = [
            {
                name: 'C√¢y XƒÉng Petrolimex H√† N·ªôi 1',
                address: '123 ƒê∆∞·ªùng L√™ L·ª£i, Qu·∫≠n Ho√†n Ki·∫øm, H√† N·ªôi',
                lat: 21.0270,
                lng: 105.8540,
                types: ['RON92', 'RON95', 'Diesel'],
                phone: '024 3945 1234',
                workingHours: '24/7'
            },
            {
                name: 'C√¢y XƒÉng Shell H√† N·ªôi',
                address: '456 ƒê∆∞·ªùng Nguy·ªÖn Tr√£i, Qu·∫≠n Thanh Xu√¢n, H√† N·ªôi',
                lat: 21.0100,
                lng: 105.8700,
                types: ['RON92', 'RON95'],
                phone: '024 3556 7890',
                workingHours: '6:00 - 22:00'
            },
            {
                name: 'C√¢y XƒÉng BSR H√† N·ªôi',
                address: '789 ƒê∆∞·ªùng Th√°i H√†, Qu·∫≠n ƒê·ªëng ƒêa, H√† N·ªôi',
                lat: 21.0150,
                lng: 105.8350,
                types: ['RON95', 'Diesel'],
                phone: '024 3556 1111',
                workingHours: '24/7'
            },
            {
                name: 'C√¢y XƒÉng Petrolimex H√† N·ªôi 2',
                address: '321 ƒê∆∞·ªùng V√µ Ch√≠ C√¥ng, Qu·∫≠n C·∫ßu Gi·∫•y, H√† N·ªôi',
                lat: 21.0500,
                lng: 105.7900,
                types: ['RON92', 'RON95', 'Diesel'],
                phone: '024 3567 2222',
                workingHours: '24/7'
            },
            {
                name: 'C√¢y XƒÉng Esso H√† N·ªôi',
                address: '654 ƒê∆∞·ªùng Ho√†ng Qu·ªëc Vi·ªát, Qu·∫≠n C·∫ßu Gi·∫•y, H√† N·ªôi',
                lat: 21.0450,
                lng: 105.8000,
                types: ['RON92', 'RON95'],
                phone: '024 3761 3333',
                workingHours: '6:00 - 23:00'
            }
        ];

        let userLocation = null;
        let markers = {};

        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
        function initMap() {
            if (map) return; // N·∫øu ƒë√£ kh·ªüi t·∫°o r·ªìi th√¨ kh√¥ng kh·ªüi t·∫°o l·∫°i
            
            map = L.map('map', {
                center: [21.0285, 105.8542],
                zoom: 13
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            setTimeout(function() {
                map.invalidateSize();
            }, 100);
        }

        // H√†m t√≠nh kho·∫£ng c√°ch (Haversine formula)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
        function getUserLocation() {
            const container = document.getElementById('stationContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>ƒêang l·∫•y v·ªã tr√≠...</p></div>';

            if (!map) initMap();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        document.getElementById('currentLocation').textContent = 
                            `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}`;
                        map.setView([userLocation.lat, userLocation.lng], 15);
                        
                        // Th√™m marker cho v·ªã tr√≠ ng∆∞·ªùi d√πng
                        if (markers.user) map.removeLayer(markers.user);
                        markers.user = L.circleMarker([userLocation.lat, userLocation.lng], {
                            radius: 8,
                            fillColor: '#f5576c',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map).bindPopup('üìç V·ªã tr√≠ hi·ªán t·∫°i');
                        
                        findNearbyStations();
                    },
                    function(error) {
                        alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + error.message);
                        container.innerHTML = '<div class="no-results">L·ªói l·∫•y v·ªã tr√≠. Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.</div>';
                    }
                );
            } else {
                alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation');
            }
        }

        // T√¨m c√¢y xƒÉng g·∫ßn ƒë√¢y
        function findNearbyStations() {
            if (!map) initMap();

            const container = document.getElementById('stationContainer');
            
            if (!userLocation) {
                container.innerHTML = '<div class="no-results">Vui l√≤ng b·∫≠t v·ªã tr√≠ tr∆∞·ªõc</div>';
                return;
            }

            const filterRON92 = document.getElementById('filterRON92').checked;
            const filterRON95 = document.getElementById('filterRON95').checked;
            const filterDiesel = document.getElementById('filterDiesel').checked;

            let filteredStations = gasStations.filter(station => {
                return (filterRON92 && station.types.includes('RON92')) ||
                       (filterRON95 && station.types.includes('RON95')) ||
                       (filterDiesel && station.types.includes('Diesel'));
            });

            // T√≠nh kho·∫£ng c√°ch
            filteredStations = filteredStations.map(station => ({
                ...station,
                distance: calculateDistance(userLocation.lat, userLocation.lng, station.lat, station.lng)
            })).sort((a, b) => a.distance - b.distance);

            // X√≥a markers c≈©
            Object.keys(markers).forEach(key => {
                if (key !== 'user') {
                    map.removeLayer(markers[key]);
                    delete markers[key];
                }
            });

            if (filteredStations.length === 0) {
                container.innerHTML = '<div class="no-results">Kh√¥ng t√¨m th·∫•y c√¢y xƒÉng ph√π h·ª£p</div>';
                return;
            }

            // C·∫≠p nh·∫≠t c√¢y xƒÉng g·∫ßn nh·∫•t
            document.getElementById('nearestStation').textContent = 
                `${filteredStations[0].name} (${filteredStations[0].distance.toFixed(2)} km)`;

            // Hi·ªÉn th·ªã danh s√°ch
            let html = '';
            filteredStations.forEach((station, index) => {
                html += `
                    <div class="station-item" onclick="focusStation(${station.lat}, ${station.lng}, '${station.name}')">
                        <h3>${index + 1}. ${station.name}</h3>
                        <p>üìç ${station.address}</p>
                        <p>üìû ${station.phone}</p>
                        <p>‚è∞ ${station.workingHours}</p>
                        <p>Lo·∫°i: ${station.types.join(', ')}</p>
                        <p class="distance">Kho·∫£ng c√°ch: ${station.distance.toFixed(2)} km</p>
                    </div>
                `;

                // Th√™m marker
                const markerColor = index === 0 ? '#fbbf24' : '#667eea';
                const markerIcon = L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjNjY3ZWVhIiBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJjMCA0LjQgMi43NiA4LjE1IDYuNjUgOS41OWwuNDkuMDFjLjE2IDAgLjMyLS4wMi40Ny0uMDdDMTMuMzUgMjEuNSAxNiAxNy45MyAxNiAxMmMwLTIuMzQtMS4wNS00LjU3LTIuNjYtNi4wOEMxNS4wMyA1LjAxIDE0LjAyIDMuNTggMTEuOCA0LjAxYzIuMzUuMTUgNy4xIDMuODMgNy4xIDcuOTljMCAyLjM0LTEuMDUgNC41Ny0yLjY2IDYuMDhWMjFjLjE1LjA1LjMxLjA3LjQ3LjA3bC40OS0uMDFDMTkuMjQgMjAuMTUgMjIgMTYuNCAyMiAxMmMwLTUuNTItNC40OC0xMC0xMC0xMHptMCA2YzEuMDUgMCAyIC45IDIgMnMtLjk1IDItMiAyLTItLjktMi0yIC45NS0yIDItMnoiLz48L3N2Zz4=',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                markers[`station_${index}`] = L.circleMarker([station.lat, station.lng], {
                    radius: index === 0 ? 12 : 8,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup(`
                    <strong>${station.name}</strong><br>
                    ${station.address}<br>
                    üìû ${station.phone}<br>
                    ‚è∞ ${station.workingHours}<br>
                    Kho·∫£ng c√°ch: ${station.distance.toFixed(2)} km
                `);
            });

            container.innerHTML = html;

            // Zoom b·∫£n ƒë·ªì ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£
            if (Object.keys(markers).length > 1) {
                const group = new L.featureGroup(Object.values(markers));
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        // T·∫≠p trung v√†o c√¢y xƒÉng
        function focusStation(lat, lng, name) {
            if (map) {
                map.setView([lat, lng], 17);
            }
        }

        // T√¨m ki·∫øm
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            const query = e.target.value.toLowerCase();
            const container = document.getElementById('stationContainer');

            if (!query) {
                if (userLocation) {
                    findNearbyStations();
                }
                return;
            }

            const results = gasStations.filter(station => 
                station.name.toLowerCase().includes(query) ||
                station.address.toLowerCase().includes(query)
            );

            if (results.length === 0) {
                container.innerHTML = '<div class="no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                return;
            }

            let html = '';
            results.forEach((station, index) => {
                const distance = userLocation ? calculateDistance(userLocation.lat, userLocation.lng, station.lat, station.lng) : 0;
                html += `
                    <div class="station-item" onclick="focusStation(${station.lat}, ${station.lng}, '${station.name}')">
                        <h3>${station.name}</h3>
                        <p>üìç ${station.address}</p>
                        <p>üìû ${station.phone}</p>
                        <p>‚è∞ ${station.workingHours}</p>
                        ${userLocation ? `<p class="distance">Kho·∫£ng c√°ch: ${distance.toFixed(2)} km</p>` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        });

        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì khi trang load
        window.addEventListener('load', function() {
            setTimeout(function() {
                initMap();
                document.getElementById('stationContainer').innerHTML = 
                    '<div class="no-results">Nh·∫•n "üìç V·ªã Tr√≠ Hi·ªán T·∫°i" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>';
            }, 500);
        });
    </script>
</body>
</html>
