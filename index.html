<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tuner 6 D√¢y - Guitar Tuna Style</title>
  <style>
    body {
      font-family: -apple-system, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      min-height: 100vh;
      margin: 0; padding: 0;
      color: #fff;
      display: flex; justify-content: center; align-items: center;
    }
    .container {
      width: 96vw; max-width: 420px; box-sizing: border-box;
      background: rgba(25,30,40,0.97); border-radius: 18px;
      box-shadow: 0 20px 55px rgba(0,0,0,.5);
      padding: 20px 8px 26px 8px;
      margin: 16px 0;
      border: 1.4px solid rgba(26,188,156,0.19);
    }
    .header {text-align:center; margin-bottom:12px;}
    .logo {font-size:25px; font-weight:bold; letter-spacing:.5px;}
    .logo span{color:#1abc9c;}
    .tuner-display {
      background: rgba(0,0,0,0.63);
      border-radius: 14px;
      padding: 16px 8px 16px 8px;
      margin-bottom:20px; text-align:center;
      border:2px solid rgba(26,188,156,0.18);
    }
    .mode-toggle {
      display: flex; align-items:center; justify-content:center; gap:9px; margin-bottom:12px;
    }
    .switch {
      position:relative; display:inline-block; width:42px; height:22px;
    }
    .switch input { opacity:0; width:0; height:0;}
    .slider {
      position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
      background:#ccc; border-radius:22px; transition:.3s;
    }
    .slider:before {
      position:absolute; content:""; height:18px; width:18px; left:2px; bottom:2px;
      background:white; border-radius:50%; transition:.3s;
    }
    input:checked+.slider {background:#1abc9c;}
    input:checked+.slider:before {transform:translateX(20px);}
    .string-btns {
      display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin: 12px 0 20px;
    }
    .string-btn {
      height:56px; border-radius:13px; border:2px solid #209d8b55;
      background: linear-gradient(110deg, #1abc9c22 60%, #30366a22);
      color: #fff; font-size:19px; font-weight:bold;
      display: flex; flex-direction:column; justify-content:center;
      align-items:center; cursor:pointer; transition:all .16s;
      position:relative;
    }
    .string-btn.active, .string-btn.auto-active {
      background: #1abc9c; color:#111; border-color: #1abc9c;
      box-shadow:0 0 7px #1abc9c77;
    }
    .string-btn .note-label {
      font-size:14px; color: #70958c;
    }
    .note-display {
      font-size:44px; color:#1abc9c; font-weight:bold; margin-bottom:2px; min-height:41px;
    }
    .detail-row {display:flex; justify-content:space-between; font-size:15px; margin:3px 0;}
    .freq-label{color:#999; font-size:.95em;}
    .freq-value{color:#1abc9c;}
    .cents {font-size:14px; color:#fa4;}
    .meter-bar {
      width:100%; height:30px; border-radius:16px; overflow:hidden;
      background:rgba(255,255,255,0.1); position:relative; margin:12px 0;
    }
    .bar-fill {
      position:absolute; height:100%; width:10%; top:0;
      left:45%; transition:left .13s cubic-bezier(.58,1.7,.5,1);
      background:linear-gradient(90deg, #e74c3c, #f39c12 45%, #1abc9c 55%, #f39c12, #e74c3c); opacity:.87;
      border-radius:16px; z-index:1;
    }
    .bar-center {
      position:absolute; left:50%; top:0; bottom:0; width:4px; background:#fff6; z-index:2; transform:translateX(-50%);
    }
    .status-text {font-size:16px; min-height:22px; margin:10px 0 0; font-weight:bold; color:#ff7f50; transition:color .2s;}
    .status-text.in-tune{color:#1abc9c;}
    .btn-block {display:flex; gap:10px; margin:16px 0 8px;}
    .btn {
      flex:1; padding:13px; border-radius:10px; border:none; font-size:15px; font-weight:bold;
      background:#1abc9c; color:#111; cursor:pointer; transition:.15s;
    }
    .btn.stop{background:rgba(52,152,219,0.18); color: #fff;}
    .btn:active{transform:scale(.98);}
    .oscilloscope{width:100%; max-width:355px; height:37px; border-radius:8px; margin:8px 0; background:rgba(26,188,156,0.07);}
    .info-section {
      background:rgba(26,188,156,.12); border-radius:9px; padding:11px 8px;
      font-size:13px; line-height:1.65; color:#ccc;
      border:1px solid rgba(26,188,156,0.14);
      max-width:99vw; margin:auto;
    }
    .info-section strong { color: #1abc9c; }
    @media (max-width:600px){
      .container{max-width:99vw; padding:3vw 1vw;}
      .logo{font-size:20px;}
      .note-display{font-size:23px;}
      .string-btn{height:42px; font-size:16px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">guitar<span>tuna</span></div>
      <p style="color:#9bc;font-size:13px;">Standard 6 d√¢y (E B G D A E)</p>
    </div>
    <div class="mode-toggle">
      <span style="color:#ccc;font-size:14px;">Th·ªß c√¥ng</span>
      <label class="switch">
        <input type="checkbox" id="modeToggle" checked>
        <span class="slider"></span>
      </label>
      <span style="color:#1abc9c;font-weight:bold;font-size:14px;">Auto</span>
    </div>
    <div class="string-btns" id="stringBtns">
      <button class="string-btn" data-string="1" data-note="E4"><span class="note-label">D√¢y 1</span>E</button>
      <button class="string-btn" data-string="2" data-note="B3"><span class="note-label">D√¢y 2</span>B</button>
      <button class="string-btn" data-string="3" data-note="G3"><span class="note-label">D√¢y 3</span>G</button>
      <button class="string-btn" data-string="4" data-note="D3"><span class="note-label">D√¢y 4</span>D</button>
      <button class="string-btn" data-string="5" data-note="A2"><span class="note-label">D√¢y 5</span>A</button>
      <button class="string-btn" data-string="6" data-note="E2"><span class="note-label">D√¢y 6</span>E</button>
    </div>
    <div class="tuner-display">
      <div class="note-display" id="noteDisplay">---</div>
      <div class="detail-row"><div class="freq-label">T·∫ßn s·ªë th·ª±c</div><div class="freq-value" id="actualFreq">0 Hz</div></div>
      <div class="detail-row"><div class="freq-label">T·∫ßn s·ªë l√Ω thuy·∫øt</div><div class="freq-value" id="targetFreq">0 Hz</div></div>
      <div class="detail-row"><div class="freq-label">Sai s·ªë</div><div class="cents" id="centDiff">0 cent</div></div>
      <div class="meter-bar"><div class="bar-fill" id="barFill"></div><div class="bar-center"></div></div>
      <div class="status-text" id="statusText">Nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ ch·ªânh ƒë√†n</div>
      <canvas id="oscilloscope" class="oscilloscope"></canvas>
    </div>
    <div class="btn-block">
      <button class="btn" id="startBtn">B·∫Øt ƒë·∫ßu</button>
      <button class="btn stop" id="stopBtn">D·ª´ng</button>
    </div>
    <div class="info-section">
      <strong>üìù H∆∞·ªõng d·∫´n:</strong><br>
      ‚Äì Ch·ªçn Auto (app t·ª± nh·∫≠n d√¢y) <br>
      ‚Äì Chuy·ªÉn sang "Th·ªß c√¥ng" ƒë·ªÉ tu·ª≥ ch·ªânh t·ª´ng d√¢y<br>
      ‚Äì Xoay tuner ƒë√†n cho ƒë·∫øn khi t·∫ßn s·ªë ƒë√∫ng v√† b√°o "Ch√≠nh x√°c"
    </div>
  </div>
  <script>
    // D·ªØ li·ªáu note chu·∫©n
    const stringInfos = [
      { note:'E4', freq:329.63, label:'D√¢y 1' },
      { note:'B3', freq:246.94, label:'D√¢y 2' },
      { note:'G3', freq:196.00, label:'D√¢y 3' },
      { note:'D3', freq:146.83, label:'D√¢y 4' },
      { note:'A2', freq:110.00, label:'D√¢y 5' },
      { note:'E2', freq:82.41,  label:'D√¢y 6' }
    ];
    const noteList=[]; const noteNames=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    for(let n=40;n<=83;n++){
      let note=noteNames[n%12],o=Math.floor(n/12)-1,f=440*Math.pow(2,(n-69)/12);
      noteList.push({note:note+o,freq:f,midi:n});
    }
    // Bi·∫øn DOM & tr·∫°ng th√°i
    let isAutoMode=true, currentNote=stringInfos[0].note, targetFreq=stringInfos[0].freq;
    let audioContext, analyser, dataArray, waveform, micStream, animationId, isListening=false;
    const noteDisplay=document.getElementById('noteDisplay');
    const actualFreqEl=document.getElementById('actualFreq');
    const targetFreqEl=document.getElementById('targetFreq');
    const barFill=document.getElementById('barFill');
    const centDiffEl=document.getElementById('centDiff');
    const statusText=document.getElementById('statusText');
    const oscCanvas=document.getElementById('oscilloscope');
    const oscCtx=oscCanvas.getContext('2d');
    const modeToggle=document.getElementById('modeToggle');
    const stringBtns=document.querySelectorAll('.string-btn');
    function setBtnActive(note){
      stringBtns.forEach(btn=>{
        btn.classList.remove('active','auto-active');
        if(btn.dataset.note===note) btn.classList.add('active');
      });
    }
    function setBtnAutoActive(note){
      stringBtns.forEach(btn=>{
        btn.classList.remove('auto-active');
        if(btn.dataset.note===note) btn.classList.add('auto-active');
      });
    }
    function getClosestStringNote(freq){
      let min=1e9,res=stringInfos[0];
      for(const s of stringInfos){
        let d=Math.abs(freq-s.freq);
        if(d<min){min=d;res=s;}
      }
      return res;
    }
    function findClosestNote(freq){
      let min=1e9,closest=noteList[0];
      for(const n of noteList){let d=Math.abs(freq-n.freq);if(d<min){min=d;closest=n;}}
      return closest;
    }
    function getCentDiff(freq,ref){return 1200*Math.log2(freq/ref);}
    // Toggle auto/manual & ch·ªçn d√¢y (manual)
    modeToggle.onchange=function(){
      isAutoMode=this.checked;
      if(isAutoMode){
        stringBtns.forEach(btn=>btn.classList.remove('active'));
        statusText.textContent="Ch·∫ø ƒë·ªô t·ª± ƒë·ªông nh·∫≠n d√¢y";
      }else{
        setBtnActive(currentNote);
        statusText.textContent="Ch·ªçn d√¢y mu·ªën ch·ªânh";
      }
    };
    stringBtns.forEach((btn,idx)=>{
      btn.onclick=()=>{
        if(!isAutoMode){
          stringBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentNote=btn.dataset.note;
          targetFreq=stringInfos[idx].freq;
          targetFreqEl.textContent=targetFreq.toFixed(2)+" Hz";
        }
      };
    });
    // B·∫Øt ƒë·∫ßu/d·ª´ng tuner
    document.getElementById('startBtn').onclick=startTuner;
    document.getElementById('stopBtn').onclick=stopTuner;
    // Hi·ªÉn th·ªã target m·∫∑c ƒë·ªãnh
    targetFreqEl.textContent=targetFreq.toFixed(2)+" Hz";
    function startTuner(){
      if(isListening)return;
      navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        micStream=stream;
        audioContext=new (window.AudioContext||window.webkitAudioContext)();
        analyser=audioContext.createAnalyser();
        analyser.fftSize=4096; analyser.smoothingTimeConstant=0.87;
        let source=audioContext.createMediaStreamSource(micStream);
        source.connect(analyser);
        dataArray=new Uint8Array(analyser.frequencyBinCount);
        waveform=new Uint8Array(analyser.fftSize);
        isListening=true;
        statusText.textContent='ƒêang nh·∫≠n di·ªán...'; statusText.classList.remove('in-tune');
        noteDisplay.textContent='---';
        loop();
      }).catch(e=>alert("B·∫°n c·∫ßn c·∫•p quy·ªÅn micro!"));
    }
    function stopTuner(){
      isListening=false;
      if(animationId)cancelAnimationFrame(animationId);
      if(audioContext)audioContext.close();
      if(micStream)micStream.getTracks().forEach(t=>t.stop());
      noteDisplay.textContent='---';
      statusText.textContent="ƒê√£ d·ª´ng"; statusText.classList.remove('in-tune');
      actualFreqEl.textContent='0 Hz'; targetFreqEl.textContent=targetFreq.toFixed(2)+' Hz';
      barFill.style.left='45%'; centDiffEl.textContent="";
      stringBtns.forEach(btn=>btn.classList.remove('auto-active'));
      oscCtx.clearRect(0,0,oscCanvas.width,oscCanvas.height);
    }
    function loop(){
      if(!isListening)return;
      analyser.getByteTimeDomainData(waveform);
      let freq=autoCorrelate(waveform,audioContext.sampleRate);
      if(freq>30&&freq<1500){
        actualFreqEl.textContent=freq.toFixed(2)+' Hz';
        let closestNote=findClosestNote(freq);
        noteDisplay.textContent=closestNote.note;
        if(isAutoMode){
          let str=getClosestStringNote(freq);
          setBtnAutoActive(str.note); // highlight auto d√¢y ƒë√∫ng
          targetFreq=str.freq;
          targetFreqEl.textContent=targetFreq.toFixed(2)+" Hz";
        }
        let cents=getCentDiff(freq,targetFreq);
        centDiffEl.textContent=(cents>0?"+":"")+cents.toFixed(1)+' cent';
        // meter
        let left=45+Math.max(-45, Math.min(45,cents/2));
        barFill.style.left=left+"%";
        // status
        if(Math.abs(cents)<6){statusText.textContent="‚úì Ch√≠nh x√°c!"; statusText.classList.add('in-tune');}
        else if(Math.abs(cents)<15){
          statusText.textContent=cents>0?"‚Üì Cao h∆°n":"‚Üë Th·∫•p h∆°n"; statusText.classList.remove('in-tune');
        }else{
          statusText.textContent=cents>0?"‚Üì‚Üì Cao nhi·ªÅu h∆°n":"‚Üë‚Üë Th·∫•p nhi·ªÅu h∆°n"; statusText.classList.remove('in-tune');
        }
      }else{
        actualFreqEl.textContent='0 Hz';
        noteDisplay.textContent="---"; centDiffEl.textContent="";
        barFill.style.left="45%";
        stringBtns.forEach(btn=>btn.classList.remove('auto-active'));
        statusText.textContent="Kh√¥ng nh·∫≠n ƒë∆∞·ª£c t√≠n hi·ªáu...";
        statusText.classList.remove('in-tune');
      }
      drawOscilloscope();
      animationId=requestAnimationFrame(loop);
    }
    // Autocorrelation (ƒë∆°n gi·∫£n)
    function autoCorrelate(buf,sampleRate){
      let SIZE=buf.length,rms=0;
      for(let i=0;i<SIZE;i++){let v=buf[i]-128;rms+=v*v;}
      rms=Math.sqrt(rms/SIZE); if(rms<8)return -1;
      let best_offset=-1,best_corr=0;
      for(let offset=32;offset<SIZE/2;offset++){
        let corr=0;
        for(let i=0;i<SIZE/2;i++)corr+=Math.abs(buf[i]-buf[i+offset]);
        corr=1-(corr/(SIZE/2)/128);
        if(corr>best_corr&&corr>0.9){best_corr=corr;best_offset=offset;}
      }
      if(best_offset==-1)return -1;
      return sampleRate/best_offset;
    }
    // Visualizer
    function drawOscilloscope(){
      oscCtx.clearRect(0,0,oscCanvas.width,oscCanvas.height);
      let w=oscCanvas.width,h=oscCanvas.height;
      oscCtx.beginPath();
      for(let i=0;i<waveform.length;i++){
        let x=i*w/waveform.length,y=(waveform[i]/255)*h;
        if(i===0)oscCtx.moveTo(x,y);else oscCtx.lineTo(x,y);
      }
      oscCtx.strokeStyle="#1abc9c"; oscCtx.lineWidth=2; oscCtx.stroke();
    }
  </script>
</body>
</html>