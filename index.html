<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé§ KaraStudio</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');

  :root {
    --neon-pink: #ff2d78;
    --neon-cyan: #00f5ff;
    --neon-purple: #bf00ff;
    --gold: #ffd700;
    --dark: #08060f;
    --dark2: #110d1e;
    --dark3: #1a1230;
    --glass: rgba(255,255,255,0.05);
    --glass-border: rgba(255,255,255,0.1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: #fff;
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(191,0,255,0.15) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(0,245,255,0.1) 0%, transparent 50%),
      radial-gradient(ellipse at 50% 50%, rgba(255,45,120,0.05) 0%, transparent 70%);
  }

  /* Scanlines overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 1000;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header */
  header {
    text-align: center;
    padding: 30px 0 20px;
    animation: fadeDown 0.8s ease;
  }

  header h1 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 900;
    letter-spacing: 0.1em;
    background: linear-gradient(90deg, var(--neon-pink), var(--neon-cyan), var(--neon-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    position: relative;
  }

  header h1::after {
    content: 'KARA STUDIO';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, var(--neon-pink), var(--neon-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: blur(12px);
    opacity: 0.5;
  }

  header p {
    color: rgba(255,255,255,0.4);
    font-size: 0.9rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-top: 6px;
  }

  /* URL Input Section */
  .url-section {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
    animation: fadeUp 0.6s ease 0.2s both;
  }

  .url-label {
    font-family: 'Orbitron', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.25em;
    color: var(--neon-cyan);
    text-transform: uppercase;
    margin-bottom: 10px;
    display: block;
  }

  .url-row {
    display: flex;
    gap: 10px;
  }

  .url-input {
    flex: 1;
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(0,245,255,0.3);
    border-radius: 10px;
    padding: 12px 16px;
    color: #fff;
    font-family: 'Rajdhani', sans-serif;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .url-input:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 20px rgba(0,245,255,0.2);
  }

  .url-input::placeholder { color: rgba(255,255,255,0.25); }

  .btn {
    border: none;
    border-radius: 10px;
    padding: 12px 20px;
    font-family: 'Orbitron', monospace;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.25s;
    text-transform: uppercase;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
    color: #fff;
    box-shadow: 0 0 20px rgba(255,45,120,0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 35px rgba(255,45,120,0.6);
  }

  .btn-primary:active { transform: translateY(0); }

  /* Video Section */
  .video-section {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
    animation: fadeUp 0.6s ease 0.3s both;
    position: relative;
  }

  .video-wrapper {
    position: relative;
    padding-top: 56.25%;
    background: #000;
  }

  .video-placeholder {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: rgba(255,255,255,0.2);
  }

  .video-placeholder .icon { font-size: 4rem; }
  .video-placeholder p {
    font-family: 'Orbitron', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    text-align: center;
  }

  #yt-frame {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: none;
    display: none;
  }

  /* Controls Grid */
  .controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
    animation: fadeUp 0.6s ease 0.4s both;
  }

  @media (max-width: 600px) {
    .controls-grid { grid-template-columns: 1fr; }
  }

  .panel {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
  }

  .panel-title {
    font-family: 'Orbitron', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title.pink { color: var(--neon-pink); }
  .panel-title.cyan { color: var(--neon-cyan); }
  .panel-title.gold { color: var(--gold); }
  .panel-title.purple { color: var(--neon-purple); }

  .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: currentColor;
    box-shadow: 0 0 8px currentColor;
    animation: pulse 2s infinite;
  }

  /* Sliders */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .slider-row:last-child { margin-bottom: 0; }

  .slider-label {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.5);
    width: 80px;
    flex-shrink: 0;
  }

  .slider-val {
    font-family: 'Orbitron', monospace;
    font-size: 0.7rem;
    width: 36px;
    text-align: right;
    color: rgba(255,255,255,0.8);
    flex-shrink: 0;
  }

  input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: rgba(255,255,255,0.1);
    outline: none;
    cursor: pointer;
  }

  input[type="range"].pink::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--neon-pink);
    box-shadow: 0 0 10px var(--neon-pink);
    cursor: pointer;
    transition: transform 0.2s;
  }

  input[type="range"].pink::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--neon-pink) var(--pct, 50%), rgba(255,255,255,0.1) var(--pct, 50%)); border-radius: 2px; }

  input[type="range"].cyan::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--neon-cyan);
    box-shadow: 0 0 10px var(--neon-cyan);
    cursor: pointer;
  }

  input[type="range"].cyan::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--neon-cyan) var(--pct, 50%), rgba(255,255,255,0.1) var(--pct, 50%)); border-radius: 2px; }

  input[type="range"].gold::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--gold);
    box-shadow: 0 0 10px var(--gold);
    cursor: pointer;
  }

  input[type="range"].gold::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--gold) var(--pct, 50%), rgba(255,255,255,0.1) var(--pct, 50%)); border-radius: 2px; }

  input[type="range"].purple::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--neon-purple);
    box-shadow: 0 0 10px var(--neon-purple);
    cursor: pointer;
  }

  input[type="range"].purple::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--neon-purple) var(--pct, 50%), rgba(255,255,255,0.1) var(--pct, 50%)); border-radius: 2px; }

  /* Mic Panel */
  .mic-section {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    animation: fadeUp 0.6s ease 0.5s both;
  }

  .mic-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: gap;
    gap: 10px;
  }

  .mic-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.4);
  }

  .mic-indicator {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    transition: all 0.3s;
  }

  .mic-indicator.active {
    background: #00ff88;
    box-shadow: 0 0 12px #00ff88;
    animation: micPulse 0.5s infinite alternate;
  }

  .mic-indicator.muted {
    background: var(--neon-pink);
    box-shadow: 0 0 12px var(--neon-pink);
  }

  /* VU Meter */
  .vu-meter {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    height: 40px;
    margin-bottom: 16px;
    padding: 6px 0;
  }

  .vu-bar {
    flex: 1;
    border-radius: 3px 3px 0 0;
    transition: height 0.05s;
    min-height: 3px;
  }

  /* Buttons row */
  .btn-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-sm {
    padding: 9px 16px;
    font-size: 0.65rem;
    border-radius: 8px;
    flex: 1;
    min-width: 90px;
  }

  .btn-cyan {
    background: transparent;
    border: 1px solid var(--neon-cyan);
    color: var(--neon-cyan);
    box-shadow: 0 0 10px rgba(0,245,255,0.2);
  }

  .btn-cyan:hover, .btn-cyan.active {
    background: rgba(0,245,255,0.15);
    box-shadow: 0 0 20px rgba(0,245,255,0.4);
  }

  .btn-pink {
    background: transparent;
    border: 1px solid var(--neon-pink);
    color: var(--neon-pink);
    box-shadow: 0 0 10px rgba(255,45,120,0.2);
  }

  .btn-pink:hover, .btn-pink.active {
    background: rgba(255,45,120,0.15);
    box-shadow: 0 0 20px rgba(255,45,120,0.4);
  }

  .btn-gold {
    background: transparent;
    border: 1px solid var(--gold);
    color: var(--gold);
    box-shadow: 0 0 10px rgba(255,215,0,0.2);
  }

  .btn-gold:hover, .btn-gold.active {
    background: rgba(255,215,0,0.1);
    box-shadow: 0 0 20px rgba(255,215,0,0.4);
  }

  .btn-purple {
    background: transparent;
    border: 1px solid var(--neon-purple);
    color: var(--neon-purple);
    box-shadow: 0 0 10px rgba(191,0,255,0.2);
  }

  .btn-purple:hover, .btn-purple.active {
    background: rgba(191,0,255,0.15);
    box-shadow: 0 0 20px rgba(191,0,255,0.4);
  }

  /* Mic controls grid */
  .mic-controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
    animation: fadeUp 0.6s ease 0.6s both;
  }

  @media (max-width: 600px) {
    .mic-controls-grid { grid-template-columns: 1fr; }
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--dark2);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    padding: 12px 24px;
    font-size: 0.85rem;
    color: rgba(255,255,255,0.8);
    z-index: 9999;
    transition: transform 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
    backdrop-filter: blur(10px);
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Animations */
  @keyframes fadeDown { from { opacity:0; transform: translateY(-20px); } to { opacity:1; transform: translateY(0); } }
  @keyframes fadeUp { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  @keyframes micPulse { from { transform: scale(1); } to { transform: scale(1.4); } }

  /* Footer */
  footer {
    text-align: center;
    padding: 20px;
    color: rgba(255,255,255,0.15);
    font-size: 0.75rem;
    letter-spacing: 0.2em;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>KARA STUDIO</h1>
    <p>üé§ Karaoke t·∫°i nh√† ¬∑ Mic ¬∑ Hi·ªáu ·ª©ng</p>
  </header>

  <!-- URL Input -->
  <div class="url-section">
    <span class="url-label">üì∫ Nh·∫≠p link YouTube</span>
    <div class="url-row">
      <input type="text" id="ytUrl" class="url-input" placeholder="https://www.youtube.com/watch?v=... ho·∫∑c youtu.be/..." />
      <button class="btn btn-primary" onclick="loadVideo()">‚ñ∂ PH√ÅT</button>
    </div>
  </div>

  <!-- Video -->
  <div class="video-section">
    <div class="video-wrapper">
      <div class="video-placeholder" id="placeholder">
        <div class="icon">üé¨</div>
        <p>Nh·∫≠p link YouTube ƒë·ªÉ b·∫Øt ƒë·∫ßu karaoke</p>
      </div>
      <iframe id="yt-frame" allowfullscreen allow="autoplay; encrypted-media"></iframe>
    </div>
  </div>

  <!-- Video Controls -->
  <div class="controls-grid">
    <div class="panel">
      <div class="panel-title pink"><div class="dot"></div> √Çm l∆∞·ª£ng Video</div>
      <div class="slider-row">
        <span class="slider-label">Video Vol</span>
        <input type="range" id="videoVol" class="pink" min="0" max="100" value="80" oninput="updateSlider(this,'videoVol'); updateVideoVolume()" />
        <span class="slider-val" id="videoVolVal">80</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">T·ªëc ƒë·ªô</span>
        <input type="range" id="videoSpeed" class="pink" min="50" max="150" value="100" oninput="updateSlider(this,'videoSpeed')" />
        <span class="slider-val" id="videoSpeedVal">100%</span>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title cyan"><div class="dot"></div> Mic Volume & Gain</div>
      <div class="slider-row">
        <span class="slider-label">Mic Vol</span>
        <input type="range" id="micVol" class="cyan" min="0" max="200" value="100" oninput="updateSlider(this,'micVol'); updateMicGain()" />
        <span class="slider-val" id="micVolVal">100</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Gain</span>
        <input type="range" id="micGain" class="cyan" min="0" max="40" value="10" oninput="updateSlider(this,'micGain'); updateMicGain()" />
        <span class="slider-val" id="micGainVal">10dB</span>
      </div>
    </div>
  </div>

  <!-- Mic Section -->
  <div class="mic-section">
    <div class="mic-header">
      <div class="panel-title gold" style="margin-bottom:0"><div class="dot"></div> üé§ Microphone</div>
      <div class="mic-status">
        <div class="mic-indicator" id="micIndicator"></div>
        <span id="micStatusText">Ch∆∞a k·∫øt n·ªëi</span>
      </div>
    </div>

    <!-- VU Meter -->
    <div class="vu-meter" id="vuMeter"></div>

    <!-- Mic Buttons -->
    <div class="btn-row">
      <button class="btn btn-sm btn-cyan" id="btnMicStart" onclick="startMic()">üé§ B·∫¨T MIC</button>
      <button class="btn btn-sm btn-pink" id="btnMicMute" onclick="toggleMute()" disabled>üîá T·∫ÆT TI·∫æNG</button>
      <button class="btn btn-sm btn-gold" id="btnEcho" onclick="toggleEffect('echo')" disabled>üîÅ ECHO</button>
      <button class="btn btn-sm btn-purple" id="btnReverb" onclick="toggleEffect('reverb')" disabled>üåä REVERB</button>
    </div>
  </div>

  <!-- EQ & Effects -->
  <div class="mic-controls-grid">
    <div class="panel">
      <div class="panel-title gold"><div class="dot"></div> Equalizer Mic</div>
      <div class="slider-row">
        <span class="slider-label">Bass</span>
        <input type="range" id="eqBass" class="gold" min="-20" max="20" value="0" oninput="updateSlider(this,'eqBass'); updateEQ()" />
        <span class="slider-val" id="eqBassVal">0dB</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Mid</span>
        <input type="range" id="eqMid" class="gold" min="-20" max="20" value="0" oninput="updateSlider(this,'eqMid'); updateEQ()" />
        <span class="slider-val" id="eqMidVal">0dB</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Treble</span>
        <input type="range" id="eqTreble" class="gold" min="-20" max="20" value="0" oninput="updateSlider(this,'eqTreble'); updateEQ()" />
        <span class="slider-val" id="eqTrebleVal">0dB</span>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title purple"><div class="dot"></div> Hi·ªáu ·ª©ng gi·ªçng</div>
      <div class="slider-row">
        <span class="slider-label">Echo Delay</span>
        <input type="range" id="echoDelay" class="purple" min="50" max="800" value="300" oninput="updateSlider(this,'echoDelay'); updateEcho()" />
        <span class="slider-val" id="echoDelayVal">300ms</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Echo Mix</span>
        <input type="range" id="echoFeedback" class="purple" min="0" max="80" value="30" oninput="updateSlider(this,'echoFeedback'); updateEcho()" />
        <span class="slider-val" id="echoFeedbackVal">30%</span>
      </div>
      <div class="slider-row">
        <span class="slider-label">Reverb</span>
        <input type="range" id="reverbWet" class="purple" min="0" max="100" value="30" oninput="updateSlider(this,'reverbWet'); updateReverb()" />
        <span class="slider-val" id="reverbWetVal">30%</span>
      </div>
    </div>
  </div>

  <footer>KARA STUDIO ¬∑ C·∫Øm tai nghe ƒë·ªÉ nghe mic c√πng nh·∫°c üéß</footer>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== VU Meter Init =====
const vuMeter = document.getElementById('vuMeter');
const NUM_BARS = 32;
for (let i = 0; i < NUM_BARS; i++) {
  const bar = document.createElement('div');
  bar.className = 'vu-bar';
  bar.style.height = '3px';
  // color gradient green -> yellow -> red
  const pct = i / NUM_BARS;
  if (pct < 0.6) bar.style.background = `hsl(${140 - pct*60}, 100%, 50%)`;
  else if (pct < 0.8) bar.style.background = '#ffd700';
  else bar.style.background = '#ff2d78';
  vuMeter.appendChild(bar);
}

// ===== YouTube =====
function extractVideoId(url) {
  url = url.trim();
  const patterns = [
    /(?:youtube\.com\/watch\?(?:.*&)?v=)([a-zA-Z0-9_-]{11})/,
    /(?:youtu\.be\/)([a-zA-Z0-9_-]{11})/,
    /(?:youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
  ];
  for (const p of patterns) {
    const m = url.match(p);
    if (m) return m[1];
  }
  return null;
}

function loadVideo() {
  const url = document.getElementById('ytUrl').value;
  const videoId = extractVideoId(url);
  if (!videoId) { showToast('‚ùå Link kh√¥ng h·ª£p l·ªá. Vui l√≤ng d√°n link YouTube!'); return; }

  const frame = document.getElementById('yt-frame');
  frame.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&controls=1&rel=0`;
  frame.style.display = 'block';
  document.getElementById('placeholder').style.display = 'none';
  showToast('‚ñ∂ ƒêang ph√°t video...');
}

document.getElementById('ytUrl').addEventListener('keydown', e => { if (e.key === 'Enter') loadVideo(); });

// ===== Slider updater =====
function updateSlider(el, id) {
  const val = parseFloat(el.value);
  const min = parseFloat(el.min), max = parseFloat(el.max);
  const pct = ((val - min) / (max - min) * 100).toFixed(1) + '%';
  el.style.setProperty('--pct', pct);

  const map = {
    videoVol: v => `${v}`, videoSpeed: v => `${v}%`,
    micVol: v => `${v}`, micGain: v => `${v}dB`,
    eqBass: v => `${v}dB`, eqMid: v => `${v}dB`, eqTreble: v => `${v}dB`,
    echoDelay: v => `${v}ms`, echoFeedback: v => `${v}%`, reverbWet: v => `${v}%`,
  };
  const fmt = map[id];
  document.getElementById(id + 'Val').textContent = fmt ? fmt(val) : val;
}

// Init all sliders visual
['videoVol','videoSpeed','micVol','micGain','eqBass','eqMid','eqTreble','echoDelay','echoFeedback','reverbWet'].forEach(id => {
  const el = document.getElementById(id);
  if (el) updateSlider(el, id);
});

// ===== Audio API =====
let audioCtx, micStream, sourceNode, gainNode, echoDelay, echoGain, echoFeedbackNode, reverbNode, reverbConvolver, eqBassFilter, eqMidFilter, eqTrebleFilter, analyser;
let micActive = false, micMuted = false, echoOn = false, reverbOn = false;
let animFrame;

async function startMic() {
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaStreamSource(micStream);
    gainNode = audioCtx.createGain();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 64;

    // EQ filters
    eqBassFilter = audioCtx.createBiquadFilter();
    eqBassFilter.type = 'lowshelf';
    eqBassFilter.frequency.value = 200;

    eqMidFilter = audioCtx.createBiquadFilter();
    eqMidFilter.type = 'peaking';
    eqMidFilter.frequency.value = 1000;
    eqMidFilter.Q.value = 1;

    eqTrebleFilter = audioCtx.createBiquadFilter();
    eqTrebleFilter.type = 'highshelf';
    eqTrebleFilter.frequency.value = 4000;

    // Echo (delay + feedback)
    echoDelay = audioCtx.createDelay(1.0);
    echoDelay.delayTime.value = 0.3;
    echoFeedbackNode = audioCtx.createGain();
    echoFeedbackNode.gain.value = 0.3;
    echoGain = audioCtx.createGain();
    echoGain.gain.value = 0; // off by default

    // Reverb (ConvolverNode with generated impulse)
    reverbNode = audioCtx.createGain();
    reverbNode.gain.value = 0; // off
    reverbConvolver = audioCtx.createConvolver();
    reverbConvolver.buffer = createImpulse(audioCtx, 2, 2, false);

    // Chain: source -> gain -> eq -> analyser -> destination
    // Echo path: analyser -> echoDelay -> echoFeedback -> echoDelay (loop), echoDelay -> destination via echoGain
    // Reverb: analyser -> reverb convolver -> reverbNode -> destination

    sourceNode.connect(gainNode);
    gainNode.connect(eqBassFilter);
    eqBassFilter.connect(eqMidFilter);
    eqMidFilter.connect(eqTrebleFilter);
    eqTrebleFilter.connect(analyser);
    analyser.connect(audioCtx.destination);

    // Echo routing
    analyser.connect(echoDelay);
    echoDelay.connect(echoFeedbackNode);
    echoFeedbackNode.connect(echoDelay);
    echoDelay.connect(echoGain);
    echoGain.connect(audioCtx.destination);

    // Reverb routing
    analyser.connect(reverbConvolver);
    reverbConvolver.connect(reverbNode);
    reverbNode.connect(audioCtx.destination);

    micActive = true;
    updateMicGain();
    updateEQ();
    updateEcho();
    updateReverb();

    document.getElementById('micIndicator').className = 'mic-indicator active';
    document.getElementById('micStatusText').textContent = 'ƒêang ho·∫°t ƒë·ªông';
    document.getElementById('btnMicStart').textContent = '‚èπ T·∫ÆT MIC';
    document.getElementById('btnMicStart').onclick = stopMic;
    document.getElementById('btnMicMute').disabled = false;
    document.getElementById('btnEcho').disabled = false;
    document.getElementById('btnReverb').disabled = false;

    drawVU();
    showToast('üé§ Mic ƒë√£ b·∫≠t ‚Äì C·∫Øm tai nghe ƒë·ªÉ nghe!');
  } catch(e) {
    showToast('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p mic: ' + e.message);
  }
}

function stopMic() {
  if (micStream) micStream.getTracks().forEach(t => t.stop());
  if (audioCtx) audioCtx.close();
  cancelAnimationFrame(animFrame);
  resetVU();
  micActive = false;
  document.getElementById('micIndicator').className = 'mic-indicator';
  document.getElementById('micStatusText').textContent = 'Ch∆∞a k·∫øt n·ªëi';
  document.getElementById('btnMicStart').textContent = 'üé§ B·∫¨T MIC';
  document.getElementById('btnMicStart').onclick = startMic;
  document.getElementById('btnMicMute').disabled = true;
  document.getElementById('btnEcho').disabled = true;
  document.getElementById('btnReverb').disabled = true;
  echoOn = false; reverbOn = false; micMuted = false;
  document.getElementById('btnEcho').classList.remove('active');
  document.getElementById('btnReverb').classList.remove('active');
  document.getElementById('btnMicMute').classList.remove('active');
  document.getElementById('btnMicMute').textContent = 'üîá T·∫ÆT TI·∫æNG';
  showToast('‚èπ Mic ƒë√£ t·∫Øt');
}

function toggleMute() {
  if (!micActive) return;
  micMuted = !micMuted;
  gainNode.gain.value = micMuted ? 0 : getMicGainValue();
  const btn = document.getElementById('btnMicMute');
  btn.classList.toggle('active', micMuted);
  btn.textContent = micMuted ? 'üîä B·ªé MUTE' : 'üîá T·∫ÆT TI·∫æNG';
  document.getElementById('micIndicator').className = 'mic-indicator ' + (micMuted ? 'muted' : 'active');
  document.getElementById('micStatusText').textContent = micMuted ? 'ƒêang mute' : 'ƒêang ho·∫°t ƒë·ªông';
  showToast(micMuted ? 'üîá Mic ƒë√£ t·∫Øt ti·∫øng' : 'üîä Mic b·∫≠t tr·ªü l·∫°i');
}

function toggleEffect(type) {
  if (!micActive) return;
  if (type === 'echo') {
    echoOn = !echoOn;
    updateEcho();
    document.getElementById('btnEcho').classList.toggle('active', echoOn);
    showToast(echoOn ? 'üîÅ Echo b·∫≠t' : 'üîÅ Echo t·∫Øt');
  } else {
    reverbOn = !reverbOn;
    updateReverb();
    document.getElementById('btnReverb').classList.toggle('active', reverbOn);
    showToast(reverbOn ? 'üåä Reverb b·∫≠t' : 'üåä Reverb t·∫Øt');
  }
}

function getMicGainValue() {
  const vol = parseInt(document.getElementById('micVol').value) / 100;
  const gain = parseInt(document.getElementById('micGain').value);
  return vol * Math.pow(10, gain / 20);
}

function updateMicGain() {
  if (!gainNode) return;
  if (!micMuted) gainNode.gain.value = getMicGainValue();
}

function updateEQ() {
  if (!eqBassFilter) return;
  eqBassFilter.gain.value = parseInt(document.getElementById('eqBass').value);
  eqMidFilter.gain.value = parseInt(document.getElementById('eqMid').value);
  eqTrebleFilter.gain.value = parseInt(document.getElementById('eqTreble').value);
}

function updateEcho() {
  if (!echoGain) return;
  echoDelay.delayTime.value = parseInt(document.getElementById('echoDelay').value) / 1000;
  echoFeedbackNode.gain.value = parseInt(document.getElementById('echoFeedback').value) / 100;
  echoGain.gain.value = echoOn ? 0.6 : 0;
}

function updateReverb() {
  if (!reverbNode) return;
  reverbNode.gain.value = reverbOn ? parseInt(document.getElementById('reverbWet').value) / 100 : 0;
}

function updateVideoVolume() {
  // YouTube iframe volume can't be controlled via JS easily; this is for note
}

// Impulse response generator for reverb
function createImpulse(ctx, duration, decay) {
  const sampleRate = ctx.sampleRate;
  const length = sampleRate * duration;
  const impulse = ctx.createBuffer(2, length, sampleRate);
  for (let c = 0; c < 2; c++) {
    const data = impulse.getChannelData(c);
    for (let i = 0; i < length; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay);
    }
  }
  return impulse;
}

// VU Meter animation
function drawVU() {
  if (!analyser) return;
  const bars = vuMeter.querySelectorAll('.vu-bar');
  const dataArr = new Uint8Array(analyser.frequencyBinCount);

  function draw() {
    animFrame = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArr);
    const len = Math.min(bars.length, dataArr.length);
    for (let i = 0; i < bars.length; i++) {
      const idx = Math.floor(i * dataArr.length / bars.length);
      const v = dataArr[idx] / 255;
      bars[i].style.height = Math.max(3, v * 40) + 'px';
      bars[i].style.opacity = 0.4 + v * 0.6;
    }
  }
  draw();
}

function resetVU() {
  vuMeter.querySelectorAll('.vu-bar').forEach(b => { b.style.height = '3px'; });
}

// Toast
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
