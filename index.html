<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuy·ªÉn ƒê·ªïi √Çm Thanh</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 30px;
            margin: 20px auto;
        }
        h1 { text-align: center; color: #333; margin-bottom: 8px; font-size: 24px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 13px; }

        /* File picker */
        .file-input-wrapper { position: relative; display: block; cursor: pointer; margin-bottom: 8px; }
        input[type="file"] {
            position: absolute; top:0; left:0; width:100%; height:100%;
            opacity: 0.01; cursor: pointer; z-index: 10; font-size: 16px;
        }
        .file-input-visual {
            display: flex; flex-direction: column; align-items: center;
            padding: 24px 16px; border: 2px dashed #667eea; border-radius: 8px;
            background: #f8f9ff; pointer-events: none; text-align: center;
        }
        .file-input-visual .icon { font-size: 28px; margin-bottom: 6px; }
        .file-input-visual .hint { color: #667eea; font-weight: 600; font-size: 14px; }
        #fileName { color: #667eea; font-size: 13px; margin-top: 6px; font-weight: 600; }
        .info-text { font-size: 11px; color: #999; margin-top: 4px; }
        .ios-note {
            background: #fff3cd; border: 1px solid #ffc107; color: #856404;
            border-radius: 6px; padding: 8px 12px; font-size: 12px; margin-top: 8px; display: none;
        }

        /* Format */
        .format-group {
            display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; margin: 16px 0;
        }
        .format-item input[type="radio"] { display: none; }
        .format-item label {
            display: flex; align-items: center; justify-content: center;
            padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;
            cursor: pointer; font-weight: 500; font-size: 13px;
            transition: all 0.2s; margin: 0;
        }
        .format-item input:checked + label { background: #667eea; color: white; border-color: #667eea; }

        /* Buttons */
        .button-group { display: flex; gap: 10px; margin-top: 4px; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-convert { background: linear-gradient(135deg,#667eea,#764ba2); color: white; }
        .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: #f0f0f0; color: #333; }
        .spinner {
            display: none; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.4); border-top-color: white;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin-right: 6px; vertical-align: middle;
        }
        .spinner.on { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Progress */
        .progress-section { display: none; margin-top: 20px; }
        .progress-section.show { display: block; }
        .prog-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .prog-pct { font-weight: 700; color: #667eea; }
        .prog-bar-bg { background: #eee; border-radius: 10px; height: 9px; overflow: hidden; }
        .prog-bar-fill {
            height: 100%; width: 0%; border-radius: 10px;
            background: linear-gradient(90deg,#667eea,#764ba2);
            transition: width 0.35s ease;
        }
        .prog-text { text-align: center; font-size: 12px; color: #666; margin-top: 8px; }
        .steps {
            display: flex; justify-content: space-around;
            margin-top: 14px; font-size: 11px; color: #aaa;
        }
        .step { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .step-dot {
            width: 28px; height: 28px; border-radius: 50%; background: #f0f0f0;
            display: flex; align-items: center; justify-content: center; font-size: 13px;
            transition: all 0.3s;
        }
        .step.done .step-dot { background: #667eea; color: white; }
        .step.active .step-dot {
            background: #667eea; color: white;
            animation: pulse 1.4s ease-in-out infinite;
        }
        @keyframes pulse {
            0%,100% { box-shadow: 0 0 0 0 rgba(102,126,234,.6); }
            50% { box-shadow: 0 0 0 8px rgba(102,126,234,0); }
        }

        /* Result */
        .result-section { display: none; margin-top: 24px; padding-top: 24px; border-top: 2px solid #f0f0f0; }
        .result-section.show { display: block; }
        .result-box { background: #f8f9ff; padding: 16px; border-radius: 8px; }
        audio { width: 100%; margin: 10px 0; }
        .dl-btn {
            display: inline-block; padding: 9px 18px; background: #667eea;
            color: white; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 600;
        }

        /* Messages */
        .msg { display: none; padding: 11px 14px; border-radius: 8px; margin-bottom: 14px; font-size: 13px; }
        .msg.show { display: block; }
        .msg.ok   { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .msg.err  { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .msg.warn { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }

        /* ‚îÄ‚îÄ DEBUG PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .debug-toggle {
            display: block; text-align: center; margin-top: 20px;
            font-size: 12px; color: #aaa; cursor: pointer; text-decoration: underline;
        }
        .debug-panel {
            display: none; margin-top: 12px; background: #1a1a2e;
            border-radius: 8px; padding: 12px; font-size: 11px;
            color: #a0e0a0; font-family: monospace; max-height: 260px; overflow-y: auto;
        }
        .debug-panel.show { display: block; }
        .debug-panel .d-line { border-bottom: 1px solid #2a2a4a; padding: 2px 0; }
        .debug-panel .d-ok  { color: #6aff6a; }
        .debug-panel .d-err { color: #ff6a6a; }
        .debug-panel .d-warn{ color: #ffd700; }
        .debug-panel .d-info{ color: #6adfff; }
        .diag-btn {
            display: block; width: 100%; margin-top: 8px; padding: 8px;
            background: #2a2a4a; color: #a0e0a0; border: 1px solid #444;
            border-radius: 6px; font-size: 12px; cursor: pointer; font-family: monospace;
        }

        @media (max-width: 480px) {
            .container { padding: 16px; }
            .button-group { flex-direction: column; }
            .steps { gap: 8px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üéµ Chuy·ªÉn ƒê·ªïi √Çm Thanh</h1>
    <p class="subtitle">T∆∞∆°ng th√≠ch iOS Safari ƒë·ªùi th·∫•p</p>

    <div id="msg" class="msg"></div>

    <div class="file-input-wrapper">
        <input type="file" id="audioFile"
            accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,.aiff,.wma,audio/*">
        <div class="file-input-visual">
            <div class="icon">üìÅ</div>
            <div class="hint">Nh·∫•n ƒë·ªÉ ch·ªçn file √¢m thanh</div>
        </div>
    </div>
    <div id="fileName"></div>
    <div class="info-text">MP3, WAV, M4A, AAC, FLAC...</div>
    <div class="ios-note" id="iosNote">
        üì± iOS: Nh·∫•n ‚Üí <strong>Browse</strong> ‚Üí ch·ªçn file trong <strong>Files</strong>
    </div>

    <div class="format-group" style="margin-top:16px;">
        <div class="format-item">
            <input type="radio" id="f_mp3" name="fmt" value="mp3">
            <label for="f_mp3">MP3</label>
        </div>
        <div class="format-item">
            <input type="radio" id="f_wav" name="fmt" value="wav" checked>
            <label for="f_wav">WAV</label>
        </div>
        <div class="format-item">
            <input type="radio" id="f_ogg" name="fmt" value="ogg">
            <label for="f_ogg">OGG</label>
        </div>
        <div class="format-item">
            <input type="radio" id="f_m4a" name="fmt" value="m4a">
            <label for="f_m4a">M4A</label>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-convert" id="convertBtn" disabled>
            <span class="spinner" id="spinner"></span>
            <span id="btnTxt">Chuy·ªÉn ƒê·ªïi</span>
        </button>
        <button class="btn-reset" id="resetBtn">ƒê·∫∑t L·∫°i</button>
    </div>

    <div class="progress-section" id="progSection">
        <div class="prog-header">
            <span>Ti·∫øn ƒë·ªô</span>
            <span class="prog-pct" id="progPct">0%</span>
        </div>
        <div class="prog-bar-bg"><div class="prog-bar-fill" id="progBar"></div></div>
        <div class="prog-text" id="progTxt">...</div>
        <div class="steps">
            <div class="step" id="s1"><div class="step-dot">üìÇ</div><div>ƒê·ªçc</div></div>
            <div class="step" id="s2"><div class="step-dot">‚öôÔ∏è</div><div>Gi·∫£i m√£</div></div>
            <div class="step" id="s3"><div class="step-dot">üì¶</div><div>Xong</div></div>
        </div>
    </div>

    <div class="result-section" id="resultSection">
        <h2 style="font-size:16px;color:#333;margin-bottom:14px;">‚úì K·∫øt Qu·∫£</h2>
        <div class="result-box" id="resultBox"></div>
    </div>

    <!-- DEBUG PANEL -->
    <span class="debug-toggle" id="debugToggle">üîß Hi·ªán log debug</span>
    <div class="debug-panel" id="debugPanel">
        <div id="debugLog"></div>
        <button class="diag-btn" id="diagBtn">‚ñ∂ Ch·∫°y ki·ªÉm tra thi·∫øt b·ªã</button>
    </div>
</div>

<script>
(function(){
'use strict';

/* ‚îÄ‚îÄ DOM ‚îÄ‚îÄ */
var fileInput   = document.getElementById('audioFile');
var fileNameEl  = document.getElementById('fileName');
var convertBtn  = document.getElementById('convertBtn');
var resetBtn    = document.getElementById('resetBtn');
var spinner     = document.getElementById('spinner');
var btnTxt      = document.getElementById('btnTxt');
var msgEl       = document.getElementById('msg');
var progSection = document.getElementById('progSection');
var progBar     = document.getElementById('progBar');
var progPct     = document.getElementById('progPct');
var progTxt     = document.getElementById('progTxt');
var s1          = document.getElementById('s1');
var s2          = document.getElementById('s2');
var s3          = document.getElementById('s3');
var resultSec   = document.getElementById('resultSection');
var resultBox   = document.getElementById('resultBox');
var iosNote     = document.getElementById('iosNote');
var debugToggle = document.getElementById('debugToggle');
var debugPanel  = document.getElementById('debugPanel');
var debugLog    = document.getElementById('debugLog');
var diagBtn     = document.getElementById('diagBtn');

var selectedFile = null;
var blobUrls = [];
var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
if (isIOS) iosNote.style.display = 'block';

/* ‚îÄ‚îÄ Debug helpers ‚îÄ‚îÄ */
function dlog(text, type) {
    var line = document.createElement('div');
    line.className = 'd-line ' + (type ? 'd-' + type : 'd-info');
    var t = new Date();
    var ts = t.getHours() + ':' + pad2(t.getMinutes()) + ':' + pad2(t.getSeconds()) + '.' + String(t.getMilliseconds()).padStart(3,'0');
    line.textContent = '[' + ts + '] ' + text;
    debugLog.appendChild(line);
    debugPanel.scrollTop = debugPanel.scrollHeight;
    console.log('[DBG]', text);
}
function pad2(n){ return n < 10 ? '0'+n : n; }

debugToggle.addEventListener('click', function(){
    debugPanel.classList.toggle('show');
    debugToggle.textContent = debugPanel.classList.contains('show') ? 'üîß ·∫®n log debug' : 'üîß Hi·ªán log debug';
});

/* ‚îÄ‚îÄ Device diagnostics ‚îÄ‚îÄ */
diagBtn.addEventListener('click', function(){
    dlog('=== B·∫ÆT ƒê·∫¶U KI·ªÇM TRA THI·∫æT B·ªä ===', 'info');
    dlog('UserAgent: ' + navigator.userAgent, 'info');
    dlog('iOS detected: ' + isIOS, isIOS ? 'warn' : 'ok');

    var AudioCtx = window.AudioContext || window.webkitAudioContext;
    dlog('AudioContext: ' + (AudioCtx ? 'C√ì' : 'KH√îNG'), AudioCtx ? 'ok' : 'err');

    var OffCtx = window.OfflineAudioContext || window.webkitOfflineAudioContext;
    dlog('OfflineAudioContext: ' + (OffCtx ? 'C√ì' : 'KH√îNG'), OffCtx ? 'ok' : 'err');

    dlog('FileReader: ' + (window.FileReader ? 'C√ì' : 'KH√îNG'), window.FileReader ? 'ok' : 'err');
    dlog('URL.createObjectURL: ' + (URL && URL.createObjectURL ? 'C√ì' : 'KH√îNG'), 'ok');
    dlog('Blob: ' + (window.Blob ? 'C√ì' : 'KH√îNG'), window.Blob ? 'ok' : 'err');
    dlog('DataView: ' + (window.DataView ? 'C√ì' : 'KH√îNG'), window.DataView ? 'ok' : 'err');
    dlog('Float32Array: ' + (window.Float32Array ? 'C√ì' : 'KH√îNG'), window.Float32Array ? 'ok' : 'err');
    dlog('Promise: ' + (window.Promise ? 'C√ì' : 'KH√îNG'), window.Promise ? 'ok' : 'err');
    dlog('ArrayBuffer.slice: ' + (ArrayBuffer && ArrayBuffer.prototype && ArrayBuffer.prototype.slice ? 'C√ì' : 'KH√îNG'), 'info');
    dlog('File.prototype.arrayBuffer: ' + (File && File.prototype && File.prototype.arrayBuffer ? 'C√ì' : 'KH√îNG (iOS < 14)'), 'warn');

    /* Th·ª≠ t·∫°o AudioContext th·ª±c */
    if (AudioCtx) {
        try {
            var ctx = new AudioCtx();
            dlog('new AudioContext() ‚Üí OK, state=' + ctx.state + ', sr=' + ctx.sampleRate, 'ok');
            dlog('createScriptProcessor: ' + (typeof ctx.createScriptProcessor === 'function' ? 'C√ì' : 'KH√îNG'), 'info');
            dlog('createMediaElementSource: ' + (typeof ctx.createMediaElementSource === 'function' ? 'C√ì' : 'KH√îNG'), 'info');
            ctx.close();
        } catch(e) {
            dlog('new AudioContext() ‚Üí L·ªñI: ' + e.message, 'err');
        }
    }

    /* Th·ª≠ decode file dummy (1 byte WAV) */
    if (AudioCtx) {
        dlog('Th·ª≠ decodeAudioData v·ªõi WAV gi·∫£...', 'info');
        var ctx2;
        try { ctx2 = new AudioCtx(); } catch(e) {}
        if (ctx2) {
            /* WAV 44 byte h·ª£p l·ªá (mono, 1 sample, 44100Hz) */
            var wav = new Uint8Array([
                82,73,70,70,36,0,0,0,87,65,86,69,
                102,109,116,32,16,0,0,0,1,0,1,0,68,172,0,0,136,88,1,0,2,0,16,0,
                100,97,116,97,2,0,0,0,0,0
            ]);
            var ab = wav.buffer.slice(0);
            var done2 = false;
            var t = setTimeout(function(){
                if (done2) return; done2 = true;
                dlog('decodeAudioData WAV gi·∫£ ‚Üí TIMEOUT (30s) ‚Äî ƒë√¢y l√† v·∫•n ƒë·ªÅ!', 'err');
                try { ctx2.close(); } catch(e) {}
            }, 30000);
            var resume = ctx2.state === 'suspended' && ctx2.resume ? ctx2.resume() : Promise.resolve();
            resume['catch'](function(){}).then(function(){
                try {
                    ctx2.decodeAudioData(ab, function(buf){
                        if (done2) return; done2 = true;
                        clearTimeout(t);
                        dlog('decodeAudioData WAV gi·∫£ ‚Üí OK (' + buf.length + ' samples, sr=' + buf.sampleRate + ')', 'ok');
                        try { ctx2.close(); } catch(e) {}
                    }, function(e){
                        if (done2) return; done2 = true;
                        clearTimeout(t);
                        dlog('decodeAudioData WAV gi·∫£ ‚Üí l·ªói callback: ' + (e&&e.message||e), 'err');
                        try { ctx2.close(); } catch(e2) {}
                    });
                } catch(ex) {
                    clearTimeout(t);
                    dlog('decodeAudioData throw: ' + ex.message, 'err');
                }
            });
        }
    }

    dlog('=== KI·ªÇM TRA XONG (decodeAudioData ƒëang ch·∫°y n·ªÅn) ===', 'info');
});

/* ‚îÄ‚îÄ File handling ‚îÄ‚îÄ */
fileInput.addEventListener('change', function(){
    var f = this.files && this.files[0];
    if (!f) return;
    var ext = (f.name||'').split('.').pop().toLowerCase();
    var ok = (f.type && f.type.startsWith('audio/')) ||
             ['mp3','wav','ogg','m4a','flac','aac','aiff','wma'].indexOf(ext) !== -1;
    if (!ok) { showMsg('Ch·ªçn file √¢m thanh h·ª£p l·ªá.', 'err'); return; }
    selectedFile = f;
    fileNameEl.textContent = '‚úì ' + f.name + ' (' + (f.size/1024).toFixed(0) + ' KB)';
    convertBtn.disabled = false;
    hideMsg();
    resultSec.classList.remove('show');
    progSection.classList.remove('show');
    dlog('File ch·ªçn: ' + f.name + ' | type=' + f.type + ' | size=' + f.size + ' bytes', 'info');
});

convertBtn.addEventListener('click', function(){
    if (!selectedFile) return;
    var fmt = document.querySelector('input[name="fmt"]:checked');
    doConvert(selectedFile, fmt ? fmt.value : 'wav');
});

resetBtn.addEventListener('click', function(){
    fileInput.value = '';
    selectedFile = null;
    fileNameEl.textContent = '';
    convertBtn.disabled = true;
    resultSec.classList.remove('show');
    progSection.classList.remove('show');
    hideMsg();
    blobUrls.forEach(function(u){ try { URL.revokeObjectURL(u); } catch(e){} });
    blobUrls = [];
});

/* ‚îÄ‚îÄ UI ‚îÄ‚îÄ */
function setP(pct, text, step){
    progBar.style.width = pct + '%';
    progPct.textContent = Math.round(pct) + '%';
    progTxt.textContent = text;
    [s1,s2,s3].forEach(function(s,i){
        s.classList.remove('active','done');
        if (step === undefined) return;
        if (i+1 < step) s.classList.add('done');
        if (i+1 === step) s.classList.add('active');
    });
}
function doneAll(){ [s1,s2,s3].forEach(function(s){ s.classList.remove('active'); s.classList.add('done'); }); }
function showMsg(t,type){ msgEl.textContent = t; msgEl.className = 'msg show ' + type; }
function hideMsg(){ msgEl.className = 'msg'; }
function setBusy(b){
    convertBtn.disabled = b;
    spinner.className = 'spinner' + (b ? ' on' : '');
    btnTxt.textContent = b ? 'ƒêang x·ª≠ l√Ω...' : 'Chuy·ªÉn ƒê·ªïi';
}
function mkUrl(blob){ var u = URL.createObjectURL(blob); blobUrls.push(u); return u; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CORE: FileReader (t∆∞∆°ng th√≠ch iOS 9+)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function readAsArrayBuffer(file){
    return new Promise(function(resolve, reject){
        dlog('FileReader.readAsArrayBuffer b·∫Øt ƒë·∫ßu...', 'info');
        var reader = new FileReader();
        var dead = false;
        var timer = setTimeout(function(){
            if (dead) return; dead = true;
            try { reader.abort(); } catch(e) {}
            dlog('FileReader TIMEOUT', 'err');
            reject(new Error('ƒê·ªçc file timeout'));
        }, 30000);

        reader.onprogress = function(e){
            if (e.lengthComputable)
                dlog('ƒê·ªçc: ' + Math.round(e.loaded/e.total*100) + '% (' + e.loaded + '/' + e.total + ')', 'info');
        };
        reader.onload = function(e){
            if (dead) return; dead = true;
            clearTimeout(timer);
            dlog('FileReader OK, k√≠ch th∆∞·ªõc buffer: ' + e.target.result.byteLength, 'ok');
            resolve(e.target.result);
        };
        reader.onerror = function(){
            if (dead) return; dead = true;
            clearTimeout(timer);
            dlog('FileReader l·ªói: ' + (reader.error && reader.error.message), 'err');
            reject(new Error('FileReader l·ªói: ' + (reader.error && reader.error.message)));
        };
        reader.readAsArrayBuffer(file);
    });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CORE: decodeAudioData
   S·ª≠ d·ª•ng callback-style ƒë·ªÉ t∆∞∆°ng th√≠ch iOS Safari c≈©.
   Timeout 25s ‚Äî n·∫øu iOS treo ‚Üí b√°o c·ª• th·ªÉ.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function decodeArrayBuffer(arrayBuffer){
    return new Promise(function(resolve, reject){
        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx){ reject(new Error('Kh√¥ng c√≥ AudioContext')); return; }

        var ctx;
        try { ctx = new AudioCtx(); }
        catch(e){ reject(new Error('T·∫°o AudioContext th·∫•t b·∫°i: ' + e.message)); return; }

        dlog('AudioContext state=' + ctx.state + ' sr=' + ctx.sampleRate, 'info');

        var dead = false;
        /* Fake-progress trong khi decode */
        var fakePct = 42;
        var fakeTimer = setInterval(function(){
            if (dead || fakePct >= 68) return;
            fakePct += 1;
            setP(fakePct, 'ƒêang gi·∫£i m√£ √¢m thanh... (iOS c√≥ th·ªÉ m·∫•t l√¢u)', 2);
        }, 600);

        var decodeTimer = setTimeout(function(){
            if (dead) return; dead = true;
            clearInterval(fakeTimer);
            try { ctx.close(); } catch(e) {}
            dlog('decodeAudioData TIMEOUT 25s ‚Äî iOS treo! Th·ª≠ ph∆∞∆°ng ph√°p B.', 'err');
            reject(new Error('DECODE_TIMEOUT'));
        }, 25000);

        function ok(buf){
            if (dead) return; dead = true;
            clearInterval(fakeTimer);
            clearTimeout(decodeTimer);
            try { ctx.close(); } catch(e) {}
            dlog('decodeAudioData OK: ' + buf.length + ' samples, ' + buf.numberOfChannels + 'ch, sr=' + buf.sampleRate, 'ok');
            resolve(buf);
        }
        function fail(e){
            if (dead) return; dead = true;
            clearInterval(fakeTimer);
            clearTimeout(decodeTimer);
            try { ctx.close(); } catch(e2) {}
            dlog('decodeAudioData l·ªói callback: ' + (e&&e.message||e), 'err');
            reject(new Error('DECODE_ERROR: ' + (e&&e.message||e)));
        }

        var resume = (ctx.state === 'suspended' && typeof ctx.resume === 'function')
                   ? ctx.resume() : Promise.resolve();
        resume['catch'](function(){ dlog('ctx.resume() th·∫•t b·∫°i (ti·∫øp t·ª•c th·ª≠)', 'warn'); }).then(function(){
            try {
                dlog('G·ªçi decodeAudioData...', 'info');
                var buf2 = arrayBuffer.slice ? arrayBuffer.slice(0) : arrayBuffer;
                var ret = ctx.decodeAudioData(buf2, ok, fail);
                if (ret && typeof ret.then === 'function'){
                    ret.then(function(b){ if (!dead) ok(b); })['catch'](function(e){ if (!dead) fail(e); });
                }
            } catch(ex){
                if (!dead){ dead = true; clearInterval(fakeTimer); clearTimeout(decodeTimer); reject(ex); }
            }
        });
    });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   PH∆Ø∆†NG PH√ÅP B: <audio> element + ScriptProcessorNode
   Bypass decodeAudioData ho√†n to√†n.
   iOS Safari d√πng native decoder khi ph√°t qua <audio>.
   Capture PCM real-time qua ScriptProcessor.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function captureViaAudioElement(file){
    return new Promise(function(resolve, reject){
        dlog('Ph∆∞∆°ng ph√°p B: AudioElement capture b·∫Øt ƒë·∫ßu', 'info');

        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx){ reject(new Error('B: Kh√¥ng c√≥ AudioContext')); return; }

        var objUrl = URL.createObjectURL(file);
        blobUrls.push(objUrl);

        var audio = new Audio();
        audio.setAttribute('playsinline', '');
        audio.setAttribute('webkit-playsinline', '');
        audio.crossOrigin = 'anonymous';
        audio.preload = 'auto';

        var liveCtx, source, processor;
        var chunks = [];
        var captured = 0;
        var sr = 44100;
        var dead = false;
        var started = false;

        var masterTimer = setTimeout(function(){
            if (dead) return; dead = true;
            cleanup();
            dlog('Ph∆∞∆°ng ph√°p B TIMEOUT 90s', 'err');
            reject(new Error('B: Timeout'));
        }, 90000);

        function cleanup(){
            clearTimeout(masterTimer);
            try { audio.pause(); audio.src = ''; } catch(e) {}
            try { if (processor) processor.disconnect(); } catch(e) {}
            try { if (source) source.disconnect(); } catch(e) {}
            try { if (liveCtx) liveCtx.close(); } catch(e) {}
        }

        audio.addEventListener('error', function(){
            if (dead || started) return; dead = true;
            cleanup();
            var code = audio.error ? audio.error.code : '?';
            dlog('B: audio error code=' + code, 'err');
            reject(new Error('B: audio l·ªói code=' + code));
        });

        function beginCapture(duration){
            if (dead || started) return;
            started = true;
            dlog('B: duration=' + duration + 's, b·∫Øt ƒë·∫ßu capture', 'info');

            try { liveCtx = new AudioCtx(); sr = liveCtx.sampleRate; }
            catch(e){ if (!dead){ dead=true; cleanup(); reject(new Error('B: ctx fail')); } return; }

            try { processor = liveCtx.createScriptProcessor(4096, 1, 1); }
            catch(e){ if (!dead){ dead=true; cleanup(); reject(new Error('B: processor fail')); } return; }

            var totalSamples = Math.ceil(duration * sr);
            var lastLogAt = 0;

            processor.onaudioprocess = function(e){
                if (dead) return;
                var data = e.inputBuffer.getChannelData(0);
                var copy = new Float32Array(data.length);
                copy.set(data);
                chunks.push(copy);
                captured += data.length;

                if (captured - lastLogAt > sr * 5){
                    lastLogAt = captured;
                    dlog('B: captured ' + (captured/sr).toFixed(1) + 's / ' + duration.toFixed(1) + 's', 'info');
                }

                var pct = 42 + Math.min(48, Math.round(captured / totalSamples * 48));
                setP(pct, 'ƒêang ghi √¢m thanh: ' + (captured/sr).toFixed(0) + 's / ' + duration.toFixed(0) + 's', 2);

                if (captured >= totalSamples) finish();
            };

            try {
                source = liveCtx.createMediaElementSource(audio);
                source.connect(processor);
                processor.connect(liveCtx.destination);
                dlog('B: MediaElementSource OK', 'ok');
            } catch(e){
                if (!dead){ dead=true; cleanup(); reject(new Error('B: source fail: ' + e.message)); }
                return;
            }

            var rp = (liveCtx.state === 'suspended' && liveCtx.resume) ? liveCtx.resume() : Promise.resolve();
            rp['catch'](function(){}).then(function(){
                audio.play()['catch'](function(e){
                    dlog('B: play() rejected: ' + e.message, 'err');
                    if (!dead){ dead=true; cleanup(); reject(new Error('B: play fail: ' + e.message)); }
                });
            });
        }

        function finish(){
            if (dead) return; dead = true;
            cleanup();

            if (chunks.length === 0){ reject(new Error('B: kh√¥ng capture ƒë∆∞·ª£c d·ªØ li·ªáu')); return; }

            var total = 0;
            for (var i=0;i<chunks.length;i++) total += chunks[i].length;
            dlog('B: ho√†n t·∫•t, t·ªïng ' + (total/sr).toFixed(1) + 's (' + total + ' samples)', 'ok');

            var merged = new Float32Array(total);
            var pos = 0;
            for (var j=0;j<chunks.length;j++){ merged.set(chunks[j],pos); pos+=chunks[j].length; }

            resolve({ numberOfChannels:1, sampleRate:sr, length:total,
                      getChannelData: function(){ return merged; } });
        }

        audio.addEventListener('ended', function(){ if (!dead && started) finish(); });
        audio.addEventListener('loadedmetadata', function(){
            var dur = audio.duration;
            dlog('B: loadedmetadata duration=' + dur, 'info');
            if (isFinite(dur) && dur > 0) beginCapture(dur);
        });
        audio.addEventListener('canplay', function(){
            var dur = audio.duration;
            dlog('B: canplay duration=' + dur, 'info');
            if (!started && isFinite(dur) && dur > 0) beginCapture(dur);
            else if (!started) beginCapture(600); /* fallback 10 ph√∫t */
        });

        dlog('B: g√°n src v√† load...', 'info');
        audio.src = objUrl;
        audio.load();
    });
}

/* ‚îÄ‚îÄ Encode WAV ‚îÄ‚îÄ */
function encodeWav(buf){
    var numCh = buf.numberOfChannels, sr = buf.sampleRate, len = buf.length;
    var out = new Float32Array(len);
    for (var c=0;c<numCh;c++){
        var ch = buf.getChannelData(c);
        for (var i=0;i<len;i++) out[i] += ch[i];
    }
    if (numCh>1) for (var j=0;j<len;j++) out[j] /= numCh;
    var ab = new ArrayBuffer(44+len*2), dv = new DataView(ab);
    function str(o,v){ for(var k=0;k<v.length;k++) dv.setUint8(o+k,v.charCodeAt(k)); }
    str(0,'RIFF'); dv.setUint32(4,36+len*2,true); str(8,'WAVE'); str(12,'fmt ');
    dv.setUint32(16,16,true); dv.setUint16(20,1,true); dv.setUint16(22,1,true);
    dv.setUint32(24,sr,true); dv.setUint32(28,sr*2,true);
    dv.setUint16(32,2,true); dv.setUint16(34,16,true); str(36,'data'); dv.setUint32(40,len*2,true);
    var off=44;
    for (var n=0;n<len;n++,off+=2){
        var x=Math.max(-1,Math.min(1,out[n]));
        dv.setInt16(off,x<0?x*0x8000:x*0x7FFF,true);
    }
    dlog('encodeWav OK: ' + (ab.byteLength/1024).toFixed(0) + ' KB', 'ok');
    return ab;
}

/* ‚îÄ‚îÄ Fallback: tr·∫£ nguy√™n file g·ªëc ‚îÄ‚îÄ */
function passThroughFallback(file, outName){
    return new Promise(function(resolve, reject){
        dlog('FALLBACK: tr·∫£ file g·ªëc', 'warn');
        var r = new FileReader();
        r.onload = function(e){
            var blob = new Blob([e.target.result], { type: file.type || 'audio/mpeg' });
            resolve({ url: mkUrl(blob), name: file.name, fallback: true });
        };
        r.onerror = function(){ reject(new Error('Fallback ƒë·ªçc file th·∫•t b·∫°i')); };
        r.readAsArrayBuffer(file);
    });
}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
function doConvert(file, fmt){
    setBusy(true); hideMsg();
    progSection.classList.add('show');
    resultSec.classList.remove('show');
    setP(5, 'Chu·∫©n b·ªã...', 1);

    /* M·ªü debug panel t·ª± ƒë·ªông ƒë·ªÉ user th·∫•y log */
    debugPanel.classList.add('show');
    debugToggle.textContent = 'üîß ·∫®n log debug';

    var base = file.name.lastIndexOf('.') > 0
             ? file.name.substring(0, file.name.lastIndexOf('.'))
             : file.name;
    var outName = base + '_converted.wav';

    dlog('=== B·∫ÆT ƒê·∫¶U CONVERT ===', 'info');
    dlog('File: ' + file.name + ' (' + (file.size/1024).toFixed(0) + 'KB, type=' + file.type + ')', 'info');
    dlog('Target: ' + fmt, 'info');
    dlog('iOS: ' + isIOS, isIOS ? 'warn' : 'info');

    /* Delay nh·ªè ƒë·ªÉ iOS render UI */
    setTimeout(function(){

    setP(10, 'ƒêang ƒë·ªçc file...', 1);

    /* B∆∞·ªõc 1: ƒë·ªçc file */
    readAsArrayBuffer(file).then(function(arrayBuffer){

        setP(38, 'ƒêang gi·∫£i m√£ (ph∆∞∆°ng ph√°p A)...', 2);
        dlog('Th·ª≠ ph∆∞∆°ng ph√°p A: decodeAudioData', 'info');

        /* B∆∞·ªõc 2A: decodeAudioData */
        return decodeArrayBuffer(arrayBuffer);

    }).then(function(audioBuf){

        dlog('Ph∆∞∆°ng ph√°p A th√†nh c√¥ng', 'ok');
        return finalize(audioBuf, outName);

    })['catch'](function(errA){

        dlog('Ph∆∞∆°ng ph√°p A th·∫•t b·∫°i: ' + errA.message + ' ‚Üí th·ª≠ B', 'warn');
        setP(42, 'Th·ª≠ ph∆∞∆°ng ph√°p B (audio element)...', 2);

        /* B∆∞·ªõc 2B: AudioElement capture */
        return captureViaAudioElement(file).then(function(buf){
            dlog('Ph∆∞∆°ng ph√°p B th√†nh c√¥ng', 'ok');
            return finalize(buf, outName);
        })['catch'](function(errB){
            dlog('Ph∆∞∆°ng ph√°p B th·∫•t b·∫°i: ' + errB.message + ' ‚Üí fallback', 'err');
            return passThroughFallback(file, outName);
        });

    }).then(function(result){

        if (!result) return; /* ƒë√£ x·ª≠ l√Ω trong finalize */
        if (result.fallback) showFallback(result);
        setBusy(false);

    })['catch'](function(e){
        dlog('L·ªói nghi√™m tr·ªçng: ' + e.message, 'err');
        showMsg('‚ùå ' + e.message, 'err');
        progSection.classList.remove('show');
        setBusy(false);
    });

    }, 200);
}

function finalize(audioBuf, outName){
    setP(72, 'M√£ ho√° WAV...', 2);
    return new Promise(function(resolve){
        setTimeout(function(){
            var wavData = encodeWav(audioBuf);
            setP(92, 'T·∫°o file...', 3);
            setTimeout(function(){
                var blob = new Blob([wavData], { type: 'audio/wav' });
                var url  = mkUrl(blob);
                doneAll();
                setP(100, 'Ho√†n th√†nh!');
                resultBox.innerHTML =
                    '<h3 style="margin-bottom:10px;font-size:14px;">üìÑ ' + outName + '</h3>' +
                    '<audio controls playsinline webkit-playsinline style="width:100%;margin:8px 0">' +
                    '<source src="' + url + '" type="audio/wav"></audio><br>' +
                    '<a href="' + url + '" download="' + outName + '" class="dl-btn">‚¨áÔ∏è T·∫£i v·ªÅ</a>';
                resultSec.classList.add('show');
                showMsg('‚úÖ Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!', 'ok');
                setTimeout(function(){ progSection.classList.remove('show'); }, 1800);
                setBusy(false);
                resolve(null);
            }, 50);
        }, 30);
    });
}

function showFallback(result){
    doneAll();
    setP(100, 'Xong (b·∫£n g·ªëc)');
    resultBox.innerHTML =
        '<div style="background:#fff3cd;color:#856404;padding:10px;border-radius:6px;font-size:12px;margin-bottom:12px;">' +
        '‚ö†Ô∏è <b>Kh√¥ng gi·∫£i m√£ ƒë∆∞·ª£c tr√™n thi·∫øt b·ªã n√†y.</b><br>' +
        'File b√™n d∆∞·ªõi l√† b·∫£n G·ªêC ch∆∞a ƒë·ªïi ƒë·ªãnh d·∫°ng.<br>' +
        'Ki·ªÉm tra log debug ƒë·ªÉ bi·∫øt l·ªói c·ª• th·ªÉ.<br>' +
        '<b>G·ª£i √Ω:</b> Th·ª≠ file MP3 128kbps ho·∫∑c WAV g·ªëc.</div>' +
        '<h3 style="font-size:14px;margin-bottom:10px;">üìÑ ' + result.name + '</h3>' +
        '<audio controls playsinline webkit-playsinline style="width:100%;margin:8px 0">' +
        '<source src="' + result.url + '" type="audio/mpeg"></audio><br>' +
        '<a href="' + result.url + '" download="' + result.name + '" class="dl-btn">‚¨áÔ∏è T·∫£i v·ªÅ b·∫£n g·ªëc</a>';
    resultSec.classList.add('show');
    showMsg('‚ö†Ô∏è Codec kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Xem log debug.', 'warn');
    progSection.classList.remove('show');
}

})();
</script>
</body>
</html>
