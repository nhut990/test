<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi ƒê·ªãnh D·∫°ng √Çm Thanh</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 25px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            cursor: pointer;
        }

        input[type="file"] {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0.01;
            cursor: pointer;
            z-index: 10;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .file-input-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 28px 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
            pointer-events: none;
            min-height: 90px;
            text-align: center;
        }

        .file-input-visual .icon { font-size: 32px; margin-bottom: 8px; }
        .file-input-visual .hint { color: #667eea; font-weight: 600; font-size: 14px; }
        .file-name { color: #667eea; font-weight: 600; margin-top: 8px; font-size: 13px; }
        .info-text { font-size: 12px; color: #666; margin-top: 8px; }

        .ios-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .format-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .format-item input[type="radio"] { display: none; }

        .format-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            font-weight: 500;
            font-size: 13px;
            -webkit-tap-highlight-color: transparent;
        }

        .format-item input[type="radio"]:checked + label {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .button-group { display: flex; gap: 10px; }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-convert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-convert:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.4);
        }

        .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: #f0f0f0; color: #333; }
        .btn-reset:hover { background: #e0e0e0; }

        .progress-section { margin-top: 25px; display: none; }
        .progress-section.show { display: block; }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .progress-percentage { font-weight: 700; color: #667eea; font-size: 16px; }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(102,126,234,0.5);
        }

        .progress-text { margin-top: 10px; text-align: center; color: #666; font-size: 13px; }

        .progress-steps {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }

        .step { display: flex; flex-direction: column; align-items: center; gap: 5px; }

        .step-icon {
            width: 30px; height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step.completed .step-icon { background-color: #667eea; color: white; }
        .step.active .step-icon {
            background-color: #667eea; color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102,126,234,0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102,126,234,0); }
        }

        .result-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }
        .result-section.show { display: block; }

        .result-audio { background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .result-audio h3 { color: #333; margin-bottom: 10px; font-size: 14px; }
        audio { width: 100%; margin-bottom: 10px; }

        .download-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        .download-btn:hover { background: #764ba2; }

        .message { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 14px; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .spinner {
            display: none;
            width: 20px; height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        .spinner.show { display: inline-block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            .button-group { flex-direction: column; }
            .progress-steps { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üéµ Chuy·ªÉn ƒê·ªïi √Çm Thanh</h1>
    <p class="subtitle">Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c ƒë·ªãnh d·∫°ng √¢m thanh ph·ªï bi·∫øn</p>

    <div id="message" class="message"></div>

    <div class="form-group">
        <label>Ch·ªçn File √Çm Thanh</label>
        <label class="file-input-wrapper" for="audioFile">
            <input
                type="file"
                id="audioFile"
                name="audioFile"
                accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,.aiff,.wma,audio/*"
            >
            <div class="file-input-visual">
                <div class="icon">üìÅ</div>
                <div class="hint">Nh·∫•n ƒë·ªÉ ch·ªçn file √¢m thanh</div>
            </div>
        </label>
        <div class="file-name" id="fileName"></div>
        <div class="info-text">H·ªó tr·ª£: MP3, WAV, OGG, M4A, FLAC, AAC...</div>
        <div class="ios-note" id="iosNote">
            üì± iOS: Sau khi nh·∫•n ‚Üí ch·ªçn <strong>Browse</strong> ‚Üí t√¨m file trong <strong>Files / iCloud Drive / On My iPhone</strong>
        </div>
    </div>

    <div class="form-group">
        <label>ƒê·ªãnh D·∫°ng ƒê√≠ch</label>
        <div class="format-group">
            <div class="format-item">
                <input type="radio" id="fmt_mp3" name="format" value="mp3">
                <label for="fmt_mp3">MP3</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_wav" name="format" value="wav" checked>
                <label for="fmt_wav">WAV</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_ogg" name="format" value="ogg">
                <label for="fmt_ogg">OGG</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_m4a" name="format" value="m4a">
                <label for="fmt_m4a">M4A</label>
            </div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-convert" id="convertBtn" disabled>
            <span class="spinner" id="spinner"></span>
            <span id="btnText">Chuy·ªÉn ƒê·ªïi</span>
        </button>
        <button class="btn-reset" id="resetBtn">ƒê·∫∑t L·∫°i</button>
    </div>

    <div class="progress-section" id="progressSection">
        <div class="progress-label">
            <span>Ti·∫øn ƒë·ªô</span>
            <span class="progress-percentage" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">ƒêang kh·ªüi t·∫°o...</div>
        <div class="progress-steps">
            <div class="step" id="step1"><div class="step-icon">üìÇ</div><div>ƒê·ªçc File</div></div>
            <div class="step" id="step2"><div class="step-icon">‚öôÔ∏è</div><div>X·ª≠ L√Ω</div></div>
            <div class="step" id="step3"><div class="step-icon">üì¶</div><div>Ho√†n Th√†nh</div></div>
        </div>
    </div>

    <div class="result-section" id="resultSection">
        <h2 style="margin-bottom:20px;color:#333;font-size:18px;">‚úì K·∫øt Qu·∫£ Chuy·ªÉn ƒê·ªïi</h2>
        <div class="result-audio" id="resultAudio"></div>
    </div>
</div>

<script>
(function() {
    'use strict';

    var audioFileEl    = document.getElementById('audioFile');
    var fileNameEl     = document.getElementById('fileName');
    var convertBtn     = document.getElementById('convertBtn');
    var resetBtn       = document.getElementById('resetBtn');
    var resultSection  = document.getElementById('resultSection');
    var resultAudio    = document.getElementById('resultAudio');
    var messageEl      = document.getElementById('message');
    var spinnerEl      = document.getElementById('spinner');
    var btnTextEl      = document.getElementById('btnText');
    var progressSection= document.getElementById('progressSection');
    var progressBarEl  = document.getElementById('progressBar');
    var progressPctEl  = document.getElementById('progressPercent');
    var progressTxtEl  = document.getElementById('progressText');
    var step1El = document.getElementById('step1');
    var step2El = document.getElementById('step2');
    var step3El = document.getElementById('step3');
    var iosNote = document.getElementById('iosNote');

    var selectedFile = null;

    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) iosNote.style.display = 'block';

    // Drag & drop ‚Äî desktop only
    if (!isIOS) {
        var wrapper = document.querySelector('.file-input-wrapper');
        wrapper.addEventListener('dragover', function(e) { e.preventDefault(); });
        wrapper.addEventListener('drop', function(e) {
            e.preventDefault();
            var f = e.dataTransfer.files[0];
            if (f) processFile(f);
        });
    }

    audioFileEl.addEventListener('change', function() {
        var f = this.files && this.files[0];
        if (f) processFile(f);
    });

    function processFile(file) {
        var ext = ((file.name || '').split('.').pop() || '').toLowerCase();
        var audioExts = ['mp3','wav','ogg','m4a','flac','aac','aiff','wma','mp4','opus','webm'];
        var isAudio = (file.type && file.type.startsWith('audio/')) || audioExts.indexOf(ext) !== -1;
        if (!isAudio) {
            showMsg('Vui l√≤ng ch·ªçn file √¢m thanh h·ª£p l·ªá (MP3, WAV, M4A...)', 'error');
            audioFileEl.value = '';
            return;
        }
        selectedFile = file;
        fileNameEl.textContent = '‚úì ƒê√£ ch·ªçn: ' + file.name;
        convertBtn.disabled = false;
        hideMsg();
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
    }

    convertBtn.addEventListener('click', function() {
        if (!selectedFile) { showMsg('Vui l√≤ng ch·ªçn file √¢m thanh!', 'error'); return; }
        var fmt = document.querySelector('input[name="format"]:checked');
        if (!fmt) { showMsg('Vui l√≤ng ch·ªçn ƒë·ªãnh d·∫°ng ƒë√≠ch!', 'error'); return; }
        doConvert(selectedFile, fmt.value);
    });

    resetBtn.addEventListener('click', function() {
        audioFileEl.value = '';
        selectedFile = null;
        fileNameEl.textContent = '';
        convertBtn.disabled = true;
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
        hideMsg();
        document.getElementById('fmt_wav').checked = true;
    });

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setProgress(pct, text, stepN) {
        progressBarEl.style.width = pct + '%';
        progressPctEl.textContent = Math.round(pct) + '%';
        progressTxtEl.textContent = text;
        var steps = [step1El, step2El, step3El];
        steps.forEach(function(s, i) {
            s.classList.remove('active', 'completed');
            if (stepN === undefined) return;
            if (i + 1 < stepN)  s.classList.add('completed');
            if (i + 1 === stepN) s.classList.add('active');
        });
    }

    function sleep(ms) {
        return new Promise(function(r) { setTimeout(r, ms); });
    }

    function showMsg(text, type) {
        messageEl.textContent = text;
        messageEl.className = 'message show ' + (type || '');
    }
    function hideMsg() { messageEl.className = 'message'; }

    // ‚îÄ‚îÄ FIX #1: ƒê·ªçc file d√πng FileReader thay v√¨ file.arrayBuffer() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // file.arrayBuffer() KH√îNG ho·∫°t ƒë·ªông tr√™n iOS < 13 / Safari c≈©
    // FileReader t∆∞∆°ng th√≠ch t·ª´ iOS 6+
    function readFileAsArrayBuffer(file) {
        return new Promise(function(resolve, reject) {
            var reader = new FileReader();
            var done = false;

            var timer = setTimeout(function() {
                if (done) return;
                done = true;
                reader.abort();
                reject(new Error('ƒê·ªçc file qu√° l√¢u. Vui l√≤ng th·ª≠ l·∫°i.'));
            }, 30000);

            reader.onload = function(e) {
                if (done) return;
                done = true;
                clearTimeout(timer);
                resolve(e.target.result);
            };

            reader.onerror = function() {
                if (done) return;
                done = true;
                clearTimeout(timer);
                reject(new Error('Kh√¥ng th·ªÉ ƒë·ªçc file. Vui l√≤ng th·ª≠ file kh√°c.'));
            };

            reader.onabort = function() {
                if (done) return;
                done = true;
                clearTimeout(timer);
                reject(new Error('ƒê·ªçc file b·ªã h·ªßy.'));
            };

            try {
                reader.readAsArrayBuffer(file);
            } catch(e) {
                clearTimeout(timer);
                reject(e);
            }
        });
    }

    // ‚îÄ‚îÄ FIX #2: decodeAudioData d√πng callback-style + timeout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // iOS Safari c≈© ƒë√¥i khi treo v√¥ th·ªùi h·∫°n v·ªõi Promise-style
    function decodeAudio(ctx, arrayBuffer) {
        return new Promise(function(resolve, reject) {
            var done = false;

            // FIX #3: Clone arrayBuffer tr∆∞·ªõc khi decode
            // iOS Safari ƒë√¥i khi "ti√™u th·ª•" buffer khi truy·ªÅn v√†o,
            // d√πng slice(0) ƒë·ªÉ ƒë·∫£m b·∫£o buffer c√≤n nguy√™n v·∫πn
            var bufferToUse;
            try {
                bufferToUse = arrayBuffer.slice(0);
            } catch(e) {
                bufferToUse = arrayBuffer;
            }

            var timer = setTimeout(function() {
                if (done) return;
                done = true;
                reject(new Error(
                    'Gi·∫£i m√£ qu√° l√¢u (>30s). File c√≥ th·ªÉ qu√° l·ªõn ho·∫∑c codec kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. ' +
                    'H√£y th·ª≠ file MP3 ho·∫∑c WAV ti√™u chu·∫©n.'
                ));
            }, 30000);

            function onSuccess(buf) {
                if (done) return;
                done = true;
                clearTimeout(timer);
                resolve(buf);
            }

            function onError(err) {
                if (done) return;
                done = true;
                clearTimeout(timer);
                var msg = 'Kh√¥ng gi·∫£i m√£ ƒë∆∞·ª£c file √¢m thanh.';
                if (err && err.message) msg += ' (' + err.message + ')';
                msg += ' H√£y th·ª≠ file MP3 ho·∫∑c WAV thu·∫ßn t√∫y.';
                reject(new Error(msg));
            }

            try {
                // Callback-style: ctx.decodeAudioData(buffer, successCb, errorCb)
                // t∆∞∆°ng th√≠ch h∆°n Promise-style tr√™n iOS c≈©
                var result = ctx.decodeAudioData(bufferToUse, onSuccess, onError);

                // M·ªôt s·ªë browser hi·ªán ƒë·∫°i tr·∫£ v·ªÅ Promise ‚Äî x·ª≠ l√Ω c·∫£ hai
                if (result && typeof result.then === 'function') {
                    result.then(onSuccess).catch(onError);
                }
            } catch (e) {
                clearTimeout(timer);
                reject(e);
            }
        });
    }

    // ‚îÄ‚îÄ FIX #4: T·∫°o AudioContext ƒë√∫ng c√°ch cho iOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // iOS y√™u c·∫ßu AudioContext ƒë∆∞·ª£c t·∫°o trong user gesture handler
    // v√† ph·∫£i resume() tr∆∞·ªõc khi d√πng
    function createAudioContext() {
        return new Promise(function(resolve, reject) {
            var AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) {
                reject(new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Audio API. H√£y d√πng Safari ho·∫∑c Chrome m·ªõi h∆°n.'));
                return;
            }

            var ctx;
            try {
                // iOS Safari c≈© kh√¥ng h·ªó tr·ª£ options object trong constructor
                // ‚Üí th·ª≠ kh√¥ng c√≥ options tr∆∞·ªõc
                ctx = new AudioCtx();
            } catch(e) {
                reject(new Error('Kh√¥ng th·ªÉ kh·ªüi t·∫°o Audio Context: ' + e.message));
                return;
            }

            // iOS Safari t·ª± suspend context ngay sau khi t·∫°o
            // ph·∫£i resume() ƒë·ªÉ c√≥ th·ªÉ decode
            if (ctx.state === 'suspended') {
                ctx.resume().then(function() {
                    resolve(ctx);
                }).catch(function() {
                    // resume() th·∫•t b·∫°i nh∆∞ng v·∫´n th·ª≠ ti·∫øp
                    resolve(ctx);
                });
            } else {
                resolve(ctx);
            }
        });
    }

    // ‚îÄ‚îÄ Encode PCM ‚Üí WAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // FIX #5: H·ªó tr·ª£ c·∫£ mono v√† stereo (mix xu·ªëng mono n·∫øu c·∫ßn)
    function encodeWAV(audioBuf) {
        var numChannels = audioBuf.numberOfChannels;
        var sampleRate  = audioBuf.sampleRate;
        var length      = audioBuf.length;

        // L·∫•y d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ channels
        var channels = [];
        for (var c = 0; c < numChannels; c++) {
            channels.push(audioBuf.getChannelData(c));
        }

        // Mix xu·ªëng mono
        var samples = new Float32Array(length);
        for (var i = 0; i < length; i++) {
            var sum = 0;
            for (var c2 = 0; c2 < numChannels; c2++) {
                sum += channels[c2][i];
            }
            samples[i] = sum / numChannels;
        }

        var buf = new ArrayBuffer(44 + length * 2);
        var v   = new DataView(buf);

        function writeStr(off, s) {
            for (var i = 0; i < s.length; i++) v.setUint8(off + i, s.charCodeAt(i));
        }

        writeStr(0,  'RIFF');
        v.setUint32(4,  36 + length * 2, true);
        writeStr(8,  'WAVE');
        writeStr(12, 'fmt ');
        v.setUint32(16, 16,         true);  // chunk size
        v.setUint16(20, 1,          true);  // PCM
        v.setUint16(22, 1,          true);  // mono
        v.setUint32(24, sampleRate, true);
        v.setUint32(28, sampleRate * 2, true); // byte rate
        v.setUint16(32, 2,          true);  // block align
        v.setUint16(34, 16,         true);  // bits per sample
        writeStr(36, 'data');
        v.setUint32(40, length * 2, true);

        var off = 44;
        for (var i2 = 0; i2 < length; i2++, off += 2) {
            var x = Math.max(-1, Math.min(1, samples[i2]));
            v.setInt16(off, x < 0 ? x * 0x8000 : x * 0x7FFF, true);
        }

        return buf;
    }

    // ‚îÄ‚îÄ Main convert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function doConvert(file, targetFmt) {
        convertBtn.disabled = true;
        spinnerEl.classList.add('show');
        btnTextEl.textContent = 'ƒêang chuy·ªÉn ƒë·ªïi...';
        hideMsg();
        progressSection.classList.add('show');
        resultSection.classList.remove('show');

        var audioCtx = null;

        // D√πng Promise chain thay v√¨ async/await ƒë·ªÉ t∆∞∆°ng th√≠ch iOS c≈© h∆°n
        // (m·ªôt s·ªë iOS 9/10 kh√¥ng h·ªó tr·ª£ async/await k·ªÉ c·∫£ qua transpiler)

        setProgress(10, 'ƒêang ƒë·ªçc file...', 1);

        // T·∫°o AudioContext s·ªõm (trong user gesture) ‚Äî quan tr·ªçng v·ªõi iOS
        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (AudioCtx) {
            try { audioCtx = new AudioCtx(); } catch(e) {}
        }

        setTimeout(function() {

        readFileAsArrayBuffer(file)

        .then(function(arrayBuffer) {
            setProgress(35, 'ƒêang kh·ªüi t·∫°o b·ªô gi·∫£i m√£...', 2);

            if (!audioCtx) {
                var AudioCtxCls = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtxCls) throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Audio API');
                audioCtx = new AudioCtxCls();
            }

            // Resume n·∫øu b·ªã suspend (iOS hay l√†m v·∫≠y)
            var resumePromise;
            if (audioCtx.state === 'suspended' && typeof audioCtx.resume === 'function') {
                resumePromise = audioCtx.resume();
            } else {
                resumePromise = Promise.resolve();
            }

            return resumePromise.then(function() {
                setProgress(45, 'ƒêang gi·∫£i m√£ √¢m thanh... (c√≥ th·ªÉ m·∫•t v√†i gi√¢y)', 2);
                return decodeAudio(audioCtx, arrayBuffer);
            });
        })

        .then(function(audioBuf) {
            setProgress(72, 'ƒêang m√£ ho√° WAV...', 2);

            return new Promise(function(resolve) {
                setTimeout(function() {
                    var wavData = encodeWAV(audioBuf);
                    resolve(wavData);
                }, 50); // Nh∆∞·ªùng thread cho UI update
            });
        })

        .then(function(wavData) {
            setProgress(90, 'ƒêang t·∫°o file k·∫øt qu·∫£...', 3);

            return new Promise(function(resolve) {
                setTimeout(function() {
                    var blob = new Blob([wavData], { type: 'audio/wav' });
                    var url  = URL.createObjectURL(blob);
                    resolve(url);
                }, 100);
            });
        })

        .then(function(url) {
            setProgress(100, 'Ho√†n th√†nh!');
            step1El.classList.add('completed');
            step2El.classList.add('completed');
            step3El.classList.remove('active');
            step3El.classList.add('completed');

            var base = file.name.lastIndexOf('.') > 0
                     ? file.name.substring(0, file.name.lastIndexOf('.'))
                     : file.name;
            var outName = base + '_converted.wav';

            resultAudio.innerHTML =
                '<h3>File: ' + outName + '</h3>' +
                '<audio controls playsinline webkit-playsinline>' +
                '<source src="' + url + '" type="audio/wav">' +
                'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.</audio><br>' +
                '<a href="' + url + '" download="' + outName + '" class="download-btn">‚¨áÔ∏è T·∫£i v·ªÅ</a>';

            resultSection.classList.add('show');
            showMsg('‚úì Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!', 'success');

            setTimeout(function() { progressSection.classList.remove('show'); }, 1500);
        })

        .catch(function(err) {
            console.error('L·ªói chuy·ªÉn ƒë·ªïi:', err);
            showMsg('‚ùå ' + (err && err.message ? err.message : 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
            progressSection.classList.remove('show');
        })

        .then(function() {
            // finally block (always runs)
            if (audioCtx) { try { audioCtx.close(); } catch(e) {} audioCtx = null; }
            convertBtn.disabled = false;
            spinnerEl.classList.remove('show');
            btnTextEl.textContent = 'Chuy·ªÉn ƒê·ªïi';
        });

        }, 100); // Delay nh·ªè ƒë·ªÉ iOS render UI tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu x·ª≠ l√Ω n·∫∑ng
    }

})();
</script>
</body>
</html>
