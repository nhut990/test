<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phát YouTube (cố gắng chạy khi tắt màn hình)</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; padding: 20px; }
    label, input, button { display:block; margin:8px 0; }
    #playerWrap { margin-top: 12px; }
    #youtubeFrame { width: 320px; height: 180px; border: 1px solid #ddd; }
    .small { width: 1px; height: 1px; border: 0; } /* nếu muốn ẩn video */
    .controls { margin-top: 10px; }
    .hint { color: #555; font-size: 0.9em; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Phát YouTube (dán link / id)</h2>

  <label for="url">Dán link YouTube hoặc ID video:</label>
  <input id="url" placeholder="ví dụ: https://www.youtube.com/watch?v=dQw4w9WgXcQ hoặc dQw4w9WgXcQ" />

  <div class="controls">
    <button id="loadBtn">Tải video</button>
    <button id="playBtn" disabled>Play</button>
    <button id="pauseBtn" disabled>Tạm dừng</button>
    <label>
      <input type="checkbox" id="hideVideo" /> Ẩn video (chỉ nghe audio)
    </label>
  </div>

  <div id="playerWrap">
    <!-- IFrame sẽ được chèn ở đây -->
    <div id="playerContainer"></div>
  </div>

  <p class="hint">
    Hướng dẫn: dán link và nhấn "Tải video", sau đó nhấn Play bằng thao tác chạm để cấp quyền phát. Khóa màn hình để kiểm tra — kết quả phụ thuộc vào trình duyệt & thiết bị.
  </p>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // Utility: parse YouTube video ID từ URL hoặc ID trực tiếp
    function parseYouTubeID(input) {
      if (!input) return null;
      input = input.trim();
      // Nếu đúng dạng ID 11 ký tự (cơ bản)
      const idMatch = input.match(/^[a-zA-Z0-9_-]{11}$/);
      if (idMatch) return idMatch[0];

      // Các dạng URL phổ biến
      const urlMatch = input.match(
        /(?:youtu\.be\/|youtube(?:-nocookie)?\.com\/(?:watch\?.*v=|embed\/|v\/|shorts\/))([a-zA-Z0-9_-]{11})/
      );
      return urlMatch ? urlMatch[1] : null;
    }

    let player = null;
    let pendingVideoId = null;

    // Khi API YouTube sẵn sàng, hàm này sẽ gọi
    function onYouTubeIframeAPIReady() {
      // nothing initially; we'll tạo player khi có video
    }

    function createOrLoadPlayer(videoId) {
      pendingVideoId = videoId;
      const container = document.getElementById('playerContainer');

      if (!player) {
        // tạo iframe player
        player = new YT.Player(container, {
          height: '180',
          width: '320',
          videoId: videoId,
          playerVars: {
            enablejsapi: 1,
            origin: location.origin,
            rel: 0,
            playsinline: 1, // iOS inline playback
            modestbranding: 1,
            controls: 1
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
          }
        });
      } else {
        player.loadVideoById(videoId);
      }
    }

    function onPlayerReady(event) {
      document.getElementById('playBtn').disabled = false;
      document.getElementById('pauseBtn').disabled = false;

      // Thiết lập Media Session (nếu được hỗ trợ) để trình duyệt nhận dạng media
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: 'YouTube playback',
          artist: '',
        });
        navigator.mediaSession.setActionHandler('play', function() { player.playVideo(); });
        navigator.mediaSession.setActionHandler('pause', function() { player.pauseVideo(); });
      }
    }

    function onPlayerStateChange(e) {
      // bạn có thể cập nhật UI theo trạng thái nếu cần
      // YT.PlayerState.ENDED / PLAYING / PAUSED ...
    }

    function onPlayerError(e) {
      alert('Lỗi khi tải video YouTube. Vui lòng kiểm tra ID/link và thử lại.');
    }

    // DOM handlers
    document.getElementById('loadBtn').addEventListener('click', function() {
      const input = document.getElementById('url').value;
      const vid = parseYouTubeID(input);
      if (!vid) {
        alert('Không nhận diện được ID YouTube. Vui lòng dán link hợp lệ hoặc ID (11 ký tự).');
        return;
      }
      createOrLoadPlayer(vid);
    });

    document.getElementById('playBtn').addEventListener('click', function() {
      if (player && player.playVideo) {
        // Yêu cầu play phải là thao tác người dùng -> tốt để cho phép phát nền trên nhiều trình duyệt
        player.playVideo();
      }
    });

    document.getElementById('pauseBtn').addEventListener('click', function() {
      if (player && player.pauseVideo) {
        player.pauseVideo();
      }
    });

    document.getElementById('hideVideo').addEventListener('change', function(e) {
      const checked = e.target.checked;
      const frame = document.querySelector('#playerContainer iframe');
      if (!frame) return;
      if (checked) {
        frame.classList.add('small');
      } else {
        frame.classList.remove('small');
      }
    });

    // Thêm note: một số trình duyệt chỉ cho phép autoplay khi video muted; ở đây yêu cầu người dùng nhấn Play
  </script>
</body>
</html>
