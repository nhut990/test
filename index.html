<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi ƒê·ªãnh D·∫°ng √Çm Thanh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        /* ===== FIX IOS: Wrapper d√πng label thay v√¨ div ===== */
        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            cursor: pointer;
        }

        /* 
         * FIX IOS CH√çNH:
         * - Kh√¥ng d√πng opacity: 0 tr√™n iOS v√¨ Safari ·∫©n lu√¥n kh·∫£ nƒÉng tap
         * - D√πng position absolute + width/height 100% + opacity g·∫ßn 0 (0.01)
         * - QUAN TR·ªåNG: KH√îNG ƒë·∫∑t pointer-events: none tr√™n label b√™n trong
         */
        input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.01; /* iOS c·∫ßn > 0 ƒë·ªÉ nh·∫≠n tap event */
            cursor: pointer;
            z-index: 10;
            font-size: 16px; /* NgƒÉn iOS zoom khi focus */
            -webkit-appearance: none;
        }

        .file-input-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 28px 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
            pointer-events: none; /* visual layer kh√¥ng c·∫£n input ph√≠a tr√™n */
            min-height: 90px;
            text-align: center;
        }

        .file-input-visual .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .file-input-visual .hint {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-wrapper:hover .file-input-visual,
        .file-input-wrapper:active .file-input-visual {
            background-color: #f0f2ff;
            border-color: #764ba2;
        }

        .file-name {
            color: #667eea;
            font-weight: 600;
            margin-top: 8px;
            font-size: 13px;
        }

        .format-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .format-item {
            position: relative;
        }

        .format-item input[type="radio"] {
            display: none;
        }

        .format-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            font-weight: 500;
            font-size: 13px;
            -webkit-tap-highlight-color: transparent;
        }

        .format-item input[type="radio"]:checked + label {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .format-item label:hover,
        .format-item label:active {
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-convert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-convert:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-convert:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-reset {
            background: #f0f0f0;
            color: #333;
        }

        .btn-reset:hover {
            background: #e0e0e0;
        }

        .progress-section {
            margin-top: 25px;
            display: none;
        }

        .progress-section.show {
            display: block;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .progress-percentage {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step.completed .step-icon {
            background-color: #667eea;
            color: white;
        }

        .step.active .step-icon {
            background-color: #667eea;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .result-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-audio {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .result-audio h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        audio {
            width: 100%;
            margin-bottom: 10px;
        }

        .download-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #764ba2;
        }

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }

        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        .spinner.show { display: inline-block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Badge iOS hint */
        .ios-note {
            display: none;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        @media (max-width: 480px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            .format-group { grid-template-columns: repeat(2, 1fr); }
            .button-group { flex-direction: column; }
            .progress-steps { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Chuy·ªÉn ƒê·ªïi √Çm Thanh</h1>
        <p class="subtitle">Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c ƒë·ªãnh d·∫°ng √¢m thanh ph·ªï bi·∫øn</p>

        <div id="message" class="message"></div>

        <div class="form-group">
            <label>Ch·ªçn File √Çm Thanh</label>

            <!-- 
                FIX iOS: D√πng <label> l√†m wrapper thay v√¨ <div>
                ƒë·ªÉ iOS nh·∫≠n di·ªán v√πng tap ch√≠nh x√°c h∆°n.
                Input KH√îNG c√≥ pointer-events: none.
            -->
            <label class="file-input-wrapper" id="fileWrapper" for="audioFile">
                <input
                    type="file"
                    id="audioFile"
                    name="audioFile"
                    accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,.mp4,.aiff,.wma,audio/*"
                >
                <div class="file-input-visual" id="fileLabel">
                    <div class="icon">üìÅ</div>
                    <div class="hint">K√©o file v√†o ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn</div>
                </div>
            </label>

            <div class="file-name" id="fileName"></div>
            <div class="info-text">H·ªó tr·ª£: MP3, WAV, OGG, M4A, FLAC, AAC v√† nhi·ªÅu ƒë·ªãnh d·∫°ng kh√°c</div>
            <div class="ios-note" id="iosNote">
                üì± Tr√™n iOS: Ch·ªçn "Browse" ‚Üí "On My iPhone" ho·∫∑c iCloud Drive ƒë·ªÉ t√¨m file √¢m thanh.
            </div>
        </div>

        <div class="form-group">
            <label>ƒê·ªãnh D·∫°ng ƒê√≠ch</label>
            <div class="format-group">
                <div class="format-item">
                    <input type="radio" id="mp3" name="format" value="mp3">
                    <label for="mp3">MP3</label>
                </div>
                <div class="format-item">
                    <input type="radio" id="wav" name="format" value="wav">
                    <label for="wav">WAV</label>
                </div>
                <div class="format-item">
                    <input type="radio" id="ogg" name="format" value="ogg">
                    <label for="ogg">OGG</label>
                </div>
                <div class="format-item">
                    <input type="radio" id="m4a" name="format" value="m4a">
                    <label for="m4a">M4A</label>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-convert" id="convertBtn" disabled>
                <span class="spinner" id="spinner"></span>
                <span id="btnText">Chuy·ªÉn ƒê·ªïi</span>
            </button>
            <button class="btn-reset" id="resetBtn">ƒê·∫∑t L·∫°i</button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-label">
                <span>Ti·∫øn ƒë·ªô chuy·ªÉn ƒë·ªïi</span>
                <span class="progress-percentage" id="progressPercent">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">ƒêang kh·ªüi t·∫°o...</div>
            <div class="progress-steps">
                <div class="step completed" id="step1">
                    <div class="step-icon">‚úì</div>
                    <div>T·∫£i File</div>
                </div>
                <div class="step active" id="step2">
                    <div class="step-icon">‚öô</div>
                    <div>X·ª≠ L√Ω</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">üì¶</div>
                    <div>Ho√†n Th√†nh</div>
                </div>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <h2 style="margin-bottom: 20px; color: #333; font-size: 18px;">‚úì K·∫øt Qu·∫£ Chuy·ªÉn ƒê·ªïi</h2>
            <div class="result-audio" id="resultAudio"></div>
        </div>
    </div>

    <script>
        const audioFile = document.getElementById('audioFile');
        const fileWrapper = document.getElementById('fileWrapper');
        const fileName = document.getElementById('fileName');
        const convertBtn = document.getElementById('convertBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultSection = document.getElementById('resultSection');
        const resultAudio = document.getElementById('resultAudio');
        const messageEl = document.getElementById('message');
        const spinner = document.getElementById('spinner');
        const btnText = document.getElementById('btnText');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const iosNote = document.getElementById('iosNote');

        let selectedFile = null;

        // Ph√°t hi·ªán iOS ƒë·ªÉ hi·ªán h∆∞·ªõng d·∫´n
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
            iosNote.style.display = 'block';
        }

        // =============================================
        // FIX DRAG & DROP (ch·ªâ desktop, kh√¥ng can thi·ªáp iOS)
        // =============================================
        if (!isIOS) {
            fileWrapper.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            fileWrapper.addEventListener('dragleave', (e) => {
                e.preventDefault();
            });

            fileWrapper.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    processFile(files[0]);
                }
            });
        }

        // =============================================
        // FIX IOS: L·∫Øng nghe s·ª± ki·ªán change tr·ª±c ti·∫øp
        // iOS ch·ªâ trigger change khi user th·ª±c s·ª± ch·ªçn file
        // =============================================
        audioFile.addEventListener('change', function(e) {
            const file = this.files && this.files[0];
            if (file) {
                processFile(file);
            }
        });

        function processFile(file) {
            // iOS ƒë√¥i khi tr·∫£ v·ªÅ type r·ªóng ‚Üí ki·ªÉm tra c·∫£ extension
            const name = file.name || '';
            const ext = name.split('.').pop().toLowerCase();
            const audioExts = ['mp3','wav','ogg','m4a','flac','aac','aiff','wma','mp4','opus','webm'];
            const isAudioType = file.type && file.type.startsWith('audio/');
            const isAudioExt = audioExts.includes(ext);

            if (!isAudioType && !isAudioExt) {
                showMessage('Vui l√≤ng ch·ªçn m·ªôt file √¢m thanh h·ª£p l·ªá! (MP3, WAV, OGG, M4A...)', 'error');
                audioFile.value = '';
                return;
            }

            selectedFile = file;
            fileName.textContent = `‚úì ƒê√£ ch·ªçn: ${file.name}`;
            convertBtn.disabled = false;
            hideMessage();
            resultSection.classList.remove('show');
            progressSection.classList.remove('show');
        }

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) {
                showMessage('Vui l√≤ng ch·ªçn m·ªôt file √¢m thanh!', 'error');
                return;
            }
            const format = document.querySelector('input[name="format"]:checked');
            if (!format) {
                showMessage('Vui l√≤ng ch·ªçn ƒë·ªãnh d·∫°ng ƒë√≠ch!', 'error');
                return;
            }
            convertAudio(selectedFile, format.value);
        });

        resetBtn.addEventListener('click', () => {
            audioFile.value = '';
            selectedFile = null;
            fileName.textContent = '';
            convertBtn.disabled = true;
            resultSection.classList.remove('show');
            progressSection.classList.remove('show');
            hideMessage();
            document.querySelectorAll('input[name="format"]').forEach(r => r.checked = false);
            document.getElementById('mp3').checked = true;
        });

        function updateProgress(percentage, text, step) {
            progressBar.style.width = percentage + '%';
            progressPercent.textContent = Math.round(percentage) + '%';
            progressText.textContent = text;

            step1.classList.remove('active', 'completed');
            step2.classList.remove('active', 'completed');
            step3.classList.remove('active', 'completed');

            if (step >= 1) step1.classList.add('completed');
            if (step > 1 && step < 3) step2.classList.add('active');
            if (step >= 2 && step < 3) step2.classList.add('completed');
            if (step >= 3) step3.classList.add('active');
            if (step > 3) {
                step3.classList.remove('active');
                step3.classList.add('completed');
            }
        }

        async function convertAudio(file, targetFormat) {
            try {
                convertBtn.disabled = true;
                spinner.classList.add('show');
                btnText.textContent = 'ƒêang chuy·ªÉn ƒë·ªïi...';
                hideMessage();
                progressSection.classList.add('show');
                resultSection.classList.remove('show');

                updateProgress(10, 'ƒêang t·∫£i file...', 1);
                await sleep(500);

                updateProgress(25, 'ƒêang gi·∫£i m√£ √¢m thanh...', 2);
                const arrayBuffer = await file.arrayBuffer();

                updateProgress(40, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu √¢m thanh...', 2);
                await sleep(300);

                // FIX IOS: iOS y√™u c·∫ßu AudioContext ƒë∆∞·ª£c t·∫°o sau user gesture
                // v√† c·∫ßn resume() n·∫øu b·ªã suspended
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) {
                    throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Audio API');
                }
                const audioContext = new AudioCtx();

                // iOS Safari ƒë√¥i khi suspend context ngay sau khi t·∫°o
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                let audioBuffer;
                try {
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                } catch (decodeErr) {
                    // iOS kh√¥ng decode ƒë∆∞·ª£c m·ªôt s·ªë codec ‚Üí fallback
                    throw new Error(`Kh√¥ng th·ªÉ ƒë·ªçc file n√†y tr√™n thi·∫øt b·ªã c·ªßa b·∫°n. Th·ª≠ file MP3 ho·∫∑c WAV thu·∫ßn t√∫y.`);
                }

                updateProgress(60, 'ƒêang chuy·ªÉn ƒë·ªïi ƒë·ªãnh d·∫°ng...', 2);
                await sleep(400);

                updateProgress(75, 'ƒêang m√£ h√≥a file...', 2);
                const convertedData = encodeWAV(
                    audioBuffer.getChannelData(0),
                    audioBuffer.sampleRate
                );

                await sleep(300);
                updateProgress(90, 'ƒêang ho√†n t·∫•t...', 3);

                const blob = new Blob([convertedData], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);

                updateProgress(100, 'Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!', 4);
                await sleep(500);

                displayResult(url, targetFormat, file.name);
                showMessage('‚úì Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng!', 'success');

                setTimeout(() => progressSection.classList.remove('show'), 2000);

                audioContext.close();

            } catch (error) {
                console.error('L·ªói:', error);
                updateProgress(0, 'L·ªói: ' + error.message, 0);
                progressBar.style.width = '0%';
                showMessage('L·ªói khi chuy·ªÉn ƒë·ªïi: ' + error.message, 'error');
                setTimeout(() => progressSection.classList.remove('show'), 3000);
            } finally {
                convertBtn.disabled = false;
                spinner.classList.remove('show');
                btnText.textContent = 'Chuy·ªÉn ƒê·ªïi';
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, samples.length * 2, true);

            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
            }
            return buffer;
        }

        function displayResult(url, format, originalName) {
            const baseName = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            const newName = `${baseName}_converted.wav`;

            resultAudio.innerHTML = `
                <h3>File ƒë√£ chuy·ªÉn ƒë·ªïi: ${newName}</h3>
                <audio controls playsinline>
                    <source src="${url}" type="audio/wav">
                    Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
                </audio>
                <br>
                <a href="${url}" download="${newName}" class="download-btn">‚¨áÔ∏è T·∫£i v·ªÅ</a>
            `;
            resultSection.classList.add('show');
        }

        function showMessage(text, type) {
            messageEl.textContent = text;
            messageEl.className = `message show ${type}`;
        }

        function hideMessage() {
            messageEl.classList.remove('show');
        }

        // M·∫∑c ƒë·ªãnh ch·ªçn MP3
        document.getElementById('mp3').checked = true;
    </script>
</body>
</html>
