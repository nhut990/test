<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AudioForge ‚Äî Chuy·ªÉn ƒë·ªïi √¢m thanh</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --card: #16161f;
    --border: #2a2a3a;
    --accent: #00e5ff;
    --accent3: #7c3aed;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --success: #00d68f;
    --error: #ff4d6d;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none; z-index: 0;
  }

  .orb {
    position: fixed; border-radius: 50%;
    filter: blur(120px); pointer-events: none; z-index: 0;
    width: 500px; height: 500px;
  }
  .orb1 { background: rgba(0,229,255,0.05); top:-200px; left:-100px; }
  .orb2 { background: rgba(124,58,237,0.06); bottom:-200px; right:-100px; }

  .container {
    max-width: 820px;
    margin: 0 auto;
    padding: 48px 20px 80px;
    position: relative; z-index: 1;
  }

  /* Header */
  .header { text-align: center; margin-bottom: 44px; }

  .logo-pill {
    display: inline-flex; align-items: center; gap: 12px;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 50px; padding: 8px 20px; margin-bottom: 20px;
  }
  .logo-pill-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 16px;
  }
  .logo-pill-text {
    font-size: 17px; font-weight: 800; letter-spacing: -0.3px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }

  h1 {
    font-size: clamp(28px, 5vw, 44px); font-weight: 800;
    letter-spacing: -1.5px; line-height: 1.1; margin-bottom: 12px;
  }
  h1 .hl {
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .subtitle {
    font-family: 'Space Mono', monospace; font-size: 12px;
    color: var(--muted); letter-spacing: 2px; text-transform: uppercase;
  }

  .formats-bar {
    display: flex; justify-content: center; align-items: center;
    gap: 10px; flex-wrap: wrap; margin-bottom: 32px;
  }
  .fmt-badge {
    font-family: 'Space Mono', monospace; font-size: 11px;
    font-weight: 700; padding: 5px 14px; border-radius: 50px;
    letter-spacing: 1.5px; border: 1px solid; transition: transform 0.2s;
  }
  .fmt-badge:hover { transform: scale(1.07); }
  .fmt-badge.mp3 { color:#ff6b35; border-color:#ff6b3550; background:#ff6b3510; }
  .fmt-badge.wav { color:#00e5ff; border-color:#00e5ff50; background:#00e5ff10; }
  .fmt-badge.m4a { color:#a78bfa; border-color:#a78bfa50; background:#a78bfa10; }
  .fmt-badge.ogg { color:#00d68f; border-color:#00d68f50; background:#00d68f10; }
  .fmt-badge.aac { color:#f59e0b; border-color:#f59e0b50; background:#f59e0b10; }
  .arrow-sep { color: var(--border); font-size: 20px; }

  /* Loading banner */
  #loading-banner {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; padding: 40px; text-align: center; margin-bottom: 20px;
  }
  .loader-ring {
    width: 52px; height: 52px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin .9s linear infinite; margin: 0 auto 18px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .load-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
  .load-sub { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); }

  /* Drop zone */
  #drop-zone {
    border: 2px dashed var(--border); border-radius: 24px;
    padding: 60px 32px; text-align: center; cursor: pointer;
    transition: all .3s; background: var(--card);
    position: relative; overflow: hidden; margin-bottom: 20px;
    display: none;
  }
  #drop-zone::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,229,255,0.07) 0%, transparent 65%);
    pointer-events: none;
  }
  #drop-zone:hover, #drop-zone.drag-over {
    border-color: var(--accent);
    box-shadow: 0 0 50px rgba(0,229,255,0.12), inset 0 0 30px rgba(0,229,255,0.04);
    transform: translateY(-2px);
  }
  .dz-icon { font-size: 56px; display: block; margin-bottom: 16px; animation: float 3.5s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)rotate(-3deg)} 50%{transform:translateY(-10px)rotate(3deg)} }
  .dz-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
  .dz-sub { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); margin-bottom: 28px; line-height:1.8; }
  .browse-btn {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    color: #fff; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 15px;
    padding: 13px 32px; border-radius: 10px; cursor: pointer; border: none;
    transition: all .2s; box-shadow: 0 4px 20px rgba(0,229,255,0.2);
  }
  .browse-btn:hover { opacity:.88; transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,229,255,0.3); }
  input[type=file] { display: none; }

  /* Settings panel */
  .settings-panel {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 20px; padding: 28px; margin-bottom: 20px;
    display: none; animation: fadeUp .3s ease;
  }
  .settings-panel.visible { display: block; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .panel-label {
    font-family: 'Space Mono', monospace; font-size: 10px;
    letter-spacing: 2.5px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 14px;
  }

  .file-item {
    display: flex; align-items: center; gap: 12px;
    padding: 13px 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px;
    margin-bottom: 8px; transition: border-color .2s;
  }
  .file-item:hover { border-color: #3a3a52; }
  .file-icon { font-size: 22px; flex-shrink: 0; }
  .file-info { flex:1; min-width:0; }
  .file-name { font-weight:600; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .file-meta { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); margin-top:3px; }
  .file-status { font-family:'Space Mono',monospace; font-size:11px; flex-shrink:0; min-width:90px; text-align:right; }
  .s-wait { color:var(--muted); }
  .s-run  { color:var(--accent); animation:blink 1.2s ease-in-out infinite; }
  .s-done { color:var(--success); }
  .s-err  { color:var(--error); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }
  .rm-btn {
    background:none; border:none; color:var(--muted); cursor:pointer; font-size:16px;
    padding:4px 6px; border-radius:4px; transition:all .15s; flex-shrink:0; line-height:1;
  }
  .rm-btn:hover { color:var(--error); background:rgba(255,77,109,.1); }

  .add-more-wrap { margin-bottom: 20px; }
  .add-more-lbl {
    display: block; width: 100%; padding: 10px;
    border: 1px dashed var(--border); border-radius: 8px;
    color: var(--muted); font-family:'Syne',sans-serif; font-size:13px;
    text-align:center; cursor:pointer; transition:all .2s;
  }
  .add-more-lbl:hover { border-color:var(--accent); color:var(--accent); }

  .config-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;
  }
  @media(max-width:540px) { .config-grid { grid-template-columns:1fr; } }

  .cfg-label {
    display:block; font-family:'Space Mono',monospace; font-size:10px;
    letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;
  }
  .fmt-select {
    width:100%; background:var(--surface); color:var(--text);
    border:1px solid var(--border); border-radius:10px; padding:12px 16px;
    font-family:'Space Mono',monospace; font-size:14px; font-weight:700;
    cursor:pointer; outline:none; transition:border-color .2s; letter-spacing:1px;
  }
  .fmt-select:focus { border-color:var(--accent); }

  .q-group { display:flex; gap:6px; }
  .q-btn {
    flex:1; background:var(--surface); color:var(--muted);
    border:1px solid var(--border); border-radius:8px;
    padding:12px 8px; font-family:'Space Mono',monospace; font-size:11px;
    font-weight:700; cursor:pointer; transition:all .15s; letter-spacing:.5px;
  }
  .q-btn:hover { border-color:var(--accent); color:var(--accent); }
  .q-btn.active { background:var(--accent); color:#000; border-color:var(--accent); }

  .convert-btn {
    width:100%; padding:18px;
    background:linear-gradient(135deg, var(--accent), var(--accent3));
    color:#fff; border:none; border-radius:12px;
    font-family:'Syne',sans-serif; font-size:17px; font-weight:800;
    cursor:pointer; transition:all .2s; position:relative; overflow:hidden;
    box-shadow:0 4px 24px rgba(0,229,255,.2);
  }
  .convert-btn:disabled { opacity:.35; cursor:not-allowed; transform:none!important; box-shadow:none; }
  .convert-btn:not(:disabled):hover { opacity:.9; transform:translateY(-2px); box-shadow:0 10px 36px rgba(0,229,255,.3); }
  .convert-btn::after {
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);
    transition:left .6s;
  }
  .convert-btn:not(:disabled):hover::after { left:100%; }

  .prog-wrap {
    margin-top:14px; background:var(--surface);
    border-radius:6px; overflow:hidden; height:5px; display:none;
  }
  .prog-bar {
    height:100%; background:linear-gradient(90deg, var(--accent), var(--accent3));
    width:0%; transition:width .4s; box-shadow:0 0 10px var(--accent); border-radius:6px;
  }

  /* Log */
  #logEl {
    background:var(--surface); border:1px solid var(--border); border-radius:12px;
    padding:14px 18px; margin-top:18px; font-family:'Space Mono',monospace;
    font-size:11px; color:var(--muted); max-height:110px; overflow-y:auto;
    display:none; line-height:2;
  }
  #logEl.vis { display:block; }
  .l-ok { color:var(--success); }
  .l-err { color:var(--error); }
  .l-info { color:#7dd3fc; }

  /* Results */
  .results-panel {
    background:var(--card); border:1px solid rgba(0,214,143,.4); border-radius:20px;
    padding:28px; margin-top:20px; display:none; animation:fadeUp .3s ease;
    box-shadow:0 0 30px rgba(0,214,143,.06);
  }
  .results-panel.vis { display:block; }
  .result-item {
    display:flex; align-items:center; gap:12px; padding:14px 16px;
    background:var(--surface); border:1px solid var(--border); border-radius:10px; margin-bottom:8px;
  }
  .result-name { font-size:14px; font-weight:600; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .result-size { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); flex-shrink:0; }
  .dl-btn {
    display:inline-flex; align-items:center; gap:5px;
    background:var(--success); color:#000;
    font-family:'Space Mono',monospace; font-size:11px; font-weight:700;
    padding:8px 16px; border-radius:6px; text-decoration:none; flex-shrink:0; transition:all .2s;
  }
  .dl-btn:hover { opacity:.85; transform:translateY(-1px); }
  .dl-all-btn {
    width:100%; margin-top:14px; padding:14px; background:transparent;
    color:var(--success); border:1px solid var(--success); border-radius:10px;
    font-family:'Syne',sans-serif; font-size:15px; font-weight:700;
    cursor:pointer; transition:all .2s;
  }
  .dl-all-btn:hover { background:var(--success); color:#000; }

  .footer-note {
    font-family:'Space Mono',monospace; font-size:11px; color:var(--muted);
    text-align:center; margin-top:36px; line-height:2;
  }
  .footer-note .a { color:var(--accent); }

  ::-webkit-scrollbar { width:5px; }
  ::-webkit-scrollbar-track { background:var(--surface); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<div class="orb orb1"></div>
<div class="orb orb2"></div>

<div class="container">

  <div class="header">
    <div class="logo-pill">
      <div class="logo-pill-icon">üéõÔ∏è</div>
      <span class="logo-pill-text">AudioForge</span>
    </div>
    <h1>Chuy·ªÉn ƒë·ªïi <span class="hl">√¢m thanh</span><br>tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát</h1>
    <p class="subtitle" style="margin-top:12px">Kh√¥ng upload ¬∑ Kh√¥ng c√†i ƒë·∫∑t ¬∑ Ho√†n to√†n ri√™ng t∆∞</p>
  </div>

  <div class="formats-bar">
    <span class="fmt-badge mp3">MP3</span>
    <span class="arrow-sep">‚áÑ</span>
    <span class="fmt-badge wav">WAV</span>
    <span class="arrow-sep">‚áÑ</span>
    <span class="fmt-badge m4a">M4A</span>
    <span class="arrow-sep">‚áÑ</span>
    <span class="fmt-badge ogg">OGG</span>
    <span class="arrow-sep">‚áÑ</span>
    <span class="fmt-badge aac">AAC</span>
  </div>

  <!-- Loading -->
  <div id="loading-banner">
    <div class="loader-ring"></div>
    <div class="load-title">ƒêang t·∫£i FFmpeg WebAssembly...</div>
    <div class="load-sub" id="load-sub">L·∫ßn ƒë·∫ßu t·∫£i ~25MB ¬∑ Vui l√≤ng ƒë·ª£i</div>
  </div>

  <!-- Drop zone -->
  <div id="drop-zone">
    <span class="dz-icon">üéµ</span>
    <div class="dz-title">K√©o &amp; th·∫£ file √¢m thanh v√†o ƒë√¢y</div>
    <div class="dz-sub">H·ªó tr·ª£: MP3 ¬∑ WAV ¬∑ M4A ¬∑ OGG ¬∑ AAC<br>Nhi·ªÅu file c√πng l√∫c ¬∑ T·ªëi ƒëa <strong style="color:var(--accent)">200MB</strong> m·ªói file</div>
    <label class="browse-btn" for="fi1">üìÇ Ch·ªçn file t·ª´ m√°y t√≠nh</label>
    <input type="file" id="fi1" accept=".mp3,.wav,.m4a,.ogg,.aac,audio/*" multiple>
  </div>

  <!-- Settings -->
  <div class="settings-panel" id="settings-panel">
    <div class="panel-label">üìã Danh s√°ch file</div>
    <div id="file-list"></div>
    <div class="add-more-wrap">
      <label class="add-more-lbl" for="fi2">Ôºã Th√™m file</label>
      <input type="file" id="fi2" accept=".mp3,.wav,.m4a,.ogg,.aac,audio/*" multiple>
    </div>

    <div class="config-grid">
      <div>
        <span class="cfg-label">ƒê·ªãnh d·∫°ng ƒë·∫ßu ra</span>
        <select class="fmt-select" id="out-fmt">
          <option value="mp3">üéµ MP3</option>
          <option value="wav">üåä WAV</option>
          <option value="m4a">üéß M4A</option>
          <option value="ogg">üü¢ OGG</option>
          <option value="aac">üî∂ AAC</option>
        </select>
      </div>
      <div>
        <span class="cfg-label">Ch·∫•t l∆∞·ª£ng</span>
        <div class="q-group">
          <button class="q-btn" data-q="low">Th·∫•p</button>
          <button class="q-btn active" data-q="medium">Trung b√¨nh</button>
          <button class="q-btn" data-q="high">Cao</button>
        </div>
      </div>
    </div>

    <button class="convert-btn" id="conv-btn" disabled>‚ö° B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>
    <div class="prog-wrap" id="prog-wrap"><div class="prog-bar" id="prog-bar"></div></div>
  </div>

  <div id="logEl"></div>

  <div class="results-panel" id="results-panel">
    <div class="panel-label" style="color:var(--success)">‚úÖ File ƒë√£ chuy·ªÉn ƒë·ªïi</div>
    <div id="results-list"></div>
    <button class="dl-all-btn" id="dl-all" style="display:none">‚¨á T·∫£i t·∫•t c·∫£ file</button>
  </div>

  <div class="footer-note">
    üîí File c·ªßa b·∫°n <span class="a">kh√¥ng r·ªùi kh·ªèi thi·∫øt b·ªã</span> ¬∑ X·ª≠ l√Ω 100% tr√™n tr√¨nh duy·ªát<br>
    H·ªó tr·ª£ t·ªëi ƒëa <span class="a">200MB/file</span> ¬∑ Chuy·ªÉn ƒë·ªïi nhi·ªÅu file c√πng l√∫c
  </div>
</div>

<script>
!function(){
  "use strict";

  var ffmpeg=null, ready=false, files=[], qual="medium", results=[], busy=false;

  function g(id){return document.getElementById(id);}

  function log(msg,t){
    var el=g("logEl");
    el.classList.add("vis");
    var d=document.createElement("div");
    d.className="l-"+(t||"info");
    d.textContent="‚Ä∫ "+msg;
    el.appendChild(d);
    el.scrollTop=el.scrollHeight;
  }

  function fmtBytes(b){
    if(!b)return"0 B";
    if(b<1024)return b+" B";
    if(b<1048576)return(b/1024).toFixed(1)+" KB";
    return(b/1048576).toFixed(1)+" MB";
  }

  function getExt(n){return n.split(".").pop().toLowerCase();}

  var ICONS={mp3:"üéµ",wav:"üåä",m4a:"üéß",ogg:"üü¢",aac:"üî∂"};

  function setProgress(p){g("prog-bar").style.width=Math.min(100,Math.max(0,p))+"%";}

  // File management
  function addFiles(arr){
    var added=0;
    for(var i=0;i<arr.length;i++){
      var f=arr[i], e=getExt(f.name);
      if(!["mp3","wav","m4a","ogg","aac"].includes(e)){log("B·ªè qua \""+f.name+"\": ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£","err");continue;}
      if(f.size>200*1024*1024){log("B·ªè qua \""+f.name+"\": v∆∞·ª£t 200MB","err");continue;}
      if(!files.some(function(x){return x.name===f.name&&x.size===f.size;})){files.push(f);added++;}
    }
    if(added){renderFiles();g("settings-panel").classList.add("visible");}
  }

  window.removeFile=function(i){
    files.splice(i,1); renderFiles();
    if(!files.length) g("settings-panel").classList.remove("visible");
  };

  function renderFiles(){
    var list=g("file-list"); list.innerHTML="";
    files.forEach(function(f,i){
      var e=getExt(f.name), ic=ICONS[e]||"üé∂";
      var d=document.createElement("div");
      d.className="file-item"; d.id="fi-"+i;
      d.innerHTML='<span class="file-icon">'+ic+'</span>'+
        '<div class="file-info">'+
          '<div class="file-name" title="'+f.name+'">'+f.name+'</div>'+
          '<div class="file-meta">'+fmtBytes(f.size)+' ¬∑ '+e.toUpperCase()+'</div>'+
        '</div>'+
        '<div class="file-status s-wait" id="fst-'+i+'">Ch·ªù</div>'+
        '<button class="rm-btn" onclick="removeFile('+i+')" title="X√≥a">‚úï</button>';
      list.appendChild(d);
    });
  }

  // Drag & drop
  var dz=g("drop-zone");
  dz.addEventListener("dragover",function(e){e.preventDefault();dz.classList.add("drag-over");});
  dz.addEventListener("dragleave",function(e){if(!dz.contains(e.relatedTarget))dz.classList.remove("drag-over");});
  dz.addEventListener("drop",function(e){e.preventDefault();dz.classList.remove("drag-over");addFiles([].slice.call(e.dataTransfer.files));});
  g("fi1").addEventListener("change",function(e){addFiles([].slice.call(e.target.files));e.target.value="";});
  g("fi2").addEventListener("change",function(e){addFiles([].slice.call(e.target.files));e.target.value="";});

  // Quality
  document.querySelectorAll(".q-btn").forEach(function(btn){
    btn.addEventListener("click",function(){
      document.querySelectorAll(".q-btn").forEach(function(b){b.classList.remove("active");});
      btn.classList.add("active"); qual=btn.dataset.q;
    });
  });

  // Build ffmpeg args
  var BR={
    mp3:{low:"96k",medium:"192k",high:"320k"},
    m4a:{low:"96k",medium:"192k",high:"256k"},
    aac:{low:"96k",medium:"192k",high:"256k"},
    ogg:{low:"1",medium:"5",high:"8"}
  };

  function buildArgs(inp,out,fmt,q){
    var a=["-i",inp];
    if(fmt==="mp3") a.push("-c:a","libmp3lame","-b:a",BR.mp3[q]);
    else if(fmt==="wav") a.push("-c:a","pcm_s16le");
    else if(fmt==="ogg") a.push("-c:a","libvorbis","-q:a",BR.ogg[q]);
    else if(fmt==="m4a") a.push("-c:a","aac","-b:a",BR.m4a[q]);
    else if(fmt==="aac") a.push("-c:a","aac","-b:a",BR.aac[q],"-f","adts");
    a.push(out);
    return a;
  }

  var MIME={mp3:"audio/mpeg",wav:"audio/wav",m4a:"audio/mp4",ogg:"audio/ogg",aac:"audio/aac"};

  // Convert
  g("conv-btn").addEventListener("click",async function(){
    if(!ready||busy||!files.length) return;
    busy=true;
    var btn=g("conv-btn"), fmt=g("out-fmt").value;
    btn.disabled=true; btn.textContent="‚è≥ ƒêang x·ª≠ l√Ω...";
    results=[];
    g("results-panel").classList.remove("vis");
    g("results-list").innerHTML="";
    g("logEl").innerHTML=""; g("logEl").classList.remove("vis");
    g("prog-wrap").style.display="block";
    setProgress(0);

    for(var i=0;i<files.length;i++){
      var f=files[i];
      var fst=g("fst-"+i);
      fst.className="file-status s-run"; fst.textContent="ƒêang x·ª≠ l√Ω...";

      var srcExt=getExt(f.name);
      var inName="inp_"+i+"."+srcExt;
      var outName="out_"+i+"."+fmt;
      var baseName=f.name.replace(/\.[^.]+$/,"");
      var dlName=baseName+"."+fmt;

      try{
        log("["+(i+1)+"/"+files.length+"] "+f.name+" ‚Üí "+fmt.toUpperCase(),"info");
        var buf=await f.arrayBuffer();
        await ffmpeg.writeFile(inName, new Uint8Array(buf));
        var args=buildArgs(inName,outName,fmt,qual);
        await ffmpeg.exec(args);
        var raw=await ffmpeg.readFile(outName);
        var blob=new Blob([raw.buffer],{type:MIME[fmt]});
        var url=URL.createObjectURL(blob);
        results.push({url:url,name:dlName,size:blob.size});
        fst.className="file-status s-done"; fst.textContent="‚úì Xong";
        log("‚úì "+dlName+" ¬∑ "+fmtBytes(blob.size),"ok");
        try{await ffmpeg.deleteFile(inName);}catch(x){}
        try{await ffmpeg.deleteFile(outName);}catch(x){}
      }catch(err){
        fst.className="file-status s-err"; fst.textContent="‚úï L·ªói";
        log("‚úï L·ªói: "+f.name+" ‚Äî "+(err.message||err),"err");
      }
      setProgress(Math.round(((i+1)/files.length)*100));
    }

    if(results.length){
      var rl=g("results-list"); rl.innerHTML="";
      results.forEach(function(r){
        var d=document.createElement("div"); d.className="result-item";
        d.innerHTML='<div class="result-name">üéµ '+r.name+'</div>'+
          '<div class="result-size">'+fmtBytes(r.size)+'</div>'+
          '<a class="dl-btn" href="'+r.url+'" download="'+r.name+'">‚¨á T·∫£i</a>';
        rl.appendChild(d);
      });
      g("results-panel").classList.add("vis");
      if(results.length>1){
        g("dl-all").style.display="block";
        g("dl-all").onclick=function(){
          results.forEach(function(r,idx){
            setTimeout(function(){
              var a=document.createElement("a");
              a.href=r.url; a.download=r.name;
              document.body.appendChild(a); a.click(); document.body.removeChild(a);
            },idx*600);
          });
        };
      }
    }

    btn.disabled=false; btn.textContent="‚ö° B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi"; busy=false;
  });

  // Load FFmpeg
  async function initFFmpeg(){
    var sub=g("load-sub");
    try{
      await new Promise(function(res,rej){
        var s=document.createElement("script");
        s.src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.js";
        s.crossOrigin="anonymous";
        s.onload=res;
        s.onerror=function(){rej(new Error("Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán FFmpeg. H√£y ki·ªÉm tra k·∫øt n·ªëi internet."));};
        document.head.appendChild(s);
      });

      sub.textContent="ƒêang kh·ªüi t·∫°o engine...";

      // UMD bundle exposes FFmpegWASM
      var FFmpegLib = window.FFmpegWASM || window["@ffmpeg/ffmpeg"];
      if(!FFmpegLib || !FFmpegLib.FFmpeg) throw new Error("FFmpeg module kh√¥ng load ƒë∆∞·ª£c");

      var ff=new FFmpegLib.FFmpeg();
      var CORE="https://unpkg.com/@ffmpeg/core@0.12.4/dist/umd/";

      sub.textContent="ƒêang t·∫£i core (~25MB)...";

      await ff.load({
        coreURL: CORE+"ffmpeg-core.js",
        wasmURL: CORE+"ffmpeg-core.wasm",
      });

      ffmpeg=ff; ready=true;
      g("loading-banner").style.display="none";
      g("drop-zone").style.display="block";
      g("conv-btn").disabled=false;
      log("FFmpeg WebAssembly s·∫µn s√†ng ‚úì","ok");

    }catch(err){
      g("loading-banner").innerHTML=
        '<div style="font-size:40px;margin-bottom:16px">‚ö†Ô∏è</div>'+
        '<div class="load-title" style="color:var(--error)">Kh√¥ng th·ªÉ t·∫£i FFmpeg</div>'+
        '<div class="load-sub" style="margin-top:10px;color:var(--error)">'+err.message+'</div>'+
        '<div class="load-sub" style="margin-top:10px">Y√™u c·∫ßu: Chrome 90+ / Firefox 90+ / Edge 90+<br>K·∫øt n·ªëi internet ƒë·ªÉ t·∫£i th∆∞ vi·ªán l·∫ßn ƒë·∫ßu</div>'+
        '<button onclick="location.reload()" style="margin-top:20px;padding:11px 28px;background:var(--accent);color:#000;border:none;border-radius:8px;font-family:Syne,sans-serif;font-weight:700;cursor:pointer;font-size:14px">üîÑ Th·ª≠ l·∫°i</button>';
      console.error("[AudioForge]",err);
    }
  }

  window.addEventListener("load",function(){setTimeout(initFFmpeg,80);});
}();
</script>
</body>
</html>
