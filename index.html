<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES Game Emulator - Nostalgist.js</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: #222;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .controls-section {
            padding: 15px;
            background: #2a2a2a;
            border-bottom: 2px solid #444;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            color: #ddd;
            font-size: 14px;
            font-weight: 600;
            min-width: 120px;
        }

        input[type="file"] {
            padding: 10px 12px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #333;
            color: #fff;
            font-size: 14px;
            flex: 1;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        input[type="file"]::file-selector-button:hover {
            background: #5568d3;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: #667eea;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #764ba2;
            min-width: 90px;
        }

        .btn-secondary:hover {
            background: #653a8a;
        }

        .btn-secondary:disabled {
            background: #999;
            cursor: not-allowed;
        }

        .emulator-section {
            padding: 15px;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 350px;
            flex: 1;
            gap: 15px;
        }

        #nostalgist-container {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        #nostalgist-container canvas {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .status-message {
            color: #ddd;
            text-align: center;
            font-size: 16px;
        }

        /* Mobile Controls */
        .mobile-controls {
            display: none;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            gap: 15px;
            flex-direction: column;
            width: 100%;
        }

        .mobile-controls.active {
            display: flex;
        }

        .d-pad-container {
            display: flex;
            justify-content: center;
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(3, 50px);
            gap: 8px;
            background: #333;
            padding: 10px;
            border-radius: 8px;
        }

        .d-pad button {
            padding: 0;
            font-size: 20px;
            min-width: auto;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #444;
            border-radius: 6px;
            transition: all 0.2s;
            active: active;
        }

        .d-pad button:active {
            background: #667eea;
            transform: scale(0.95);
        }

        .d-pad button:disabled {
            opacity: 0.5;
        }

        .d-pad .empty {
            background: transparent;
            cursor: default;
        }

        .d-pad .empty:active {
            background: transparent;
        }

        .action-buttons-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            width: 50px;
            height: 50px;
            padding: 0;
            font-size: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn:disabled {
            opacity: 0.5;
        }

        .btn-a {
            background: #ff6b6b;
        }

        .btn-a:hover {
            background: #ee5a52;
        }

        .btn-b {
            background: #ffd93d;
            color: #222;
        }

        .btn-b:hover {
            background: #ffcc1a;
        }

        .btn-start {
            background: #51cf66;
            width: auto;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .btn-start:hover {
            background: #37b24d;
        }

        .btn-select {
            background: #a78bfa;
            width: auto;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .btn-select:hover {
            background: #8b5cf6;
        }

        .info-section {
            padding: 15px;
            background: #2a2a2a;
            border-top: 2px solid #444;
            color: #ddd;
            font-size: 12px;
            line-height: 1.6;
        }

        .info-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            color: #667eea;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .controls-toggle {
            width: 100%;
            background: #667eea;
            padding: 10px;
            text-align: center;
            color: white;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .controls-toggle:hover {
            background: #5568d3;
        }

        .controls-toggle:disabled {
            background: #999;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 20px;
            }

            .header p {
                font-size: 11px;
            }

            .control-row {
                flex-direction: column;
                gap: 8px;
            }

            label {
                min-width: auto;
                width: 100%;
            }

            input[type="file"] {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
                gap: 8px;
            }

            .btn-primary,
            .btn-secondary {
                width: 100%;
                min-width: auto;
            }

            .emulator-section {
                min-height: 300px;
                padding: 10px;
            }

            .mobile-controls.active {
                gap: 12px;
                padding: 12px;
            }

            .d-pad {
                gap: 6px;
                padding: 8px;
            }

            .d-pad button {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .action-btn {
                width: 45px;
                height: 45px;
                font-size: 14px;
            }

            .action-buttons-container {
                gap: 8px;
            }

            .info-section {
                font-size: 11px;
            }
        }

        @media (max-width: 480px) {
            .controls-section {
                padding: 10px;
            }

            .button-group {
                gap: 6px;
            }

            .btn-primary,
            .btn-secondary {
                padding: 8px 12px;
                font-size: 12px;
            }

            .d-pad {
                grid-template-columns: repeat(3, 40px);
                grid-template-rows: repeat(3, 40px);
                gap: 4px;
            }

            .d-pad button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéÆ NES Emulator</h1>
            <p>Ch∆°i game NES c·ªï ƒëi·ªÉn tr√™n tr√¨nh duy·ªát</p>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="control-group">
                <!-- ROM File Input -->
                <div class="control-row">
                    <label>üìÅ Ch·ªçn ROM NES:</label>
                    <input type="file" id="romFile" accept=".nes" />
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button class="btn-primary" id="playButton" onclick="handlePlayRom()">
                        ‚ñ∂ Ch∆°i Game
                    </button>
                    <button class="btn-secondary" id="pauseButton" onclick="handlePause()" disabled>
                        ‚è∏ T·∫°m d·ª´ng
                    </button>
                    <button class="btn-secondary" id="resumeButton" onclick="handleResume()" disabled>
                        ‚ñ∂Ô∏è Ti·∫øp t·ª•c
                    </button>
                    <button class="btn-secondary" id="stopButton" onclick="handleStop()" disabled>
                        ‚èπ D·ª´ng
                    </button>
                </div>
            </div>
        </div>

        <!-- Emulator Display -->
        <div class="emulator-section">
            <div id="nostalgist-container" style="display: none;"></div>
            <div id="status" class="status-message">
                Ch·ªçn file NES ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i game
            </div>

            <!-- Mobile Controls -->
            <div class="mobile-controls" id="mobileControls">
                <!-- D-Pad -->
                <div class="d-pad-container">
                    <div class="d-pad">
                        <button class="empty"></button>
                        <button id="btnUp" onmousedown="pressKey('up')" onmouseup="releaseKey('up')" ontouchstart="pressKey('up')" ontouchend="releaseKey('up')" disabled>‚¨ÜÔ∏è</button>
                        <button class="empty"></button>
                        
                        <button id="btnLeft" onmousedown="pressKey('left')" onmouseup="releaseKey('left')" ontouchstart="pressKey('left')" ontouchend="releaseKey('left')" disabled>‚¨ÖÔ∏è</button>
                        <button class="empty"></button>
                        <button id="btnRight" onmousedown="pressKey('right')" onmouseup="releaseKey('right')" ontouchstart="pressKey('right')" ontouchend="releaseKey('right')" disabled>‚û°Ô∏è</button>
                        
                        <button class="empty"></button>
                        <button id="btnDown" onmousedown="pressKey('down')" onmouseup="releaseKey('down')" ontouchstart="pressKey('down')" ontouchend="releaseKey('down')" disabled>‚¨áÔ∏è</button>
                        <button class="empty"></button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons-container">
                    <button class="action-btn btn-b" id="btnB" onmousedown="pressKey('b')" onmouseup="releaseKey('b')" ontouchstart="pressKey('b')" ontouchend="releaseKey('b')" disabled>B</button>
                    <button class="action-btn btn-a" id="btnA" onmousedown="pressKey('a')" onmouseup="releaseKey('a')" ontouchstart="pressKey('a')" ontouchend="releaseKey('a')" disabled>A</button>
                </div>

                <!-- Start & Select -->
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn-select" id="btnSelect" onmousedown="pressKey('select')" onmouseup="releaseKey('select')" ontouchstart="pressKey('select')" ontouchend="releaseKey('select')" disabled>Select</button>
                    <button class="btn-start" id="btnStart" onmousedown="pressKey('start')" onmouseup="releaseKey('start')" ontouchstart="pressKey('start')" ontouchend="releaseKey('start')" disabled>Start</button>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="info-section">
            <h3>üìñ H∆∞·ªõng d·∫´n:</h3>
            <p>
                üí° <strong>B√†n ph√≠m (PC):</strong> Arrow keys (D-Pad), Z (B), X (A), Enter (Start), Shift (Select)<br>
                üì± <strong>Mobile:</strong> S·ª≠ d·ª•ng c√°c n√∫t ƒëi·ªÅu khi·ªÉn b√™n d∆∞·ªõi khi ch∆°i<br>
                ‚ö†Ô∏è <strong>L∆∞u √Ω:</strong> C·∫ßn file ROM NES h·ª£p ph√°p ho·∫∑c homebrew
            </p>
        </div>
    </div>

    <!-- Nostalgist.js Library t·ª´ CDN -->
    <script src="https://unpkg.com/nostalgist"></script>

    <script>
        let currentGame = null;
        let isPaused = false;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // H√†m x·ª≠ l√Ω ph√°t game
        async function handlePlayRom() {
            const romFile = document.getElementById('romFile');
            const status = document.getElementById('status');
            const container = document.getElementById('nostalgist-container');

            // Ki·ªÉm tra ƒë·∫ßu v√†o
            if (!romFile.files.length) {
                status.textContent = '‚ùå Vui l√≤ng ch·ªçn file ROM';
                return;
            }

            try {
                status.textContent = '‚è≥ ƒêang t·∫£i game...';
                status.className = 'status-message loading';
                disableControls(true);

                const rom = romFile.files[0];

                // Kh·ªüi ƒë·ªông tr√≤ ch∆°i NES
                currentGame = await Nostalgist.nes(rom, {
                    element: container,
                    retroarchConfig: {
                        rewind_enable: true,
                        turbo_enable: true,
                    }
                });

                // Hi·ªÉn th·ªã container
                container.style.display = 'block';
                status.style.display = 'none';
                status.className = 'status-message';

                // Hi·ªÉn th·ªã mobile controls
                document.getElementById('mobileControls').classList.add('active');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
                updateButtonStates(true);

                console.log('‚úÖ Game NES ƒë√£ t·∫£i th√†nh c√¥ng!');
            } catch (error) {
                console.error('L·ªói khi t·∫£i game:', error);
                status.textContent = `‚ùå L·ªói: ${error.message || 'Kh√¥ng th·ªÉ t·∫£i game. Vui l√≤ng ki·ªÉm tra file ROM.'}`;
                status.className = 'status-message';
                disableControls(false);
            }
        }

        // H√†m t·∫°m d·ª´ng
        async function handlePause() {
            if (currentGame && !isPaused) {
                try {
                    await currentGame.pause?.();
                    isPaused = true;
                    updateButtonStates(true);
                    console.log('‚è∏ Game ƒë√£ ƒë∆∞·ª£c t·∫°m d·ª´ng');
                } catch (error) {
                    console.error('L·ªói khi t·∫°m d·ª´ng:', error);
                }
            }
        }

        // H√†m ti·∫øp t·ª•c
        async function handleResume() {
            if (currentGame && isPaused) {
                try {
                    await currentGame.resume?.();
                    isPaused = false;
                    updateButtonStates(true);
                    console.log('‚ñ∂Ô∏è Game ƒë√£ ti·∫øp t·ª•c');
                } catch (error) {
                    console.error('L·ªói khi ti·∫øp t·ª•c:', error);
                }
            }
        }

        // H√†m d·ª´ng
        async function handleStop() {
            if (currentGame) {
                try {
                    await currentGame.stop?.();
                    currentGame = null;
                    isPaused = false;
                    
                    // ·∫®n emulator
                    document.getElementById('nostalgist-container').style.display = 'none';
                    document.getElementById('mobileControls').classList.remove('active');
                    const status = document.getElementById('status');
                    status.style.display = 'block';
                    status.textContent = 'Ch·ªçn file NES ƒë·ªÉ b·∫Øt ƒë·∫ßu ch∆°i game';
                    
                    updateButtonStates(false);
                    console.log('‚èπ Game ƒë√£ d·ª´ng');
                } catch (error) {
                    console.error('L·ªói khi d·ª´ng:', error);
                }
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t
        function updateButtonStates(isPlaying) {
            const playBtn = document.getElementById('playButton');
            const pauseBtn = document.getElementById('pauseButton');
            const resumeBtn = document.getElementById('resumeButton');
            const stopBtn = document.getElementById('stopButton');

            // Mobile control buttons
            const mobileButtons = [
                'btnUp', 'btnDown', 'btnLeft', 'btnRight',
                'btnA', 'btnB', 'btnStart', 'btnSelect'
            ];

            if (isPlaying) {
                playBtn.disabled = true;
                pauseBtn.disabled = isPaused;
                resumeBtn.disabled = !isPaused;
                stopBtn.disabled = false;
                
                // Enable mobile buttons
                mobileButtons.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            } else {
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
                stopBtn.disabled = true;
                
                // Disable mobile buttons
                mobileButtons.forEach(id => {
                    document.getElementById(id).disabled = true;
                });
            }
        }

        // V√¥ hi·ªáu h√≥a c√°c ƒëi·ªÅu khi·ªÉn
        function disableControls(disable) {
            document.getElementById('romFile').disabled = disable;
            document.getElementById('playButton').disabled = disable && !currentGame;
        }

        // X·ª≠ l√Ω ph√≠m mobile
        function pressKey(key) {
            if (!currentGame) return;
            
            const keyMap = {
                'up': 'up',
                'down': 'down',
                'left': 'left',
                'right': 'right',
                'a': 'a',
                'b': 'b',
                'start': 'start',
                'select': 'select'
            };

            currentGame.pressKey?.(keyMap[key]);
        }

        function releaseKey(key) {
            if (!currentGame) return;
            
            const keyMap = {
                'up': 'up',
                'down': 'down',
                'left': 'left',
                'right': 'right',
                'a': 'a',
                'b': 'b',
                'start': 'start',
                'select': 'select'
            };

            currentGame.releaseKey?.(keyMap[key]);
        }

        // Kh·ªüi t·∫°o tr·∫°ng th√°i n√∫t
        updateButtonStates(false);
    </script>
</body>
</html>
