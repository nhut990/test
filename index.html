<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ª£p √Çm Piano</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%; margin: 0 auto;
            background: white; border-radius: 15px;
            padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; color: #333; margin-bottom: 15px; font-size: 24px; }
        .chord-selector { margin-bottom: 20px; }
        .selector-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        select {
            flex: 1; min-width: 120px; padding: 10px; font-size: 16px;
            border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer;
        }
        .play-buttons { display: flex; gap: 10px; margin-bottom: 20px;}
        button {
            flex: 1; padding: 12px; font-size: 16px; font-weight: bold; border: none;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .play-sequential { background: #4CAF50; color: white; }
        .play-together { background: #2196F3; color: white; }
        button:active { transform: scale(0.95);}
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .audio-activate-wrapper {
            text-align:center;
            margin-bottom: 12px;
        }
        #audioActivateBtn {
            background: #ffd700;
            color:#333;
            padding: 6px 16px;
            border-radius: 100px;
            font-size: 14px;
            border: none;
            cursor:pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        #audioActivateBtn:disabled {
            opacity:.7;
            cursor:not-allowed;
        }
        .mute-warning {
            display: none;
            margin-top: 10px;
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }
        .mute-warning .actions { margin-top: 8px; display:flex; justify-content:center; gap:8px; }
        .mute-warning button { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; }
        .mute-warning .btn-ok { background:#667eea; color:white; }
        .piano {
            position: relative; display: flex; justify-content: flex-start;
            margin: 20px auto; height: 180px; overflow-x: auto; overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .piano-keys { 
            position: relative; 
            display: inline-flex; 
            white-space: nowrap; 
            min-width: min-content; 
            height: 180px;
            align-items: flex-start;
        }
        .key { position: relative; cursor: pointer; user-select: none; flex-shrink: 0; }
        .white-key {
            width: 28px; height: 180px; background: white; border: 1px solid #000;
            border-radius: 0 0 4px 4px; transition: all 0.1s; position: relative;
        }
        .white-key:active { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .white-key.highlight { background: #ffeb3b; box-shadow: 0 0 10px rgba(255,235,59,0.8);}
        .white-key.playing { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .black-key {
            width: 20px; height: 110px; background: #000; border: 1px solid #000;
            border-radius: 0 0 3px 3px; position: absolute; z-index: 10;
            top: 0;
        }
        .black-key:active { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .black-key.highlight { background: #ffd700; box-shadow: 0 0 10px rgba(255,215,0,0.8);}
        .black-key.playing { background: #ff5722; box-shadow: 0 0 15px rgba(255,87,34,0.9);}
        .key-label {
            position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);
            font-size: 10px; font-weight: bold; pointer-events: none;
        }
        .white-key .key-label { color: #666; }
        .black-key .key-label { color: white; bottom: 3px;}
        .chord-info {
            text-align: center; padding: 10px; background: #f5f5f5;
            border-radius: 8px; margin-top: 15px;
        }
        .chord-name { font-size: 20px; font-weight: bold; color: #667eea; margin-bottom: 5px;}
        .chord-notes { font-size: 14px; color: #666;}
        .footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            color: #999;
            font-size: 12px;
        }
        @media (max-width: 480px) {
            h1 { font-size: 20px; }
            .white-key { width: 24px; height: 150px;}
            .black-key { width: 16px; height: 90px;}
            .key-label { font-size: 8px;}
            .piano { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéπ H·ª£p √Çm Piano</h1>
        <div class="audio-activate-wrapper">
            <button id="audioActivateBtn">üîä B·∫≠t ti·∫øng</button>
            <div id="muteWarning" class="mute-warning" role="status" aria-live="polite">
                L∆∞u √Ω: N·∫øu iPhone ƒëang ·ªü ch·∫ø ƒë·ªô im l·∫∑ng (Silent), trang web c√≥ th·ªÉ kh√¥ng ph√°t √¢m thanh. Vui l√≤ng t·∫Øt ch·∫ø ƒë·ªô im l·∫∑ng ho·∫∑c chuy·ªÉn c√¥ng t·∫Øc b√™n h√¥ng sang ch·∫ø ƒë·ªô chu√¥ng.
                <div class="actions">
                    <button id="muteOk" class="btn-ok">ƒê√£ hi·ªÉu</button>
                </div>
            </div>
        </div>
        <div class="chord-selector">
            <div class="selector-row">
                <select id="rootNote">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="chordType">
                    <option value="major">Major (Tr∆∞·ªüng)</option>
                    <option value="minor">Minor (Th·ª©)</option>
                    <option value="7">7 (Dominant 7th)</option>
                    <option value="maj7">maj7 (Major 7th)</option>
                    <option value="m7">m7 (Minor 7th)</option>
                    <option value="dim">dim (Gi·∫£m)</option>
                    <option value="aug">aug (TƒÉng)</option>
                    <option value="sus2">sus2</option>
                    <option value="sus4">sus4</option>
                    <option value="6">6 (Major 6th)</option>
                    <option value="m6">m6 (Minor 6th)</option>
                </select>
            </div>
        </div>
        <div class="play-buttons">
            <button class="play-sequential" id="btnSequential">‚ñ∂ Ch·∫°y L·∫ßn L∆∞·ª£t</button>
            <button class="play-together" id="btnTogether">‚ñ∂ Ch·∫°y C√πng L√∫c</button>
        </div>
        <div class="piano">
            <div class="piano-keys" id="pianoKeys"></div>
        </div>
        <div class="chord-info">
            <div class="chord-name" id="chordName">C Major</div>
            <div class="chord-notes" id="chordNotes">C4 - E4 - G4</div>
        </div>
        <div class="footer">
            Created by Minh Nh·ª±t ¬© 2025
        </div>
    </div>
    <script>
        const AUDIO_BASE_URL = 'https://raw.githubusercontent.com/Nhut11790/nhut11790.github.io/main/tieng/acoustic_grand_piano-mp3/';
        const noteToFileName = {
            'C': 'C', 'C#': 'Db', 'D': 'D', 'D#': 'Eb', 'E': 'E', 'F': 'F',
            'F#': 'Gb', 'G': 'G', 'G#': 'Ab', 'A': 'A', 'A#': 'Bb', 'B': 'B'
        };
        const chordFormulas = {
            'major': [0, 4, 7],        'minor': [0, 3, 7],
            '7': [0, 4, 7, 10],        'maj7': [0, 4, 7, 11],
            'm7': [0, 3, 7, 10],       'dim': [0, 3, 6],
            'aug': [0, 4, 8],          'sus2': [0, 2, 7],
            'sus4': [0, 5, 7],         '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9]
        };
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        let currentChordNotes = [];
        let isPlaying = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBufferCache = {};
        let isAudioActivated = false;

        // iOS 15 fix: Source pool ƒë·ªÉ tr√°nh qu√° t·∫£i
        const maxActiveSources = 4;
        const activeSources = [];
        const pendingTimers = [];

        // B·∫£n ƒë·ªì ti·∫øng Vi·ªát c∆° b·∫£n cho n·ªët v√† lo·∫°i h·ª£p √¢m
        const baseNoteVn = { 'C':'ƒê√¥','D':'R√™','E':'Mi','F':'Fa','G':'Sol','A':'La','B':'Si' };
        const chordTypeVn = {
            'major': 'tr∆∞·ªüng','minor': 'th·ª©','7': '7','maj7': 'tr∆∞·ªüng 7',
            'm7': 'th·ª© 7','dim': 'dim/gi·∫£m','aug': 'tƒÉng','sus2':'sus2',
            'sus4':'sus4','6':'6','m6':'th·ª© 6'
        };

        // Detect iOS
        function isIos() {
            return /iP(hone|od|ad)/.test(navigator.platform) || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
        }

        const audioActivateBtn = document.getElementById('audioActivateBtn');
        const muteWarning = document.getElementById('muteWarning');
        const muteOk = document.getElementById('muteOk');

        muteOk.addEventListener('click', () => {
            muteWarning.style.display = 'none';
        });

        audioActivateBtn.addEventListener('click', async function() {
            audioActivateBtn.disabled = true;
            audioActivateBtn.textContent = "ƒêang b·∫≠t ti·∫øng...";
            try {
                await activateAudioOnIOS();
                audioActivateBtn.textContent = "√Çm thanh ƒë√£ b·∫≠t!";
                isAudioActivated = true;

                if (isIos()) {
                    muteWarning.style.display = 'block';
                }
            } catch (e) {
                audioActivateBtn.disabled = false;
                audioActivateBtn.textContent = "üîä B·∫≠t ti·∫øng (l·ªói, th·ª≠ l·∫°i)";
                alert("C√≥ l·ªói khi b·∫≠t ti·∫øng, h√£y th·ª≠ l·∫°i.");
            }
        });

        async function activateAudioOnIOS() {
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }

            try {
                const url = 'https://raw.githubusercontent.com/nhut990/files/refs/heads/main/tieng/E3_active_audio.mp3';
                const response = await fetch(url, {cache: 'no-cache'});
                if (response.ok) {
                    const buffer = await response.arrayBuffer();
                    const audioBuffer = await audioCtx.decodeAudioData(buffer.slice(0));
                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    source.start(0);
                    
                    addToActiveSources(source);
                    source.onended = () => {
                        removeFromActiveSources(source);
                    };
                    await new Promise(res => setTimeout(res, 500));
                    return;
                }
            } catch (err) {
                console.warn('Active audio fallback', err);
            }

            // Fallback: silent buffer
            try {
                const sampleRate = audioCtx.sampleRate || 44100;
                const length = Math.floor(sampleRate * 0.1);
                const buffer = audioCtx.createBuffer(1, length, sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < length; i++) data[i] = 0.0;

                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                const gain = audioCtx.createGain();
                gain.gain.value = 0.0001;
                source.connect(gain).connect(audioCtx.destination);

                addToActiveSources(source);
                source.onended = () => {
                    removeFromActiveSources(source);
                };

                source.start(0);
                await new Promise(res => setTimeout(res, 200));
            } catch (err) {
                console.error('activateAudioOnIOS fallback error', err);
            }
        }

        function addToActiveSources(source) {
            activeSources.push(source);
        }

        function removeFromActiveSources(source) {
            const idx = activeSources.indexOf(source);
            if (idx !== -1) activeSources.splice(idx, 1);
        }

        function stopExcessSources() {
            // iOS 15 fix: Stop oldest sources if we exceed max
            while (activeSources.length > maxActiveSources) {
                const oldSource = activeSources.shift();
                try {
                    oldSource.stop(0);
                } catch (e) {}
            }
        }

        async function loadAudioBuffer(noteName) {
            if (audioBufferCache[noteName]) return audioBufferCache[noteName];
            const note = noteName.slice(0, -1);
            const octave = noteName.slice(-1);
            const fileName = noteToFileName[note];
            const audioUrl = `${AUDIO_BASE_URL}${fileName}${octave}.mp3`;
            try {
                const response = await fetch(audioUrl);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer.slice(0));
                audioBufferCache[noteName] = audioBuffer;
                return audioBuffer;    
            } catch (error) {
                console.error('L·ªói t·∫£i √¢m thanh:', noteName, error);
                return null;
            }
        }

        async function preloadAllNotesBuffer() {
            const noteList = [];
            for (let octave = 3; octave <= 5; octave++) {
                for (let i = 0; i < 12; i++) {
                    noteList.push(notes[i] + octave);
                }
            }
            await Promise.all(noteList.map(note => loadAudioBuffer(note)));
        }

        function clearPendingActions() {
            while (pendingTimers.length) {
                const t = pendingTimers.pop();
                clearTimeout(t);
            }
            while (activeSources.length) {
                const src = activeSources.shift();
                try { src.stop(0); } catch (e) {}
            }
        }

        async function playNote(noteName, duration = 300, fromSequential = false) {
            try {
                if (audioCtx.state === 'suspended' || !isAudioActivated) {
                    audioActivateBtn.disabled = false;
                    audioActivateBtn.textContent = "üîä B·∫≠t ti·∫øng ƒë·ªÉ nghe h·ª£p √¢m!";
                    alert("Vui l√≤ng b·∫•m n√∫t B·∫≠t ti·∫øng ph√≠a tr√™n ƒë·ªÉ nghe ƒë∆∞·ª£c √¢m thanh h·ª£p √¢m!");
                    return;
                }

                // Ensure audio context is running
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                const audioBuffer = await loadAudioBuffer(noteName);
                if (!audioBuffer) return;

                // iOS 15 fix: Stop excess sources before creating new one
                stopExcessSources();

                const source = audioCtx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioCtx.destination);

                addToActiveSources(source);
                source.onended = () => {
                    removeFromActiveSources(source);
                };

                source.start(0);

                if (fromSequential) highlightKey(noteName, 'playing');
                if (fromSequential) {
                    const t = setTimeout(() => { highlightKey(noteName, 'highlight'); }, duration);
                    pendingTimers.push(t);
                }
            } catch (error) {
                console.error('L·ªói ph√°t √¢m thanh:', error);
            }
        }

        function highlightKey(noteName, className) {
            const key = document.querySelector(`[data-note="${noteName}"]`);
            if (key) {
                key.classList.remove('playing', 'highlight');
                if (className) key.classList.add(className);
            }
        }

        function getVietnameseRoot(root) {
            const hasSharp = root.includes('#');
            const hasFlat = root.includes('b');
            const base = root.replace('#','').replace('b','');
            const baseVn = baseNoteVn[base] || base;
            let suffix = '';
            if (hasSharp) suffix = ' thƒÉng';
            else if (hasFlat) suffix = ' gi√°ng';
            return baseVn + suffix;
        }

        function getChordNotes(root, chordType) {
            const rootIndex = notes.indexOf(root);
            const formula = chordFormulas[chordType];
            const chordNotes = [];
            let startOctave = 3;
            formula.forEach(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                const octaveOffset = Math.floor((rootIndex + interval) / 12);
                const octave = startOctave + octaveOffset;
                if (octave >= 3 && octave <= 5) {
                    chordNotes.push(notes[noteIndex] + octave);
                }
            });
            return chordNotes;
        }

        function createPiano() {
            const pianoKeys = document.getElementById('pianoKeys');
            pianoKeys.innerHTML = '';
            const isMobile = window.innerWidth <= 480;
            const whiteKeyWidth = isMobile ? 24 : 28;
            for (let octave = 3; octave <= 5; octave++) {
                const endIndex = (octave === 5) ? 0 : 11;
                for (let i = 0; i <= endIndex; i++) {
                    const note = notes[i];
                    const noteName = note + octave;
                    const isBlack = note.includes('#');
                    if (!isBlack) {
                        const whiteKeyContainer = document.createElement('div');
                        whiteKeyContainer.style.position = 'relative';
                        whiteKeyContainer.style.display = 'inline-flex';
                        whiteKeyContainer.style.width = whiteKeyWidth + 'px';
                        const whiteKey = document.createElement('div');
                        whiteKey.className = 'key white-key';
                        whiteKey.dataset.note = noteName;
                        const label = document.createElement('div');
                        label.className = 'key-label';
                        label.textContent = note.replace('#', '‚ôØ') + octave;
                        whiteKey.appendChild(label);

                        whiteKey.addEventListener('mousedown', async () => {
                            whiteKey.classList.remove('highlight');
                            whiteKey.classList.add('playing');
                            await playNote(noteName);
                        });
                        whiteKey.addEventListener('mouseup', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKey.addEventListener('mouseleave', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKey.addEventListener('touchstart', async (e) => {
                            e.preventDefault();
                            whiteKey.classList.remove('highlight');
                            whiteKey.classList.add('playing');
                            await playNote(noteName);
                        });
                        whiteKey.addEventListener('touchend', () => {
                            whiteKey.classList.remove('playing');
                            if (currentChordNotes.includes(noteName)) {
                                whiteKey.classList.add('highlight');
                            }
                        });
                        whiteKeyContainer.appendChild(whiteKey);

                        if (i < 11 && notes[i+1].includes('#') && note !== 'E' && note !== 'B') {
                            const blackKey = document.createElement('div');
                            blackKey.className = 'key black-key';
                            const blackNoteName = notes[i+1] + octave;
                            blackKey.dataset.note = blackNoteName;
                            blackKey.style.left = (whiteKeyWidth * 0.65) + 'px';
                            const blackLabel = document.createElement('div');
                            blackLabel.className = 'key-label';
                            blackLabel.textContent = notes[i+1].replace('#', '‚ôØ') + octave;
                            blackKey.appendChild(blackLabel);

                            blackKey.addEventListener('mousedown', async (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('highlight');
                                blackKey.classList.add('playing');
                                await playNote(blackNoteName);
                            });
                            blackKey.addEventListener('mouseup', (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            blackKey.addEventListener('mouseleave', () => {
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            blackKey.addEventListener('touchstart', async (e) => {
                                e.preventDefault(); e.stopPropagation();
                                blackKey.classList.remove('highlight');
                                blackKey.classList.add('playing');
                                await playNote(blackNoteName);
                            });
                            blackKey.addEventListener('touchend', (e) => {
                                e.stopPropagation();
                                blackKey.classList.remove('playing');
                                if (currentChordNotes.includes(blackNoteName)) {
                                    blackKey.classList.add('highlight');
                                }
                            });
                            whiteKeyContainer.appendChild(blackKey);
                        }
                        pianoKeys.appendChild(whiteKeyContainer);
                    }
                }
            }
        }

        function scrollChordIntoView() {
            if (!currentChordNotes.length) return;
            setTimeout(() => {
                const pianoContainer = document.querySelector('.piano');
                const noteElements = currentChordNotes
                    .map(note => document.querySelector(`[data-note="${note}"]`))
                    .filter(el => el !== null);
                if (noteElements.length) {
                    const positions = noteElements.map(el => {
                        const rect = el.getBoundingClientRect();
                        return pianoContainer.scrollLeft + rect.left - pianoContainer.getBoundingClientRect().left;
                    });
                    const leftEdge = Math.min(...positions);
                    const rightEdge = Math.max(...positions) + noteElements[0].offsetWidth;
                    const center = (leftEdge + rightEdge) / 2;
                    const containerWidth = pianoContainer.offsetWidth;
                    const scrollLeft = center - containerWidth / 2;
                    if (pianoContainer.scrollTo) {
                        pianoContainer.scrollTo({ left: scrollLeft, behavior: 'smooth' });
                    } else {
                        pianoContainer.scrollLeft = scrollLeft;
                    }
                }
            }, 50);
        }

        function updateChordDisplay() {
            clearPendingActions();
            const root = document.getElementById('rootNote').value;
            const chordType = document.getElementById('chordType').value;
            currentChordNotes = getChordNotes(root, chordType);
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('highlight','playing');
            });
            currentChordNotes.forEach(note => {
                const key = document.querySelector(`[data-note="${note}"]`);
                if (key) key.classList.add('highlight');
            });

            const chordNames = {
                'major': '', 'minor': 'm', '7': '7', 'maj7': 'maj7',
                'm7': 'm7', 'dim': 'dim', 'aug': 'aug', 'sus2': 'sus2',
                'sus4': 'sus4', '6': '6', 'm6': 'm6'
            };

            const displayRootWithSuffix = root + (chordNames[chordType] || '');
            const vnRoot = getVietnameseRoot(root);

            let displayVn = '';
            if (chordType === 'dim') {
                displayVn = `${vnRoot} dim/${vnRoot} gi·∫£m`;
            } else if (chordType === '7') {
                displayVn = `${vnRoot} 7`;
            } else {
                const vnType = chordTypeVn[chordType] || '';
                displayVn = (vnRoot + (vnType ? ' ' + vnType : '')).trim();
            }

            document.getElementById('chordName').textContent = `${displayRootWithSuffix} (${displayVn})`;
            document.getElementById('chordNotes').textContent = currentChordNotes.map(n => n.replace('#', '‚ôØ')).join(' - ');
            scrollChordIntoView();
        }

        async function playSequential() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('btnSequential').disabled = true;
            document.getElementById('btnTogether').disabled = true;
            for (let i = 0; i < currentChordNotes.length; i++) {
                await playNote(currentChordNotes[i], 440, true);
                await new Promise(resolve => setTimeout(resolve, 450));
            }
            isPlaying = false;
            document.getElementById('btnSequential').disabled = false;
            document.getElementById('btnTogether').disabled = false;
        }

        async function playTogether() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('btnSequential').disabled = true;
            document.getElementById('btnTogether').disabled = true;
            currentChordNotes.forEach(note => highlightKey(note, 'playing'));
            await Promise.all(currentChordNotes.map(note => playNote(note, 800)));
            const t = setTimeout(() => {
                currentChordNotes.forEach(note => highlightKey(note, 'highlight'));
                isPlaying = false;
                document.getElementById('btnSequential').disabled = false;
                document.getElementById('btnTogether').disabled = false;
            }, 800);
            pendingTimers.push(t);
        }

        document.getElementById('rootNote').addEventListener('change', updateChordDisplay);
        document.getElementById('chordType').addEventListener('change', updateChordDisplay);
        document.getElementById('btnSequential').addEventListener('click', playSequential);
        document.getElementById('btnTogether').addEventListener('click', playTogether);

        function handleResize() {
            createPiano();
            updateChordDisplay();
        }

        window.addEventListener('resize', handleResize);

        createPiano();
        updateChordDisplay();
        preloadAllNotesBuffer();
    </script>
</body>
</html>
