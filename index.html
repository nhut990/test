<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>SoundShift ‚Äî Chuy·ªÉn ƒê·ªïi √Çm Thanh</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c28;
    --border: #2a2a3a;
    --accent: #7c6fff;
    --accent2: #ff6fa3;
    --accent3: #4dffc8;
    --text: #f0f0ff;
    --text-dim: #7878a0;
    --text-muted: #44445a;
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
  }

  body {
    min-height: 100vh;
    min-height: -webkit-fill-available;
  }

  /* Background grid */
  .bg-grid {
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(124,111,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,111,255,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .bg-glow {
    position: fixed;
    width: 600px; height: 600px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(124,111,255,0.12) 0%, transparent 70%);
    top: -200px; left: 50%;
    transform: translateX(-50%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 24px 16px 60px;
  }

  /* Header */
  header {
    text-align: center;
    padding: 32px 0 40px;
  }

  .logo-mark {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }

  .logo-icon {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }

  .logo-text {
    font-size: 26px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  header p {
    font-size: 14px;
    color: var(--text-dim);
    font-weight: 400;
    letter-spacing: 0.3px;
  }

  /* Drop zone */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 40px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s ease;
    background: var(--surface);
    position: relative;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  .drop-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(124,111,255,0.06), rgba(255,111,163,0.04));
    opacity: 0;
    transition: opacity 0.3s;
  }

  .drop-zone.dragover, .drop-zone:active {
    border-color: var(--accent);
    background: var(--surface2);
  }

  .drop-zone.dragover::before { opacity: 1; }

  .drop-zone-icon {
    font-size: 48px;
    margin-bottom: 14px;
    display: block;
    line-height: 1;
  }

  .drop-zone h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 6px;
    letter-spacing: -0.3px;
  }

  .drop-zone p {
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: 18px;
  }

  .btn-browse {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--accent), #9b8fff);
    color: #fff;
    border: none;
    border-radius: var(--radius-sm);
    padding: 11px 22px;
    font-size: 14px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    letter-spacing: 0.3px;
    -webkit-appearance: none;
    touch-action: manipulation;
  }

  .btn-browse:active { transform: scale(0.97); }

  .formats-hint {
    margin-top: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
  }

  .fmt-tag {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    padding: 3px 8px;
    border-radius: 6px;
    letter-spacing: 0.5px;
    font-weight: 500;
  }

  /* File list */
  #file-list { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }

  .file-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .file-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 14px;
  }

  .file-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--surface2), var(--border));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .file-info { flex: 1; min-width: 0; }

  .file-name {
    font-size: 14px;
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 3px;
    letter-spacing: -0.2px;
  }

  .file-meta {
    font-size: 12px;
    color: var(--text-dim);
    font-family: 'DM Mono', monospace;
  }

  .btn-remove {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 18px;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    transition: color 0.2s, background 0.2s;
    flex-shrink: 0;
    -webkit-appearance: none;
    touch-action: manipulation;
    line-height: 1;
  }

  .btn-remove:active { color: var(--accent2); background: rgba(255,111,163,0.1); }

  /* Format selector */
  .format-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    align-items: center;
  }

  .select-wrap {
    position: relative;
  }

  .select-wrap label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .select-wrap select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: var(--radius-sm);
    padding: 10px 34px 10px 12px;
    font-size: 14px;
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
    transition: border-color 0.2s;
    outline: none;
    letter-spacing: 0.5px;
  }

  .select-wrap select:focus { border-color: var(--accent); }

  .select-arrow {
    position: absolute;
    right: 10px;
    bottom: 11px;
    color: var(--text-dim);
    pointer-events: none;
    font-size: 12px;
  }

  .btn-convert {
    background: linear-gradient(135deg, var(--accent3) 0%, #00d4a0 100%);
    color: #0a0a0f;
    border: none;
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 800;
    font-family: inherit;
    cursor: pointer;
    transition: transform 0.15s, opacity 0.2s;
    white-space: nowrap;
    -webkit-appearance: none;
    touch-action: manipulation;
    letter-spacing: 0.3px;
    align-self: flex-end;
  }

  .btn-convert:active { transform: scale(0.96); }
  .btn-convert:disabled { opacity: 0.45; cursor: not-allowed; }

  /* Progress */
  .progress-wrap {
    margin-top: 14px;
    display: none;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-dim);
    margin-bottom: 6px;
    font-family: 'DM Mono', monospace;
  }

  .progress-bar {
    height: 6px;
    background: var(--surface2);
    border-radius: 99px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    width: 0%;
    transition: width 0.2s ease;
  }

  /* Status */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 99px;
    margin-top: 10px;
    letter-spacing: 0.3px;
    display: none;
  }

  .status-badge.done {
    background: rgba(77,255,200,0.1);
    color: var(--accent3);
    border: 1px solid rgba(77,255,200,0.25);
    display: inline-flex;
  }

  .status-badge.error {
    background: rgba(255,111,163,0.1);
    color: var(--accent2);
    border: 1px solid rgba(255,111,163,0.25);
    display: inline-flex;
  }

  /* Download button */
  .btn-download {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    background: var(--surface2);
    border: 1px solid var(--accent3);
    color: var(--accent3);
    border-radius: var(--radius-sm);
    padding: 9px 16px;
    font-size: 13px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
    text-decoration: none;
    margin-top: 10px;
    -webkit-appearance: none;
    touch-action: manipulation;
    letter-spacing: 0.3px;
  }

  .btn-download:active { transform: scale(0.96); background: rgba(77,255,200,0.1); }

  /* Info panel */
  .info-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px;
    margin-top: 28px;
    position: relative;
    overflow: hidden;
  }

  .info-panel::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, var(--accent), var(--accent2));
    border-radius: 99px;
  }

  .info-panel h4 {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 10px;
  }

  .info-panel p {
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.65;
  }

  /* iOS Warning */
  .ios-note {
    background: rgba(124,111,255,0.08);
    border: 1px solid rgba(124,111,255,0.2);
    border-radius: var(--radius-sm);
    padding: 12px 14px;
    font-size: 12.5px;
    color: var(--text-dim);
    line-height: 1.6;
    margin-top: 14px;
    display: none;
  }

  .ios-note.visible { display: block; }

  /* Quaalitybar */
  .quality-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .quality-row label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    color: var(--text-dim);
    text-transform: uppercase;
    white-space: nowrap;
  }

  .quality-row input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: var(--surface2);
    border-radius: 99px;
    outline: none;
    cursor: pointer;
  }

  .quality-row input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    cursor: pointer;
    border: 2px solid var(--bg);
    box-shadow: 0 0 0 1px var(--accent);
  }

  .quality-val {
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    color: var(--accent);
    min-width: 30px;
    text-align: right;
    font-weight: 500;
  }

  /* Divider */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 28px 0 20px;
  }

  .section-divider span {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .section-divider::before,
  .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Empty state */
  #empty-state {
    text-align: center;
    padding: 32px;
    color: var(--text-muted);
    font-size: 13px;
    display: none;
  }

  /* Responsive */
  @media (max-width: 480px) {
    header { padding: 20px 0 28px; }
    .drop-zone { padding: 28px 16px; }
    .drop-zone-icon { font-size: 38px; }
    .format-selector { grid-template-columns: 1fr; }
    .btn-convert { align-self: stretch; padding: 12px; }
    .container { padding: 16px 12px 60px; }
  }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-glow"></div>

<div class="container">
  <header>
    <div class="logo-mark">
      <div class="logo-icon">üéµ</div>
      <span class="logo-text">SoundShift</span>
    </div>
    <p>Chuy·ªÉn ƒë·ªïi √¢m thanh ngay tr√™n tr√¨nh duy·ªát ‚Äî kh√¥ng c·∫ßn upload l√™n server</p>
  </header>

  <!-- Drop Zone -->
  <div class="drop-zone" id="dropZone">
    <span class="drop-zone-icon">üéß</span>
    <h3>K√©o & th·∫£ file √¢m thanh v√†o ƒë√¢y</h3>
    <p>ho·∫∑c nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ ch·ªçn file</p>
    <button class="btn-browse" onclick="document.getElementById('fileInput').click()">
      üìÅ Ch·ªçn File
    </button>
    <input type="file" id="fileInput" accept="audio/*" multiple style="display:none">
    <div class="formats-hint">
      <span class="fmt-tag">MP3</span>
      <span class="fmt-tag">WAV</span>
      <span class="fmt-tag">AAC</span>
      <span class="fmt-tag">OGG</span>
      <span class="fmt-tag">FLAC</span>
      <span class="fmt-tag">M4A</span>
      <span class="fmt-tag">WEBM</span>
      <span class="fmt-tag">OPUS</span>
    </div>
  </div>

  <div id="ios-note-global" class="ios-note">
    ‚ö†Ô∏è <strong>iOS:</strong> Do gi·ªõi h·∫°n tr√¨nh duy·ªát Safari, m·ªôt s·ªë ƒë·ªãnh d·∫°ng (OGG, FLAC, OPUS) c√≥ th·ªÉ kh√¥ng h·ªó tr·ª£ xu·∫•t. Khuy√™n d√πng <strong>WAV</strong> ho·∫∑c <strong>MP3</strong> khi d√πng iPhone/iPad. File WAV lu√¥n ho·∫°t ƒë·ªông t·ªët nh·∫•t tr√™n iOS ƒë·ªùi th·∫•p.
  </div>

  <!-- File list -->
  <div id="file-section" style="display:none">
    <div class="section-divider"><span>Danh s√°ch file</span></div>
    <div id="file-list"></div>
  </div>

  <!-- Info -->
  <div class="info-panel" style="margin-top: 32px;">
    <h4>‚ÑπÔ∏è C√°ch ho·∫°t ƒë·ªông</h4>
    <p>To√†n b·ªô qu√° tr√¨nh x·ª≠ l√Ω di·ªÖn ra <strong style="color: var(--text)">100% tr√™n thi·∫øt b·ªã c·ªßa b·∫°n</strong>, kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c g·ª≠i l√™n internet. S·ª≠ d·ª•ng Web Audio API v√† AudioBuffer ƒë·ªÉ gi·∫£i m√£, sau ƒë√≥ m√£ h√≥a l·∫°i sang ƒë·ªãnh d·∫°ng ƒë√≠ch b·∫±ng MediaRecorder.</p>
  </div>
</div>

<script>
// ============================================
// Detect iOS
// ============================================
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

if (isIOS || isSafari) {
  document.getElementById('ios-note-global').classList.add('visible');
}

// Supported output formats per browser
function getSupportedFormats() {
  const all = [
    { value: 'wav',  label: 'WAV', mime: 'audio/wav' },
    { value: 'mp3',  label: 'MP3', mime: 'audio/mpeg' },
    { value: 'ogg',  label: 'OGG', mime: 'audio/ogg; codecs=vorbis' },
    { value: 'webm', label: 'WEBM',mime: 'audio/webm; codecs=opus' },
    { value: 'opus', label: 'OPUS',mime: 'audio/ogg; codecs=opus' },
    { value: 'm4a',  label: 'M4A', mime: 'audio/mp4' },
  ];

  // WAV is always supported via our custom encoder
  // Others depend on MediaRecorder
  const supported = [{ value: 'wav', label: 'WAV (Khuy√™n d√πng iOS)', mime: 'audio/wav' }];

  if (!isIOS && !isSafari) {
    // Check MediaRecorder support
    all.slice(1).forEach(f => {
      try {
        if (window.MediaRecorder && MediaRecorder.isTypeSupported(f.mime)) {
          supported.push(f);
        }
      } catch(e) {}
    });
  } else {
    // iOS Safari may support mp4/m4a
    try {
      if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/mp4')) {
        supported.push({ value: 'm4a', label: 'M4A / AAC', mime: 'audio/mp4' });
      }
    } catch(e) {}
  }

  // Always add common ones as attempt
  if (!supported.find(f => f.value === 'mp3')) {
    supported.push({ value: 'mp3', label: 'MP3*', mime: 'audio/mpeg' });
  }

  return supported;
}

const SUPPORTED_OUT = getSupportedFormats();

// ============================================
// Drag and Drop
// ============================================
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', e => handleFiles(e.target.files));

// Touch friendly tap on drop zone
dropZone.addEventListener('click', e => {
  if (e.target.tagName !== 'BUTTON') {
    fileInput.click();
  }
});

// ============================================
// File handling
// ============================================
let fileItems = [];

function handleFiles(fileList) {
  const arr = Array.from(fileList).filter(f => f.type.startsWith('audio/') || isAudioByExt(f.name));
  if (!arr.length) return;
  arr.forEach(f => addFile(f));
  document.getElementById('file-section').style.display = 'block';
}

function isAudioByExt(name) {
  return /\.(mp3|wav|ogg|flac|m4a|aac|opus|webm|wma|aiff|au)$/i.test(name);
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(2) + ' MB';
}

function getExt(name) {
  return name.split('.').pop().toUpperCase();
}

function addFile(file) {
  const id = 'fi_' + Date.now() + '_' + Math.random().toString(36).slice(2);
  fileItems.push({ id, file });

  const el = document.createElement('div');
  el.className = 'file-item';
  el.id = id;

  const optionsHtml = SUPPORTED_OUT.map(f =>
    `<option value="${f.value}" data-mime="${f.mime}">${f.label}</option>`
  ).join('');

  el.innerHTML = `
    <div class="file-header">
      <div class="file-icon">üéµ</div>
      <div class="file-info">
        <div class="file-name" title="${file.name}">${file.name}</div>
        <div class="file-meta">${getExt(file.name)} ¬∑ ${formatBytes(file.size)}</div>
      </div>
      <button class="btn-remove" onclick="removeFile('${id}')" title="X√≥a">‚úï</button>
    </div>
    <div class="format-selector">
      <div class="select-wrap">
        <label>Chuy·ªÉn sang</label>
        <select id="fmt_${id}">
          ${optionsHtml}
        </select>
        <span class="select-arrow">‚ñæ</span>
      </div>
      <div class="select-wrap">
        <label>Sample Rate</label>
        <select id="sr_${id}">
          <option value="44100">44100 Hz</option>
          <option value="22050">22050 Hz</option>
          <option value="48000">48000 Hz</option>
          <option value="16000">16000 Hz (nh·ªè)</option>
          <option value="8000">8000 Hz (ƒëi·ªán tho·∫°i)</option>
        </select>
        <span class="select-arrow">‚ñæ</span>
      </div>
      <button class="btn-convert" id="btn_${id}" onclick="convertFile('${id}')">
        ‚ö° Chuy·ªÉn ƒë·ªïi
      </button>
    </div>
    <div class="quality-row">
      <label>Ch·∫•t l∆∞·ª£ng</label>
      <input type="range" id="q_${id}" min="0.1" max="1" step="0.05" value="0.9"
        oninput="document.getElementById('qv_${id}').textContent=Math.round(this.value*100)+'%'">
      <span class="quality-val" id="qv_${id}">90%</span>
    </div>
    <div class="progress-wrap" id="prog_${id}">
      <div class="progress-label">
        <span id="prog_label_${id}">ƒêang x·ª≠ l√Ω...</span>
        <span id="prog_pct_${id}">0%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="prog_fill_${id}"></div></div>
    </div>
    <div id="result_${id}"></div>
  `;

  document.getElementById('file-list').appendChild(el);
}

function removeFile(id) {
  fileItems = fileItems.filter(f => f.id !== id);
  const el = document.getElementById(id);
  if (el) el.remove();
  if (fileItems.length === 0) {
    document.getElementById('file-section').style.display = 'none';
  }
}

// ============================================
// WAV Encoder (pure JS, works everywhere)
// ============================================
function audioBufferToWav(buffer, targetSampleRate) {
  const numChannels = Math.min(buffer.numberOfChannels, 2);
  const sampleRate = targetSampleRate || buffer.sampleRate;
  const format = 1; // PCM
  const bitDepth = 16;

  // Resample if needed
  let channelData = [];
  for (let c = 0; c < numChannels; c++) {
    channelData.push(resample(buffer.getChannelData(c), buffer.sampleRate, sampleRate));
  }

  const numSamples = channelData[0].length;
  const byteRate = sampleRate * numChannels * bitDepth / 8;
  const dataSize = numSamples * numChannels * bitDepth / 8;
  const headerSize = 44;
  const ab = new ArrayBuffer(headerSize + dataSize);
  const view = new DataView(ab);

  function writeStr(o, s) { for (let i=0; i<s.length; i++) view.setUint8(o+i, s.charCodeAt(i)); }

  writeStr(0, 'RIFF');
  view.setUint32(4, 36 + dataSize, true);
  writeStr(8, 'WAVE');
  writeStr(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, format, true);
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, byteRate, true);
  view.setUint16(32, numChannels * bitDepth / 8, true);
  view.setUint16(34, bitDepth, true);
  writeStr(36, 'data');
  view.setUint32(40, dataSize, true);

  let offset = 44;
  for (let i = 0; i < numSamples; i++) {
    for (let c = 0; c < numChannels; c++) {
      const s = Math.max(-1, Math.min(1, channelData[c][i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      offset += 2;
    }
  }

  return ab;
}

function resample(samples, fromRate, toRate) {
  if (fromRate === toRate) return samples;
  const ratio = fromRate / toRate;
  const length = Math.round(samples.length / ratio);
  const result = new Float32Array(length);
  for (let i = 0; i < length; i++) {
    const pos = i * ratio;
    const idx = Math.floor(pos);
    const frac = pos - idx;
    const s0 = samples[idx] || 0;
    const s1 = samples[Math.min(idx + 1, samples.length - 1)] || 0;
    result[i] = s0 + (s1 - s0) * frac;
  }
  return result;
}

// ============================================
// Main Convert Function
// ============================================
async function convertFile(id) {
  const item = fileItems.find(f => f.id === id);
  if (!item) return;

  const btn = document.getElementById('btn_' + id);
  const progWrap = document.getElementById('prog_' + id);
  const progFill = document.getElementById('prog_fill_' + id);
  const progLabel = document.getElementById('prog_label_' + id);
  const progPct = document.getElementById('prog_pct_' + id);
  const result = document.getElementById('result_' + id);
  const fmtSel = document.getElementById('fmt_' + id);
  const srSel = document.getElementById('sr_' + id);
  const quality = parseFloat(document.getElementById('q_' + id).value);

  const outFmt = fmtSel.value;
  const outMime = fmtSel.selectedOptions[0].dataset.mime;
  const targetSR = parseInt(srSel.value);

  btn.disabled = true;
  result.innerHTML = '';
  progWrap.style.display = 'block';

  function setProgress(pct, label) {
    progFill.style.width = pct + '%';
    progPct.textContent = pct + '%';
    if (label) progLabel.textContent = label;
  }

  try {
    setProgress(5, 'ƒê·ªçc file...');

    // Read file as ArrayBuffer
    const arrayBuf = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsArrayBuffer(item.file);
    });

    setProgress(20, 'Gi·∫£i m√£ √¢m thanh...');

    // Decode audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (!AudioCtx) throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Audio API');

    const ctx = new AudioCtx();
    let audioBuffer;
    try {
      audioBuffer = await ctx.decodeAudioData(arrayBuf.slice(0));
    } catch(e) {
      throw new Error('Kh√¥ng th·ªÉ gi·∫£i m√£ file. ƒê·ªãnh d·∫°ng ngu·ªìn c√≥ th·ªÉ kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n thi·∫øt b·ªã n√†y.');
    }

    setProgress(45, 'ƒêang m√£ h√≥a...');

    let blob;

    if (outFmt === 'wav') {
      // Use our pure-JS WAV encoder
      setProgress(60, 'T·∫°o file WAV...');
      const wavBuf = audioBufferToWav(audioBuffer, targetSR);
      blob = new Blob([wavBuf], { type: 'audio/wav' });
      setProgress(95, 'Ho√†n th√†nh!');

    } else {
      // Try MediaRecorder approach
      blob = await encodeWithMediaRecorder(audioBuffer, outMime, targetSR, quality, setProgress);
    }

    await ctx.close();
    setProgress(100, 'Xong!');

    const ext = outFmt;
    const baseName = item.file.name.replace(/\.[^.]+$/, '');
    const outName = baseName + '.' + ext;
    const url = URL.createObjectURL(blob);

    result.innerHTML = `
      <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px;">
        <span class="status-badge done">‚úì Chuy·ªÉn ƒë·ªïi th√†nh c√¥ng ¬∑ ${formatBytes(blob.size)}</span>
      </div>
      <a class="btn-download" href="${url}" download="${outName}">
        ‚¨á T·∫£i v·ªÅ ${outName}
      </a>
    `;

    // Also show audio player for preview
    const audio = document.createElement('audio');
    audio.controls = true;
    audio.src = url;
    audio.style.cssText = 'display:block; margin-top:12px; width:100%; max-width:100%; border-radius:8px;';
    result.appendChild(audio);

  } catch(err) {
    setProgress(0, 'L·ªói!');
    result.innerHTML = `<span class="status-badge error">‚úó ${err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}</span>`;
    if (outFmt === 'wav') {
      result.innerHTML += `<br><small style="color:var(--text-dim);font-size:12px;display:block;margin-top:6px;">Th·ª≠ ch·ªçn ƒë·ªãnh d·∫°ng WAV ‚Äî ƒë√¢y l√† ƒë·ªãnh d·∫°ng t∆∞∆°ng th√≠ch nh·∫•t v·ªõi m·ªçi thi·∫øt b·ªã.</small>`;
    }
  } finally {
    btn.disabled = false;
  }
}

async function encodeWithMediaRecorder(audioBuffer, mime, targetSR, quality, setProgress) {
  return new Promise((resolve, reject) => {
    if (!window.MediaRecorder) {
      reject(new Error('MediaRecorder kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Vui l√≤ng ch·ªçn ƒë·ªãnh d·∫°ng WAV.'));
      return;
    }

    if (!MediaRecorder.isTypeSupported(mime)) {
      // Fallback: try without codec spec
      const baseMime = mime.split(';')[0];
      if (!MediaRecorder.isTypeSupported(baseMime)) {
        reject(new Error(`ƒê·ªãnh d·∫°ng ${mime.split('/')[1]} kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ tr√™n thi·∫øt b·ªã n√†y. Vui l√≤ng ch·ªçn WAV.`));
        return;
      }
      mime = baseMime;
    }

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const offlineCtx = new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(
      audioBuffer.numberOfChannels,
      Math.round(audioBuffer.duration * targetSR),
      targetSR
    );

    const src = offlineCtx.createBufferSource();
    src.buffer = audioBuffer;
    src.connect(offlineCtx.destination);
    src.start(0);

    offlineCtx.startRendering().then(rendered => {
      setProgress(65, 'Ghi √¢m thanh...');

      const dest = new AudioContext().createMediaStreamDestination();
      const ctx2 = dest.context;
      const src2 = ctx2.createBufferSource();
      src2.buffer = rendered;
      src2.connect(dest);
      src2.start(0);

      const recorder = new MediaRecorder(dest.stream, {
        mimeType: mime,
        audioBitsPerSecond: Math.round(quality * 320000)
      });

      const chunks = [];
      recorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: mime });
        resolve(blob);
      };
      recorder.onerror = e => reject(new Error('MediaRecorder l·ªói: ' + e.error));

      recorder.start(100);

      const duration = rendered.duration * 1000;
      const startTime = Date.now();

      const ticker = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const pct = Math.min(95, 65 + Math.round((elapsed / duration) * 30));
        setProgress(pct, 'ƒêang x·ª≠ l√Ω...');
      }, 200);

      setTimeout(() => {
        clearInterval(ticker);
        try { recorder.stop(); } catch(e) {}
      }, duration + 200);

    }).catch(err => reject(new Error('L·ªói OfflineAudioContext: ' + err.message)));
  });
}
</script>
</body>
</html>
