<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CÃ´ng Cá»¥ Chuyá»ƒn Äá»•i Äá»‹nh Dáº¡ng Ã‚m Thanh</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 25px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            cursor: pointer;
        }

        input[type="file"] {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0.01;
            cursor: pointer;
            z-index: 10;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .file-input-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 28px 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
            pointer-events: none;
            min-height: 90px;
            text-align: center;
        }

        .file-input-visual .icon { font-size: 32px; margin-bottom: 8px; }
        .file-input-visual .hint { color: #667eea; font-weight: 600; font-size: 14px; }
        .file-name { color: #667eea; font-weight: 600; margin-top: 8px; font-size: 13px; }
        .info-text { font-size: 12px; color: #666; margin-top: 8px; }

        .ios-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .format-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .format-item input[type="radio"] { display: none; }

        .format-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            font-weight: 500;
            font-size: 13px;
            -webkit-tap-highlight-color: transparent;
        }

        .format-item input[type="radio"]:checked + label {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .button-group { display: flex; gap: 10px; }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-convert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-convert:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.4);
        }

        .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: #f0f0f0; color: #333; }
        .btn-reset:hover { background: #e0e0e0; }

        .progress-section { margin-top: 25px; display: none; }
        .progress-section.show { display: block; }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .progress-percentage { font-weight: 700; color: #667eea; font-size: 16px; }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(102,126,234,0.5);
        }

        .progress-text { margin-top: 10px; text-align: center; color: #666; font-size: 13px; }

        .progress-steps {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }

        .step { display: flex; flex-direction: column; align-items: center; gap: 5px; }

        .step-icon {
            width: 30px; height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step.completed .step-icon { background-color: #667eea; color: white; }
        .step.active .step-icon {
            background-color: #667eea; color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102,126,234,0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102,126,234,0); }
        }

        .result-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }
        .result-section.show { display: block; }

        .result-audio { background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .result-audio h3 { color: #333; margin-bottom: 10px; font-size: 14px; }
        audio { width: 100%; margin-bottom: 10px; }

        .download-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        .download-btn:hover { background: #764ba2; }

        .message { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 14px; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warn { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }

        .spinner {
            display: none;
            width: 18px; height: 18px;
            border: 3px solid rgba(255,255,255,0.4);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        .spinner.show { display: inline-block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container { padding: 20px; }
            h1 { font-size: 22px; }
            .button-group { flex-direction: column; }
            .progress-steps { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸµ Chuyá»ƒn Äá»•i Ã‚m Thanh</h1>
    <p class="subtitle">Chuyá»ƒn Ä‘á»•i giá»¯a cÃ¡c Ä‘á»‹nh dáº¡ng Ã¢m thanh phá»• biáº¿n</p>

    <div id="message" class="message"></div>

    <div class="form-group">
        <label>Chá»n File Ã‚m Thanh</label>
        <label class="file-input-wrapper" for="audioFile">
            <input type="file" id="audioFile" name="audioFile"
                accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,.aiff,.wma,audio/*">
            <div class="file-input-visual">
                <div class="icon">ğŸ“</div>
                <div class="hint">Nháº¥n Ä‘á»ƒ chá»n file Ã¢m thanh</div>
            </div>
        </label>
        <div class="file-name" id="fileName"></div>
        <div class="info-text">Há»— trá»£: MP3, WAV, OGG, M4A, FLAC, AAC...</div>
        <div class="ios-note" id="iosNote">
            ğŸ“± iOS: Sau khi nháº¥n â†’ chá»n <strong>Browse</strong> â†’ tÃ¬m file trong <strong>Files / iCloud Drive / On My iPhone</strong>
        </div>
    </div>

    <div class="form-group">
        <label>Äá»‹nh Dáº¡ng ÄÃ­ch</label>
        <div class="format-group">
            <div class="format-item">
                <input type="radio" id="fmt_mp3" name="format" value="mp3">
                <label for="fmt_mp3">MP3</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_wav" name="format" value="wav" checked>
                <label for="fmt_wav">WAV</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_ogg" name="format" value="ogg">
                <label for="fmt_ogg">OGG</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_m4a" name="format" value="m4a">
                <label for="fmt_m4a">M4A</label>
            </div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-convert" id="convertBtn" disabled>
            <span class="spinner" id="spinner"></span>
            <span id="btnText">Chuyá»ƒn Äá»•i</span>
        </button>
        <button class="btn-reset" id="resetBtn">Äáº·t Láº¡i</button>
    </div>

    <div class="progress-section" id="progressSection">
        <div class="progress-label">
            <span>Tiáº¿n Ä‘á»™</span>
            <span class="progress-percentage" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">Äang khá»Ÿi táº¡o...</div>
        <div class="progress-steps">
            <div class="step" id="step1"><div class="step-icon">ğŸ“‚</div><div>Äá»c File</div></div>
            <div class="step" id="step2"><div class="step-icon">âš™ï¸</div><div>Xá»­ LÃ½</div></div>
            <div class="step" id="step3"><div class="step-icon">ğŸ“¦</div><div>HoÃ n ThÃ nh</div></div>
        </div>
    </div>

    <div class="result-section" id="resultSection">
        <h2 style="margin-bottom:20px;color:#333;font-size:18px;">âœ“ Káº¿t Quáº£ Chuyá»ƒn Äá»•i</h2>
        <div class="result-audio" id="resultAudio"></div>
    </div>
</div>

<script>
(function() {
    'use strict';

    /* â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var audioFileEl     = document.getElementById('audioFile');
    var fileNameEl      = document.getElementById('fileName');
    var convertBtn      = document.getElementById('convertBtn');
    var resetBtn        = document.getElementById('resetBtn');
    var resultSection   = document.getElementById('resultSection');
    var resultAudioEl   = document.getElementById('resultAudio');
    var messageEl       = document.getElementById('message');
    var spinnerEl       = document.getElementById('spinner');
    var btnTextEl       = document.getElementById('btnText');
    var progressSection = document.getElementById('progressSection');
    var progressBarEl   = document.getElementById('progressBar');
    var progressPctEl   = document.getElementById('progressPercent');
    var progressTxtEl   = document.getElementById('progressText');
    var step1El         = document.getElementById('step1');
    var step2El         = document.getElementById('step2');
    var step3El         = document.getElementById('step3');
    var iosNoteEl       = document.getElementById('iosNote');

    var selectedFile = null;
    var blobUrls     = [];

    /* â”€â”€ iOS detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) iosNoteEl.style.display = 'block';

    /* â”€â”€ Dragâ€‘drop (desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    if (!isIOS) {
        var wrap = document.querySelector('.file-input-wrapper');
        wrap.addEventListener('dragover', function(e) { e.preventDefault(); });
        wrap.addEventListener('drop', function(e) {
            e.preventDefault();
            var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (f) handleFile(f);
        });
    }

    audioFileEl.addEventListener('change', function() {
        var f = this.files && this.files[0];
        if (f) handleFile(f);
    });

    function handleFile(file) {
        var ext = (file.name || '').split('.').pop().toLowerCase();
        var ok  = (file.type && file.type.startsWith('audio/')) ||
                  ['mp3','wav','ogg','m4a','flac','aac','aiff','wma','mp4','opus','webm','caf'].indexOf(ext) !== -1;
        if (!ok) { showMsg('Vui lÃ²ng chá»n file Ã¢m thanh há»£p lá»‡.', 'error'); return; }
        selectedFile = file;
        fileNameEl.textContent = 'âœ“ ÄÃ£ chá»n: ' + file.name;
        convertBtn.disabled = false;
        hideMsg();
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
    }

    convertBtn.addEventListener('click', function() {
        if (!selectedFile) { showMsg('Vui lÃ²ng chá»n file!', 'error'); return; }
        var fmt = document.querySelector('input[name="format"]:checked');
        if (!fmt) { showMsg('Vui lÃ²ng chá»n Ä‘á»‹nh dáº¡ng!', 'error'); return; }
        doConvert(selectedFile, fmt.value);
    });

    resetBtn.addEventListener('click', function() {
        audioFileEl.value = '';
        selectedFile = null;
        fileNameEl.textContent = '';
        convertBtn.disabled = true;
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
        hideMsg();
        document.getElementById('fmt_wav').checked = true;
        blobUrls.forEach(function(u) { try { URL.revokeObjectURL(u); } catch(e){} });
        blobUrls = [];
    });

    /* â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function prog(pct, text, step) {
        progressBarEl.style.width = pct + '%';
        progressPctEl.textContent = Math.round(pct) + '%';
        progressTxtEl.textContent = text;
        [step1El, step2El, step3El].forEach(function(s, i) {
            s.classList.remove('active','completed');
            if (step === undefined) return;
            if (i + 1 < step)  s.classList.add('completed');
            if (i + 1 === step) s.classList.add('active');
        });
    }

    function allDone() {
        [step1El, step2El, step3El].forEach(function(s) {
            s.classList.remove('active');
            s.classList.add('completed');
        });
    }

    function showMsg(t, type) {
        messageEl.textContent = t;
        messageEl.className = 'message show ' + (type || '');
    }
    function hideMsg() { messageEl.className = 'message'; }

    function setBusy(b) {
        convertBtn.disabled = b;
        spinnerEl.classList[b ? 'add' : 'remove']('show');
        btnTextEl.textContent = b ? 'Äang chuyá»ƒn Ä‘á»•i...' : 'Chuyá»ƒn Äá»•i';
    }

    function mkUrl(blob) {
        var u = URL.createObjectURL(blob);
        blobUrls.push(u);
        return u;
    }

    /* â”€â”€ Encode PCM â†’ WAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function encodeWav(audioBuf) {
        var numCh = audioBuf.numberOfChannels;
        var sr    = audioBuf.sampleRate;
        var len   = audioBuf.length;

        /* mix to mono */
        var out = new Float32Array(len);
        for (var c = 0; c < numCh; c++) {
            var ch = audioBuf.getChannelData(c);
            for (var i = 0; i < len; i++) out[i] += ch[i];
        }
        if (numCh > 1) for (var j = 0; j < len; j++) out[j] /= numCh;

        var ab = new ArrayBuffer(44 + len * 2);
        var dv = new DataView(ab);
        function s(o, v) { for (var k = 0; k < v.length; k++) dv.setUint8(o + k, v.charCodeAt(k)); }

        s(0,'RIFF'); dv.setUint32(4,36+len*2,true);
        s(8,'WAVE'); s(12,'fmt ');
        dv.setUint32(16,16,true); dv.setUint16(20,1,true); dv.setUint16(22,1,true);
        dv.setUint32(24,sr,true); dv.setUint32(28,sr*2,true);
        dv.setUint16(32,2,true);  dv.setUint16(34,16,true);
        s(36,'data'); dv.setUint32(40,len*2,true);

        var off = 44;
        for (var n = 0; n < len; n++, off += 2) {
            var x = Math.max(-1, Math.min(1, out[n]));
            dv.setInt16(off, x < 0 ? x * 0x8000 : x * 0x7FFF, true);
        }
        return ab;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PIPELINE CHÃNH
       Váº¥n Ä‘á» cá»‘t lÃµi trÃªn iOS cÅ©: decodeAudioData() KHÃ”NG BAO GIá»œ
       resolve hoáº·c reject vá»›i nhiá»u codec (FLAC, OGG, VBR MP3...).

       Giáº£i phÃ¡p: thá»­ song song 2 phÆ°Æ¡ng phÃ¡p, láº¥y káº¿t quáº£ nÃ o vá» trÆ°á»›c.

       PhÆ°Æ¡ng phÃ¡p A â€” FileReader + decodeAudioData (callback-style)
         Hoáº¡t Ä‘á»™ng tá»‘t trÃªn iOS 10+ vá»›i MP3/AAC/WAV chuáº©n.

       PhÆ°Æ¡ng phÃ¡p B â€” AudioElement + MediaElementSource + OfflineAudioContext
         DÃ¹ng <audio> Ä‘á»ƒ browser tá»± decode (iOS Safari xá»­ lÃ½ codec riÃªng),
         sau Ä‘Ã³ capture PCM qua OfflineAudioContext.
         KhÃ´ng phá»¥ thuá»™c vÃ o decodeAudioData â†’ bypass hoÃ n toÃ n Ä‘iá»ƒm treo.

       Náº¿u cáº£ 2 tháº¥t báº¡i â†’ tráº£ file gá»‘c + thÃ´ng bÃ¡o cho user.
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    /* â”€â”€ PhÆ°Æ¡ng phÃ¡p A: FileReader â†’ decodeAudioData â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function methodA(file) {
        return new Promise(function(resolve, reject) {
            /* BÆ°á»›c A1: Ä‘á»c file */
            var reader = new FileReader();
            var dead = false;

            var t1 = setTimeout(function() {
                if (dead) return; dead = true;
                try { reader.abort(); } catch(e) {}
                reject(new Error('A:timeout-read'));
            }, 30000);

            reader.onerror = function() {
                if (dead) return; dead = true;
                clearTimeout(t1);
                reject(new Error('A:read-error'));
            };

            reader.onload = function(e) {
                if (dead) return;
                clearTimeout(t1);
                var ab = e.target.result;

                /* BÆ°á»›c A2: decodeAudioData */
                var AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) { dead = true; reject(new Error('A:no-api')); return; }

                var ctx;
                try { ctx = new AudioCtx(); } catch(ex) {
                    dead = true; reject(new Error('A:ctx-fail')); return;
                }

                var t2 = setTimeout(function() {
                    if (dead) return; dead = true;
                    try { ctx.close(); } catch(e) {}
                    /* ÄIá»‚M TREO CHÃNH â€” timeout sau 25s náº¿u iOS khÃ´ng pháº£n há»“i */
                    reject(new Error('A:timeout-decode'));
                }, 25000);

                function ok(buf) {
                    if (dead) return; dead = true;
                    clearTimeout(t2);
                    try { ctx.close(); } catch(e) {}
                    resolve(buf);
                }
                function err() {
                    if (dead) return; dead = true;
                    clearTimeout(t2);
                    try { ctx.close(); } catch(e) {}
                    reject(new Error('A:decode-error'));
                }

                var resume = (ctx.state === 'suspended' && ctx.resume)
                           ? ctx.resume() : Promise.resolve();

                resume['catch'](function(){}).then(function() {
                    try {
                        var buf2 = ab.slice ? ab.slice(0) : ab;
                        var p = ctx.decodeAudioData(buf2, ok, err);
                        if (p && p.then) p.then(function(b){ if(!dead) ok(b); })['catch'](function(){ if(!dead) err(); });
                    } catch(ex) {
                        if (!dead) { dead = true; clearTimeout(t2); reject(ex); }
                    }
                });
            };

            reader.readAsArrayBuffer(file);
        });
    }

    /* â”€â”€ PhÆ°Æ¡ng phÃ¡p B: AudioElement â†’ OfflineAudioContext â”€â”€â”€â”€â”€ */
    /*
       NguyÃªn lÃ½:
       1. Táº¡o object URL tá»« file â†’ gÃ¡n vÃ o <audio>
       2. Chá» metadata load Ä‘á»ƒ biáº¿t duration
       3. Táº¡o OfflineAudioContext(1 channel, duration*sr, sr)
       4. Táº¡o AudioContext + createMediaElementSource(<audio>)
       5. Connect source â†’ offlineCtx destination (KHÃ”NG Ä‘Æ°á»£c, khÃ¡c context)
          â†’ Thay báº±ng: dÃ¹ng liveCtx.createBufferSource sau khi decode
          â†’ Thá»±c ra: dÃ¹ng fetch + decodeAudioData trÃªn liveCtx... vÃ²ng láº¡i A.
          â†’ Giáº£i phÃ¡p thá»±c: ScriptProcessorNode capture real-time.

       CÃ¡ch Ä‘Æ¡n giáº£n hÆ¡n (iOS-safe):
       - Táº¡o <audio> vá»›i src = objectURL
       - audio.play() trong OfflineAudioContext listener
       - DÃ¹ng createMediaElementSource + connect tá»›i offlineCtx
         (iOS 14.5+ há»— trá»£, iOS cÅ© hÆ¡n thÃ¬ khÃ´ng â€” nhÆ°ng lÃºc Ä‘Ã³ A Ä‘Ã£ cháº¡y Ä‘Æ°á»£c rá»“i)

       TÃ³m láº¡i: B dÃ¹ng ScriptProcessorNode capture Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch iOS 9+
    */
    function methodB(file) {
        return new Promise(function(resolve, reject) {
            var AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) { reject(new Error('B:no-api')); return; }

            var objUrl = URL.createObjectURL(file);
            blobUrls.push(objUrl);

            var audio = document.createElement('audio');
            audio.preload = 'auto';
            /* iOS yÃªu cáº§u playsinline Ä‘á»ƒ phÃ¡t trong web */
            audio.setAttribute('playsinline', '');
            audio.setAttribute('webkit-playsinline', '');

            var dead   = false;
            var liveCtx, processor, source;
            var chunks = [];
            var sampleRate = 44100;

            var masterTimer = setTimeout(function() {
                if (dead) return; dead = true;
                cleanup();
                reject(new Error('B:timeout'));
            }, 60000);

            function cleanup() {
                clearTimeout(masterTimer);
                try { audio.pause(); audio.src = ''; } catch(e) {}
                try { if (processor) processor.disconnect(); } catch(e) {}
                try { if (source)    source.disconnect();    } catch(e) {}
                try { if (liveCtx)   liveCtx.close();        } catch(e) {}
            }

            /* BÆ°á»›c B1: Chá» metadata Ä‘á»ƒ biáº¿t duration */
            audio.addEventListener('error', function() {
                if (dead) return; dead = true;
                cleanup();
                reject(new Error('B:audio-error'));
            });

            audio.addEventListener('loadedmetadata', function() {
                var duration = audio.duration;
                if (!isFinite(duration) || duration <= 0) {
                    /* Thá»­ canplaythrough thay tháº¿ */
                    return;
                }
                startCapture(duration);
            });

            /* Fallback: canplaythrough náº¿u metadata khÃ´ng cÃ³ duration */
            audio.addEventListener('canplaythrough', function() {
                if (dead) return;
                var dur = audio.duration;
                if (!isFinite(dur) || dur <= 0) dur = 300; /* Giáº£ Ä‘á»‹nh 5 phÃºt náº¿u khÃ´ng biáº¿t */
                startCapture(dur);
            });

            function startCapture(duration) {
                if (dead) return;
                /* Chá»‰ start má»™t láº§n */
                audio.removeEventListener('canplaythrough', arguments.callee);

                try {
                    liveCtx = new AudioCtx({ sampleRate: sampleRate });
                } catch(e1) {
                    try { liveCtx = new AudioCtx(); sampleRate = liveCtx.sampleRate; } catch(e2) {
                        if (!dead) { dead = true; cleanup(); reject(new Error('B:ctx-fail')); }
                        return;
                    }
                }

                /* ScriptProcessorNode Ä‘á»ƒ capture PCM */
                var bufSize = 4096;
                try {
                    processor = liveCtx.createScriptProcessor(bufSize, 1, 1);
                } catch(e) {
                    if (!dead) { dead = true; cleanup(); reject(new Error('B:processor-fail')); }
                    return;
                }

                var totalExpected = Math.ceil(duration * liveCtx.sampleRate);
                var captured = 0;

                processor.onaudioprocess = function(e) {
                    if (dead) return;
                    var inputData = e.inputBuffer.getChannelData(0);
                    var copy = new Float32Array(inputData.length);
                    copy.set(inputData);
                    chunks.push(copy);
                    captured += inputData.length;

                    /* Progress update */
                    var pct = Math.min(90, 40 + Math.round((captured / totalExpected) * 50));
                    prog(pct, 'Äang xá»­ lÃ½ Ã¢m thanh... ' + Math.round(captured / liveCtx.sampleRate) + 's', 2);

                    if (captured >= totalExpected) {
                        finishCapture();
                    }
                };

                try {
                    source = liveCtx.createMediaElementSource(audio);
                    source.connect(processor);
                    processor.connect(liveCtx.destination);
                } catch(e) {
                    if (!dead) { dead = true; cleanup(); reject(new Error('B:source-fail:' + e.message)); }
                    return;
                }

                /* Resume context (iOS) rá»“i play */
                var rp = (liveCtx.state === 'suspended' && liveCtx.resume)
                       ? liveCtx.resume() : Promise.resolve();

                rp['catch'](function(){}).then(function() {
                    try { audio.play(); } catch(e) {
                        if (!dead) { dead = true; cleanup(); reject(new Error('B:play-fail')); }
                    }
                });

                /* Khi audio káº¿t thÃºc */
                audio.addEventListener('ended', finishCapture);
            }

            var finished = false;
            function finishCapture() {
                if (dead || finished) return;
                finished = true;
                dead = true;
                cleanup();

                /* GhÃ©p táº¥t cáº£ chunks */
                var totalLen = 0;
                for (var i = 0; i < chunks.length; i++) totalLen += chunks[i].length;

                if (totalLen === 0) {
                    reject(new Error('B:empty-capture'));
                    return;
                }

                var merged = new Float32Array(totalLen);
                var pos = 0;
                for (var j = 0; j < chunks.length; j++) {
                    merged.set(chunks[j], pos);
                    pos += chunks[j].length;
                }

                /* Táº¡o AudioBuffer giáº£ Ä‘á»ƒ dÃ¹ng encodeWav */
                var fakeBuf = {
                    numberOfChannels: 1,
                    sampleRate: sampleRate,
                    length: totalLen,
                    getChannelData: function() { return merged; }
                };

                resolve(fakeBuf);
            }

            audio.src = objUrl;
            audio.load();
        });
    }

    /* â”€â”€ Cháº¡y A vÃ  B song song, láº¥y káº¿t quáº£ Ä‘áº§u tiÃªn â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function decodeRace(file) {
        return new Promise(function(resolve, reject) {
            var won = false;
            var errs = [];

            function onWin(buf) {
                if (won) return;
                won = true;
                resolve(buf);
            }

            function onFail(err) {
                errs.push(err && err.message ? err.message : String(err));
                if (errs.length >= 2 && !won) {
                    reject(new Error('Cáº£ hai phÆ°Æ¡ng phÃ¡p tháº¥t báº¡i: ' + errs.join(' | ')));
                }
            }

            methodA(file).then(onWin)['catch'](function(e) {
                console.warn('Method A failed:', e && e.message);
                onFail(e);
            });

            methodB(file).then(onWin)['catch'](function(e) {
                console.warn('Method B failed:', e && e.message);
                onFail(e);
            });
        });
    }

    /* â”€â”€ Main convert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function doConvert(file, targetFmt) {
        setBusy(true);
        hideMsg();
        progressSection.classList.add('show');
        resultSection.classList.remove('show');
        prog(5, 'Chuáº©n bá»‹...', 1);

        var base = file.name.lastIndexOf('.') > 0
                 ? file.name.substring(0, file.name.lastIndexOf('.'))
                 : file.name;
        var outName = base + '_converted.wav';

        /* Delay nhá» Ä‘á»ƒ iOS váº½ UI xong trÆ°á»›c khi xá»­ lÃ½ náº·ng */
        setTimeout(function() {

        prog(10, 'Äang Ä‘á»c file...', 1);

        /* Hiá»ƒn thá»‹ progress giáº£ trong lÃºc chá» decode */
        var fakePct  = 15;
        var fakeStep = 1;
        var fakeTimer = setInterval(function() {
            if (fakePct < 38) {
                fakePct++;
                prog(fakePct, fakePct < 30 ? 'Äang Ä‘á»c file...' : 'Äang giáº£i mÃ£ Ã¢m thanh...', fakePct < 30 ? 1 : 2);
                if (fakePct === 30) fakeStep = 2;
            }
        }, 300);

        decodeRace(file)

        .then(function(audioBuf) {
            clearInterval(fakeTimer);
            prog(72, 'Äang mÃ£ hoÃ¡ WAV...', 2);

            return new Promise(function(res) {
                setTimeout(function() {
                    var wavData = encodeWav(audioBuf);
                    res(wavData);
                }, 30);
            });
        })

        .then(function(wavData) {
            prog(92, 'Äang táº¡o file...', 3);
            var blob = new Blob([wavData], { type: 'audio/wav' });
            var url  = mkUrl(blob);

            prog(100, 'HoÃ n thÃ nh!');
            allDone();

            resultAudioEl.innerHTML =
                '<h3>ğŸ“„ ' + outName + '</h3>' +
                '<audio controls playsinline webkit-playsinline style="width:100%;margin:10px 0">' +
                '<source src="' + url + '" type="audio/wav">' +
                '</audio><br>' +
                '<a href="' + url + '" download="' + outName + '" class="download-btn">â¬‡ï¸ Táº£i vá»</a>';

            resultSection.classList.add('show');
            showMsg('âœ… Chuyá»ƒn Ä‘á»•i thÃ nh cÃ´ng!', 'success');
            setTimeout(function() { progressSection.classList.remove('show'); }, 1800);
        })

        .catch(function(err) {
            clearInterval(fakeTimer);
            console.error('Convert error:', err);

            /* Fallback cuá»‘i: tráº£ file gá»‘c Ä‘á»ƒ user Ã­t nháº¥t nghe Ä‘Æ°á»£c */
            prog(95, 'Äang thá»­ cháº¿ Ä‘á»™ tÆ°Æ¡ng thÃ­ch...', 3);

            var rdr = new FileReader();
            rdr.onload = function(e) {
                var blob = new Blob([e.target.result], { type: file.type || 'audio/mpeg' });
                var url  = mkUrl(blob);
                allDone();

                resultAudioEl.innerHTML =
                    '<p style="background:#fff3cd;color:#856404;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:12px;">' +
                    'âš ï¸ Thiáº¿t bá»‹ iOS nÃ y khÃ´ng giáº£i mÃ£ Ä‘Æ°á»£c codec cá»§a file. File tráº£ vá» lÃ  Báº¢N Gá»C (chÆ°a Ä‘á»•i Ä‘á»‹nh dáº¡ng).<br>' +
                    'Gá»£i Ã½: Chuyá»ƒn file sang <b>MP3 128kbps</b> trÃªn mÃ¡y tÃ­nh trÆ°á»›c, rá»“i thá»­ láº¡i.</p>' +
                    '<h3>ğŸ“„ ' + file.name + ' (gá»‘c)</h3>' +
                    '<audio controls playsinline webkit-playsinline style="width:100%;margin:10px 0">' +
                    '<source src="' + url + '" type="' + (file.type || 'audio/mpeg') + '">' +
                    '</audio><br>' +
                    '<a href="' + url + '" download="' + file.name + '" class="download-btn">â¬‡ï¸ Táº£i vá» báº£n gá»‘c</a>';

                resultSection.classList.add('show');
                showMsg('âš ï¸ Codec khÃ´ng Ä‘Æ°á»£c há»— trá»£ trÃªn thiáº¿t bá»‹ nÃ y. Xem chi tiáº¿t bÃªn dÆ°á»›i.', 'warn');
                progressSection.classList.remove('show');
                setBusy(false);
            };
            rdr.onerror = function() {
                showMsg('âŒ KhÃ´ng thá»ƒ xá»­ lÃ½ file nÃ y trÃªn thiáº¿t bá»‹. HÃ£y thá»­ file MP3 hoáº·c WAV khÃ¡c.', 'error');
                progressSection.classList.remove('show');
                setBusy(false);
            };
            rdr.readAsArrayBuffer(file);
            return; /* setBusy sáº½ gá»i trong callback trÃªn */
        })

        .then(function() {
            setBusy(false);
        });

        }, 200);
    }

})();
</script>
</body>
</html>
